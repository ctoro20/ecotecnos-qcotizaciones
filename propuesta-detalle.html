<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGS - Creación de Propuesta</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="css/cotizacion-detalle.css">
    <style>
        .proposal-card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            padding: 20px;
        }

        .proposal-card h3 {
            font-size: 15px;
            font-weight: 600;
            color: #66615b;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .proposal-form-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 16px;
        }

        .proposal-field {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .proposal-field label {
            font-size: 12px;
            font-weight: 600;
            color: #66615b;
        }

        .proposal-field .form-control {
            background: #f7f7f7;
        }

        .proposal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 20px;
        }

        .proposal-section {
            margin-top: 24px;
        }

        .semaforo {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 8px;
        }

        .semaforo .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .dot.green { background: #6bd098; }
        .dot.yellow { background: #fbc658; }
        .dot.red { background: #ef8157; }

        .repo-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .repo-toolbar.repo-toolbar-tight {
            margin-bottom: 12px;
        }

        .repo-toolbar .repo-views {
            display: flex;
            gap: 0;
        }

        .repo-toolbar .repo-view-btn {
            padding: 7px 14px;
            font-size: 11px;
            font-weight: 600;
            border: 1px solid #e0e0e0;
            background: #fff;
            color: #66615b;
            cursor: pointer;
            transition: all .15s;
        }

        .repo-toolbar .repo-view-btn:first-child {
            border-radius: 4px 0 0 4px;
        }

        .repo-toolbar .repo-view-btn:last-child {
            border-radius: 0 4px 4px 0;
            border-left: 0;
        }

        .repo-toolbar .repo-view-btn.active {
            background: #ef8157;
            color: #fff;
            border-color: #ef8157;
        }

        .repo-view-panel { display: none; }
        .repo-view-panel.active { display: block; }

        .repo-folder-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .repo-folder {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-left: 3px solid #ef8157;
            border-radius: 6px;
            padding: 14px 16px;
            cursor: pointer;
            transition: box-shadow .15s;
        }

        .repo-folder:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .repo-folder-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .repo-folder-header h4 {
            font-size: 12px;
            font-weight: 700;
            color: #66615b;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0;
        }

        .repo-folder-header h4 i {
            color: #ef8157;
        }

        .repo-folder-badge {
            font-size: 10px;
            font-weight: 600;
            background: #f5f5f5;
            color: #9a9a9a;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .repo-folder-items {
            display: grid;
            gap: 4px;
            font-size: 11px;
            color: #9a9a9a;
            margin-bottom: 10px;
        }

        .repo-folder-items span {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .repo-folder-items span i {
            font-size: 10px;
            width: 14px;
            text-align: center;
        }

        .repo-folder-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #f0f0f0;
        }

        .repo-folder-footer a {
            font-size: 11px;
            font-weight: 600;
            color: #ef8157;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            text-decoration: none;
        }

        .repo-folder-footer a:hover {
            color: #d9714a;
        }

        .repo-sub-count {
            font-size: 9px;
            font-weight: 600;
            background: #f0f0f0;
            color: #9a9a9a;
            padding: 1px 6px;
            border-radius: 8px;
            margin-left: auto;
        }

        .repo-sub-count.has-files {
            background: #e8f5e9;
            color: #4caf50;
        }

        .repo-folder-items span {
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 3px;
            transition: background .15s;
        }

        .repo-folder-items span:hover {
            background: #f5f5f5;
        }

        .repo-folder-delete {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            color: #ccc;
            cursor: pointer;
            font-size: 12px;
            padding: 2px 4px;
            transition: color .15s;
        }

        .repo-folder-delete:hover {
            color: #ef5350;
        }

        .repo-folder {
            position: relative;
        }

        .repo-file-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .repo-file-table th,
        .repo-file-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #eee;
            text-align: left;
        }

        .repo-file-table th {
            font-size: 11px;
            font-weight: 700;
            color: #66615b;
            text-transform: uppercase;
            letter-spacing: 0.4px;
        }

        .repo-file-table .file-name {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .repo-file-table .file-name i {
            color: #ef8157;
        }

        .repo-file-table .file-actions {
            display: flex;
            gap: 6px;
        }

        .repo-file-table .file-actions button {
            padding: 4px 8px;
            font-size: 10px;
        }

        .repo-dropzone {
            border: 2px dashed #e0e0e0;
            border-radius: 8px;
            padding: 24px;
            text-align: center;
            color: #9a9a9a;
            font-size: 12px;
            margin-top: 16px;
            transition: border-color .2s, background .2s;
            cursor: pointer;
        }

        .repo-dropzone:hover,
        .repo-dropzone.dragover {
            border-color: #ef8157;
            background: #fef6f3;
        }

        .repo-dropzone i {
            font-size: 24px;
            display: block;
            margin-bottom: 8px;
            color: #ccc;
        }

        .repo-dropzone.dragover i {
            color: #ef8157;
        }

        .repo-filter-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .repo-filter-bar label {
            font-size: 11px;
            font-weight: 600;
            color: #9a9a9a;
        }

        .repo-filter-bar select {
            padding: 6px 10px;
            font-size: 11px;
            border: 1px solid #e8e8e8;
            border-radius: 4px;
            background: #fafafa;
        }

        /* Árbol de carpetas - Vista Archivos */
        .repo-files-layout {
            display: flex;
            gap: 0;
            min-height: 400px;
        }

        .repo-tree-panel {
            width: 240px;
            min-width: 240px;
            border-right: 1px solid #eee;
            padding: 12px 0 12px 0;
            overflow-y: auto;
        }

        .repo-tree-panel .tree-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            font-size: 10px;
            font-weight: 700;
            color: #9a9a9a;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0 14px 10px;
            border-bottom: 1px solid #f0f0f0;
            margin-bottom: 6px;
        }

        .repo-tree-panel .tree-title .tree-title-label {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .repo-tree-panel .tree-title .tree-add-folder {
            color: #b5b0a8;
            cursor: pointer;
            font-size: 11px;
        }

        .repo-tree-panel .tree-title .tree-add-folder:hover {
            color: #ef8157;
        }

        .repo-tree-folder {
            user-select: none;
        }

        .repo-tree-folder-header {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            font-size: 11px;
            font-weight: 600;
            color: #66615b;
            cursor: pointer;
            transition: background .12s;
            position: relative;
        }

        .repo-tree-folder-header:hover {
            background: #f8f8f8;
        }

        .repo-tree-folder-header.active {
            background: #fef6f3;
            color: #ef8157;
        }

        .repo-tree-folder-header i.tree-arrow {
            font-size: 8px;
            width: 12px;
            text-align: center;
            transition: transform .15s;
            color: #bbb;
        }

        .repo-tree-folder-header i.tree-arrow.open {
            transform: rotate(90deg);
        }

        .repo-tree-folder-header i.fa-folder,
        .repo-tree-folder-header i.fa-folder-open {
            color: #ef8157;
            font-size: 12px;
        }

        .repo-tree-folder-header .tree-folder-count {
            margin-left: auto;
            font-size: 9px;
            font-weight: 600;
            background: #f0f0f0;
            color: #9a9a9a;
            padding: 1px 6px;
            border-radius: 8px;
        }

        .repo-tree-actions {
            margin-left: 6px;
            display: inline-flex;
            gap: 6px;
            color: #b5b0a8;
            font-size: 11px;
        }

        .repo-tree-actions i {
            cursor: pointer;
        }

        .repo-tree-actions i:hover {
            color: #ef8157;
        }

        .repo-tree-actions .context-menu,
        .repo-tree-sub .sub-actions .context-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 18px;
            background: #fff;
            border: 1px solid #eee;
            border-radius: 6px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
            z-index: 10;
            min-width: 140px;
        }

        .repo-tree-actions .context-menu button,
        .repo-tree-sub .sub-actions .context-menu button {
            width: 100%;
            border: none;
            background: none;
            padding: 8px 10px;
            text-align: left;
            font-size: 11px;
            color: #66615b;
            cursor: pointer;
        }

        .repo-tree-actions .context-menu button:hover,
        .repo-tree-sub .sub-actions .context-menu button:hover {
            background: #f5f5f5;
        }

        .repo-tree-actions .menu-trigger,
        .repo-tree-sub .sub-actions .menu-trigger {
            position: relative;
        }

        .repo-tree-actions .menu-trigger.active + .context-menu,
        .repo-tree-sub .sub-actions .menu-trigger.active + .context-menu {
            display: block;
        }

        .repo-tree-folder-header .tree-folder-count.has-files {
            background: #e8f5e9;
            color: #4caf50;
        }

        .repo-tree-subs {
            display: none;
            padding-left: 32px;
        }

        .repo-tree-subs.open {
            display: block;
        }

        .repo-tree-sub {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 14px 4px 0;
            font-size: 10px;
            color: #9a9a9a;
            cursor: pointer;
            transition: background .12s, color .12s;
            border-radius: 3px;
            position: relative;
        }

        .repo-tree-sub:hover {
            color: #66615b;
            background: #f8f8f8;
        }

        .repo-tree-sub.active {
            color: #ef8157;
            font-weight: 600;
            background: #fef6f3;
        }

        .repo-tree-sub i {
            font-size: 9px;
            width: 12px;
            text-align: center;
        }

        .repo-tree-sub .tree-sub-count {
            margin-left: auto;
            font-size: 9px;
            background: #f0f0f0;
            color: #bbb;
            padding: 0 5px;
            border-radius: 6px;
        }

        .repo-tree-sub .tree-sub-count.has-files {
            background: #e8f5e9;
            color: #4caf50;
        }

        .repo-tree-sub .sub-actions {
            margin-left: auto;
            display: inline-flex;
            gap: 6px;
            color: #b5b0a8;
            font-size: 10px;
        }

        .repo-tree-sub .sub-actions i {
            cursor: pointer;
        }

        .repo-tree-sub .sub-actions i:hover {
            color: #ef8157;
        }

        .repo-files-panel {
            flex: 1;
            padding: 12px 16px;
            overflow-x: auto;
        }

        .repo-subfolder-list {
            margin-bottom: 12px;
        }

        .repo-subfolder-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .repo-subfolder-table th,
        .repo-subfolder-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #eee;
            text-align: left;
        }

        .repo-subfolder-table th {
            font-size: 11px;
            font-weight: 700;
            color: #66615b;
            text-transform: uppercase;
            letter-spacing: 0.4px;
        }

        .repo-subfolder-row {
            cursor: pointer;
            transition: background .15s;
        }

        .repo-subfolder-row:hover {
            background: #fafafa;
        }

        .repo-subfolder-name {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            color: #66615b;
        }

        .repo-subfolder-name i {
            color: #ef8157;
        }

        .repo-subfolder-count {
            font-size: 10px;
            background: #f0f0f0;
            color: #9a9a9a;
            padding: 2px 6px;
            border-radius: 10px;
            display: inline-flex;
            align-items: center;
        }

        .repo-subfolder-count.has-files {
            background: #e8f5e9;
            color: #4caf50;
        }

        .repo-files-breadcrumb {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: #9a9a9a;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f0f0f0;
        }

        .repo-files-breadcrumb a {
            color: #ef8157;
            cursor: pointer;
            text-decoration: none;
            font-weight: 600;
        }

        .repo-files-breadcrumb i {
            font-size: 9px;
            color: #ccc;
        }

        .repo-files-empty {
            font-size: 12px;
            color: #9a9a9a;
            padding: 10px 0 6px;
        }

        .repo-upload-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 10px 12px;
            border: 1px solid #eee;
            border-radius: 8px;
            background: #faf9f7;
            margin-bottom: 12px;
        }

        .repo-upload-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        @media (max-width: 900px) {
            .repo-folder-grid {
                grid-template-columns: 1fr;
            }
            .repo-files-layout {
                flex-direction: column;
            }
            .repo-tree-panel {
                width: 100%;
                min-width: auto;
                border-right: none;
                border-bottom: 1px solid #eee;
                max-height: 200px;
            }
            .repo-subfolder-list {
                margin-bottom: 10px;
            }
        }

        .tech-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 16px;
        }

        .tech-wiki-layout {
            display: grid;
            grid-template-columns: 280px minmax(0, 1fr);
            gap: 0;
            min-height: 420px;
        }

        .tech-wiki-shell {
            border: 1px solid #eee;
            border-left: 3px solid #ef8157;
            border-radius: 8px;
            background: #fff;
            overflow: hidden;
            --tech-header-height: 44px;
        }


        .form-section-card-orange {
            border-left: 3px solid #ef8157;
            border-radius: 8px;
        }

        .tech-wiki-tree {
            border-right: 1px solid #eee;
            border-radius: 0;
            background: transparent;
            display: grid;
            grid-template-rows: auto 1fr;
            overflow: hidden;
        }

        .tech-tree-header {
            padding: 0 14px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #faf9f7;
            height: var(--tech-header-height);
        }

        .tech-tree-title {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 10px;
            font-weight: 700;
            color: #9a9a9a;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            line-height: 1;
        }

        .tech-tree-title i {
            color: #b5b0a8;
            font-size: 11px;
        }

        .tech-tree-search {
            position: relative;
        }

        .tech-tree-search i {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 11px;
            color: #b5b0a8;
        }

        .tech-tree-search input {
            width: 100%;
            border: 1px solid #e8e8e8;
            border-radius: 8px;
            padding: 7px 10px 7px 28px;
            font-size: 11px;
            background: #fafafa;
        }

        .tech-tree-body {
            padding: 0;
            overflow-y: auto;
        }

        .tech-tree-list {
            display: grid;
        }

        .tech-tree-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            font-size: 11px;
            font-weight: 600;
            color: #66615b;
            cursor: pointer;
            transition: background .12s;
        }

        .tech-tree-item:hover {
            background: #f8f8f8;
        }

        .tech-tree-item.active {
            background: #fef6f3;
            color: #ef8157;
        }

        .tech-tree-item.disabled {
            color: #bdb9b3;
            cursor: default;
        }

        .tech-tree-item i.fa-folder,
        .tech-tree-item i.fa-folder-open {
            color: #ef8157;
            font-size: 12px;
        }

        .tech-tree-toggle {
            margin-left: auto;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 10px;
            color: #9a9a9a;
        }

        .tech-tree-toggle input {
            accent-color: #ef8157;
        }

        .tech-tree-add-btn {
            border: none;
            background: none;
            color: #b5b0a8;
            cursor: pointer;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
        }

        .tech-tree-add-btn:hover {
            color: #ef8157;
        }

        .tech-tree-expand {
            border: none;
            background: none;
            color: #b5b0a8;
            cursor: pointer;
            font-size: 10px;
            width: 18px;
            text-align: center;
        }

        .tech-tree-expand.open i {
            transform: rotate(90deg);
        }

        .tech-tree-name {
            flex: 1;
        }

        .tech-tree-edit {
            border: none;
            background: none;
            color: #b5b0a8;
            cursor: pointer;
            font-size: 11px;
        }

        .tech-tree-edit:hover {
            color: #ef8157;
        }

        .tech-tree-fields {
            padding: 6px 12px 10px 36px;
            display: grid;
            gap: 6px;
            background: #fcfcfc;
            border-bottom: 1px solid #f0f0f0;
        }

        .tech-tree-field {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            color: #7f7b75;
        }

        .tech-tree-item[draggable="true"],
        .tech-tree-field[draggable="true"] {
            cursor: move;
        }

        .tech-drag-over {
            outline: 1px dashed #ef8157;
            outline-offset: -2px;
            background: #fef6f3;
        }

        .tech-tree-field input {
            flex: 1;
            border: 1px solid #e6e6e6;
            border-radius: 6px;
            padding: 6px 8px;
            font-size: 11px;
            background: #fff;
        }

        .tech-tree-field .tech-tree-field-name {
            flex: 1;
        }

        .tech-tree-field .tech-tree-menu-btn {
            font-size: 11px;
        }

        .tech-tree-add-field {
            margin-top: 2px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: #ef8157;
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px 0;
        }

        .tech-tree-add-field i {
            font-size: 10px;
        }

        .tech-tree-menu {
            position: relative;
            margin-left: 6px;
        }

        .tech-tree-menu-btn {
            border: none;
            background: none;
            color: #b5b0a8;
            cursor: pointer;
            font-size: 12px;
        }

        .tech-tree-menu-btn:hover {
            color: #ef8157;
        }

        .tech-tree-menu-content {
            display: none;
            position: absolute;
            right: 0;
            top: 16px;
            background: #fff;
            border: 1px solid #eee;
            border-radius: 6px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
            z-index: 10;
            min-width: 150px;
        }

        .tech-tree-menu-content button {
            width: 100%;
            border: none;
            background: none;
            padding: 8px 10px;
            text-align: left;
            font-size: 11px;
            color: #66615b;
            cursor: pointer;
        }

        .tech-tree-menu-content button:hover {
            background: #f5f5f5;
        }

        .tech-tree-menu.open .tech-tree-menu-content {
            display: block;
        }

        .tech-tree-actions {
            padding: 8px 12px 10px 12px;
            border-top: 1px solid #f0f0f0;
            display: flex;
            justify-content: flex-start;
        }

        .tech-custom-fields {
            display: grid;
            gap: 12px;
        }

        .tech-custom-field {
            display: grid;
            gap: 8px;
        }


        .tech-wiki-editor {
            border: none;
            border-radius: 0;
            background: transparent;
            padding: 0;
            display: grid;
            gap: 0;
            overflow: hidden;
        }

        .tech-editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            padding: 0 14px;
            border-bottom: 1px solid #eee;
            background: #faf9f7;
            height: var(--tech-header-height);
        }

        .tech-editor-breadcrumb {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: #9a9a9a;
            line-height: 1;
        }

        .tech-editor-breadcrumb i {
            font-size: 9px;
            color: #ccc;
        }

        .tech-editor-current {
            color: #ef8157;
            font-weight: 600;
        }


        .tech-editor-status {
            font-size: 11px;
            color: #9a9a9a;
        }

        .tech-editor-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .tech-editor-fields {
            display: grid;
        }

        .tech-editor-row {
            padding: 12px 14px;
            border-bottom: 1px solid #f0f0f0;
            display: grid;
            gap: 8px;
        }

        .tech-editor-row:last-child {
            border-bottom: none;
        }

        .tech-editor-fields label {
            font-size: 10px;
            font-weight: 700;
            color: #9a9a9a;
            text-transform: uppercase;
            letter-spacing: 0.4px;
        }

        .tech-editor-fields .form-control {
            font-size: 12px;
            background: #fff;
            border: 1px solid #e6e6e6;
            border-radius: 6px;
            padding: 8px 10px;
        }

        .tech-editor-hint {
            font-size: 11px;
            color: #b0aca5;
        }

        .tech-doc-view {
            padding: 12px 14px;
            display: grid;
            gap: 12px;
        }

        .tech-doc-title {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            color: #9a9a9a;
        }

        .tech-doc-text {
            font-size: 12px;
            color: #66615b;
            line-height: 1.5;
        }

        .tech-doc-list {
            display: grid;
            gap: 6px;
            font-size: 12px;
            color: #66615b;
        }

        .tech-doc-full {
            display: flex;
            justify-content: center;
            padding: 20px 0;
        }

        .tech-doc-page {
            width: min(820px, 90vw);
            background: #fff;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 28px 32px;
            box-shadow: 0 10px 24px rgba(0,0,0,0.06);
            display: grid;
            gap: 18px;
        }

        .tech-pdf {
            width: min(820px, 90vw);
            background: #fff;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            box-shadow: 0 10px 24px rgba(0,0,0,0.08);
            padding: 28px 32px;
            display: grid;
            gap: 18px;
        }

        .tech-doc-section {
            display: grid;
            gap: 8px;
        }

        .tech-doc-section-title {
            font-size: 12px;
            font-weight: 700;
            color: #66615b;
            border-bottom: 1px solid #eee;
            padding-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.4px;
        }

        .tech-normas-list {
            display: grid;
            gap: 8px;
            margin-top: 6px;
        }

        .tech-norma-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #fafafa;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 8px 10px;
            font-size: 12px;
            color: #66615b;
        }

        .tech-norma-item input {
            width: 14px;
            height: 14px;
            accent-color: #ef8157;
        }

        .tech-norma-add {
            display: flex;
            gap: 8px;
        }

        .tech-normas-selected {
            font-size: 11px;
            color: #9a9a9a;
        }

        .tech-normas-selected-list {
            display: grid;
            gap: 6px;
        }

        .tech-norma-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            border-radius: 8px;
            background: #fafafa;
            border: 1px solid #eee;
            font-size: 12px;
            color: #66615b;
        }

        .tech-norma-row button {
            border: none;
            background: none;
            color: #ef5350;
            cursor: pointer;
            font-size: 12px;
            margin-left: auto;
        }

        .tech-map-upload {
            border: 2px dashed #e0e0e0;
            border-radius: 8px;
            padding: 18px;
            text-align: center;
            color: #9a9a9a;
            font-size: 12px;
            background: #faf9f7;
            cursor: pointer;
            transition: border-color .2s, background .2s;
        }

        .tech-map-upload:hover {
            border-color: #ef8157;
            background: #fef6f3;
        }

        .tech-map-preview {
            display: grid;
            gap: 8px;
            margin-top: 10px;
        }

        .tech-map-actions {
            display: flex;
            justify-content: flex-end;
        }

        .tech-map-actions .btn {
            font-size: 11px;
            padding: 6px 10px;
        }

        .tech-map-preview img {
            width: 100%;
            height: 220px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid #eee;
        }

        .tech-map-meta {
            font-size: 11px;
            color: #9a9a9a;
            text-align: center;
        }

        .tech-map-caption {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 11px;
            color: #9a9a9a;
        }

        .tech-map-caption button {
            border: none;
            background: none;
            color: #b5b0a8;
            cursor: pointer;
            font-size: 11px;
        }

        .tech-map-caption button:hover {
            color: #ef8157;
        }

        .tech-map-caption-input {
            border: none;
            background: transparent;
            border-bottom: 1px dashed #ddd;
            padding: 2px 4px;
            font-size: 11px;
            color: #66615b;
            min-width: 220px;
            outline: none;
        }

        .tech-pro-list {
            display: grid;
            gap: 8px;
        }

        .tech-pro-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            border-radius: 8px;
            background: #fafafa;
            border: 1px solid #eee;
            font-size: 12px;
            color: #66615b;
        }

        .tech-pro-item button {
            border: none;
            background: none;
            color: #ef5350;
            cursor: pointer;
            font-size: 12px;
            margin-left: auto;
        }

        .tech-auth-list {
            display: grid;
            gap: 10px;
        }

        .tech-auth-item {
            padding: 10px 12px;
            border-radius: 8px;
            background: #fafafa;
            border: 1px solid #eee;
            display: grid;
            gap: 6px;
        }

        .tech-auth-title {
            font-size: 12px;
            font-weight: 700;
            color: #66615b;
        }

        .tech-auth-text {
            font-size: 12px;
            color: #66615b;
            line-height: 1.5;
        }

        .tech-auth-actions {
            display: flex;
            justify-content: flex-end;
        }

        .simple-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }

        .simple-modal {
            width: min(680px, 92vw);
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 12px 28px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .simple-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            border-bottom: 1px solid #eee;
        }

        .simple-modal-header h4 {
            font-size: 13px;
            margin: 0;
            color: #66615b;
        }

        .simple-modal-body {
            padding: 14px 16px;
            display: grid;
            gap: 10px;
        }

        .simple-modal-list {
            max-height: 320px;
            overflow-y: auto;
            display: grid;
            gap: 8px;
        }

        .simple-modal-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            border: 1px solid #eee;
            border-radius: 8px;
            background: #fafafa;
            font-size: 12px;
            color: #66615b;
        }

        .simple-modal-item input {
            width: 14px;
            height: 14px;
            accent-color: #ef8157;
        }

        .tech-card {
            border: 1px solid #eee;
            border-radius: 12px;
            padding: 16px;
            background: #fff;
            display: grid;
            gap: 10px;
        }

        .tech-card h4 {
            font-size: 13px;
            font-weight: 700;
            color: #66615b;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tech-list {
            display: grid;
            gap: 6px;
            font-size: 12px;
            color: #66615b;
        }

        .tech-form {
            display: grid;
            gap: 8px;
        }

        .tech-form label {
            font-size: 11px;
            font-weight: 600;
            color: #66615b;
        }

        .tech-form .form-control {
            font-size: 12px;
            background: #f7f7f7;
            border: 1px solid #e6e6e6;
            border-radius: 6px;
            padding: 8px 10px;
        }

        .tech-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .tech-actions .btn {
            padding: 8px 14px;
            font-size: 11px;
        }

        .tech-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            color: #8c8c8c;
        }

        .econ-grid {
            display: grid;
            gap: 16px;
        }

        .econ-card {
            border: 1px solid #eee;
            border-radius: 12px;
            padding: 16px;
            background: #fff;
            display: grid;
            gap: 12px;
        }

        .econ-card h4 {
            font-size: 13px;
            font-weight: 700;
            color: #66615b;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .econ-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .econ-table th,
        .econ-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #eee;
            text-align: left;
        }

        .econ-table th {
            font-size: 11px;
            font-weight: 700;
            color: #66615b;
            text-transform: uppercase;
            letter-spacing: 0.4px;
        }

        .econ-table td input {
            width: 100%;
        }

        .econ-summary {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 12px;
        }

        .econ-summary .summary-box {
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 12px;
            background: #faf9f7;
            font-size: 12px;
            color: #66615b;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .econ-summary .summary-box strong {
            font-size: 13px;
        }

        .econ-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .econ-actions .btn {
            padding: 8px 14px;
            font-size: 11px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 16px;
        }

        .results-card {
            border: 1px solid #eee;
            border-radius: 12px;
            padding: 16px;
            background: #fff;
            display: grid;
            gap: 12px;
        }

        .results-card h4 {
            font-size: 13px;
            font-weight: 700;
            color: #66615b;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .results-form-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 12px;
        }

        .results-note {
            font-size: 11px;
            color: #8c8c8c;
        }

        @media (max-width: 900px) {
            .tech-grid {
                grid-template-columns: 1fr;
            }

            .tech-wiki-layout {
                grid-template-columns: 1fr;
            }

            .econ-summary {
                grid-template-columns: 1fr;
            }

            .results-grid {
                grid-template-columns: 1fr;
            }

            .results-form-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="wrapper">
        <div class="sidebar">
            <div class="logo">
                <div class="logo-container">
                    <div class="logo-top-line"></div>
                    <div class="logo-text">SGS</div>
                </div>
            </div>
            <div class="user">
                <div class="user-name">
                    <i class="fa fa-user"></i>
                    Bienvenido <span id="NombreUsuarioSistema">Cristian Toro</span>
                </div>
                <div class="app-version">V.1.0.0</div>
            </div>

            <ul class="nav">
                <li>
                    <a href="#">
                        <i class="fas fa-home"></i>
                        <span>Inicio</span>
                    </a>
                </li>
                <li>
                    <a href="#">
                        <i class="far fa-square"></i>
                        <span>Tarifario</span>
                    </a>
                </li>
                <li>
                    <a href="cotizaciones-sgs.html">
                        <i class="far fa-circle"></i>
                        <span>Listado Cotizaciones/Propuestas</span>
                    </a>
                </li>
                <li class="active">
                    <a href="propuestas-sgs.html">
                        <i class="fas fa-file-contract"></i>
                        <span>Listado de licitaciones</span>
                    </a>
                </li>
                <li>
                    <a href="#">
                        <i class="fas fa-check"></i>
                        <span>Aprobar cotizaciones</span>
                    </a>
                </li>
                <li>
                    <a href="#">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Salir</span>
                    </a>
                </li>
            </ul>
        </div>

        <div class="main-panel">
            <div class="page-header">
                <div class="page-header-left">
                    <div class="header-icon">
                        <i class="fas fa-file-signature"></i>
                    </div>
                    <h1>Creación propuesta / licitación</h1>
                </div>
                <div class="company-switcher">
                    <label>Empresa:</label>
                    <select id="companySelect" class="company-select">
                        <option value="SGS" selected>SGS</option>
                        <option value="CONEMI">CONEMI</option>
                        <option value="ECOTECNOS">ECOTECNOS</option>
                    </select>
                </div>
            </div>

            <div class="content">
                <div style="margin-bottom: 20px;">
                    <a href="cotizaciones-sgs.html" class="btn btn-default">
                        <i class="fas fa-arrow-left"></i> Volver
                    </a>
                </div>

                <p class="category">Complete los pasos a continuación para registrar la oportunidad y construir la propuesta.</p>

                <div class="card">
                    <div class="stepper">
                        <div class="stepper-item active" data-step="1">
                            <div class="stepper-number">1</div>
                            <div class="stepper-label">Oportunidad</div>
                        </div>
                        <div class="stepper-item" data-step="2">
                            <div class="stepper-number">2</div>
                            <div class="stepper-label">Plazos</div>
                        </div>
                        <div class="stepper-item" data-step="3">
                            <div class="stepper-number">3</div>
                            <div class="stepper-label">Documentos</div>
                        </div>
                        <div class="stepper-item" data-step="4">
                            <div class="stepper-number">4</div>
                            <div class="stepper-label">Técnica</div>
                        </div>
                        <div class="stepper-item" data-step="5">
                            <div class="stepper-number">5</div>
                            <div class="stepper-label">Económica</div>
                        </div>
                        <div class="stepper-item" data-step="6">
                            <div class="stepper-number">6</div>
                            <div class="stepper-label">Aprobaci&oacute;n</div>
                        </div>
                    </div>

                    <!-- PASO 1: Datos Oportunidad -->
                    <div class="step-panel active" id="step1">
                        <h4 class="section-title"><i class="fas fa-file-alt"></i> Datos de la oportunidad</h4>

                        <div class="form-section-card">
                            <div class="form-grid cols-3">
                                <div class="compact-form-group">
                                    <label>Tipo de registro</label>
                                    <select class="form-control" id="TipoRegistro">
                                        <option value="">-- Seleccione --</option>
                                        <option value="propuesta">Propuesta comercial</option>
                                        <option value="licitacion_publica">Licitación pública</option>
                                        <option value="licitacion_privada">Licitación privada</option>
                                    </select>
                                </div>
                                <div class="compact-form-group">
                                    <label>Estado</label>
                                    <select class="form-control" id="EstadoPropuesta">
                                        <option value="">-- Seleccione --</option>
                                        <option value="evaluacion">En evaluación</option>
                                        <option value="desarrollo">En desarrollo</option>
                                        <option value="enviada">Enviada</option>
                                        <option value="ganada">Ganada</option>
                                        <option value="perdida">Perdida</option>
                                    </select>
                                </div>
                                <div class="compact-form-group">
                                    <label>Fuente</label>
                                    <select class="form-control" id="FuenteOportunidad">
                                        <option value="">-- Seleccione --</option>
                                        <option value="portal">Portal de licitaciones</option>
                                        <option value="referidos">Referidos</option>
                                        <option value="contacto_directo">Contacto directo</option>
                                        <option value="otro">Otro</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <h4 class="section-title"><i class="fas fa-building"></i> Cliente y Contacto</h4>

                        <input type="hidden" id="PropuestaClienteId">

                        <!-- Before client selection - show prompts -->
                        <div id="divBuscarClientePropuesta" class="cards-row">
                            <div class="card-column">
                                <div class="client-search-prompt">
                                    <div class="search-prompt-icon">
                                        <i class="fas fa-building"></i>
                                    </div>
                                    <div class="search-prompt-text">
                                        <span>No hay cliente seleccionado</span>
                                        <small>Haga clic en buscar para seleccionar un cliente u organismo</small>
                                    </div>
                                    <button type="button" class="btn btn-success" id="btnBuscarClientePropuesta">
                                        <i class="fas fa-search"></i> Buscar
                                    </button>
                                </div>
                            </div>
                            <div class="card-column">
                                <div class="contact-search-prompt">
                                    <div class="search-prompt-icon">
                                        <i class="fas fa-user-tie"></i>
                                    </div>
                                    <div class="search-prompt-text">
                                        <span>Contacto principal</span>
                                        <small>Seleccione primero un cliente para ver sus contactos</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- After client selection - show cards -->
                        <div id="divDatosClientePropuesta" hidden class="cards-row">
                            <div class="card-column">
                                <div class="client-card">
                                    <div class="client-card-header">
                                        <div class="client-card-title">
                                            <div class="client-card-icon">
                                                <i class="fas fa-building"></i>
                                            </div>
                                            <div>
                                                <div class="client-card-name" id="lblPropuestaNombre"></div>
                                                <div class="client-card-code" id="lblPropuestaCodigo"></div>
                                            </div>
                                        </div>
                                        <div class="client-card-actions">
                                            <button type="button" class="btn-change-client" id="btnCambiarClientePropuesta">
                                                <i class="fas fa-exchange-alt"></i> Cambiar
                                            </button>
                                        </div>
                                    </div>
                                    <div class="client-card-body">
                                        <div class="client-info-chip">
                                            <i class="fas fa-id-card"></i>
                                            <span class="chip-label">Rut:</span>
                                            <span class="chip-value" id="lblPropuestaRut"></span>
                                        </div>
                                        <div class="client-info-chip">
                                            <i class="fas fa-globe-americas"></i>
                                            <span class="chip-label">País:</span>
                                            <span class="chip-value" id="lblPropuestaPais"></span>
                                        </div>
                                        <div class="client-address-selector">
                                            <i class="fas fa-map-marker-alt"></i>
                                            <select id="cbPropuestaDireccion">
                                                <option value="">-- Seleccione dirección --</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-column">
                                <div class="contact-card">
                                    <div class="contact-card-header">
                                        <div class="contact-card-title">
                                            <div class="contact-card-icon">
                                                <i class="fas fa-user-tie"></i>
                                            </div>
                                            <span class="contact-card-label">Contacto principal</span>
                                        </div>
                                        <div class="contact-selector">
                                            <i class="fas fa-user"></i>
                                            <select id="PropuestaContactoId">
                                                <option value="">-- Seleccione contacto --</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="contact-card-body">
                                        <div class="contact-info-item">
                                            <i class="fas fa-phone"></i>
                                            <div>
                                                <span class="info-label">Teléfono</span>
                                                <span class="info-value" id="lblPropuestaTelefono">--</span>
                                            </div>
                                        </div>
                                        <div class="contact-info-item">
                                            <i class="fas fa-briefcase"></i>
                                            <div>
                                                <span class="info-label">Cargo</span>
                                                <span class="info-value" id="lblPropuestaCargo">--</span>
                                            </div>
                                        </div>
                                        <div class="contact-info-item">
                                            <i class="fas fa-envelope"></i>
                                            <div>
                                                <span class="info-label">Email</span>
                                                <span class="info-value" id="lblPropuestaEmail">--</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <h4 class="section-title"><i class="fas fa-clipboard-list"></i> Datos de la Propuesta</h4>

                        <div class="form-section-card">
                            <div class="form-grid">
                                <div class="compact-form-group span-4">
                                    <label>Nombre del proyecto</label>
                                    <input type="text" class="form-control" id="NombreProyecto" placeholder="Proyecto / licitación">
                                </div>
                                <div class="compact-form-group">
                                    <label>Monto estimado</label>
                                    <input type="text" class="form-control" id="MontoEstimado" placeholder="CLP 0">
                                </div>
                                <div class="compact-form-group">
                                    <label>Fecha de detección</label>
                                    <input type="date" class="form-control" id="FechaDeteccion" value="2026-02-08">
                                </div>
                                <div class="compact-form-group">
                                    <label>Responsable comercial</label>
                                    <select class="form-control" id="ResponsableComercial">
                                        <option value="">-- Seleccione --</option>
                                        <option value="abreschi">ANITZA ROXANA BRESCHI</option>
                                        <option value="crojas">CAMILO ADRIAN ROJAS</option>
                                        <option value="cdiaz">CARLOS IGNACIO DÍAZ</option>
                                        <option value="jvillalobos">JOSE JOAQUIN VILLALOBOS</option>
                                        <option value="mampuero">MAURICIO ANDRES AMPUERO</option>
                                        <option value="psaavedra">PABLO FRANCISCO SAAVEDRA</option>
                                        <option value="rvalenzuela">RICARDO VALENZUELA</option>
                                        <option value="vgodoy">VICTOR HUGO GODOY</option>
                                    </select>
                                </div>
                                <div class="compact-form-group span-4">
                                    <label>Asunto / Descripción</label>
                                    <textarea class="form-control" id="AsuntoPropuesta" rows="2" placeholder="Descripción breve de la oportunidad"></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="action-buttons">
                            <div></div>
                            <button type="button" class="btn btn-success js-next-step" data-step="2">
                                Finalizar Paso <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>

                    <div class="step-panel" id="step2">
                        <h4 class="section-title"><i class="fas fa-calendar-alt"></i> Hitos del proceso</h4>

                        <div class="form-section-card">
                            <div class="form-grid cols-3">
                                <div class="compact-form-group">
                                    <label>Fecha publicación bases</label>
                                    <input type="date" class="form-control" id="FechaPublicacion" value="2026-02-10">
                                </div>
                                <div class="compact-form-group">
                                    <label>Fecha límite consultas técnicas</label>
                                    <input type="date" class="form-control" id="FechaLimiteConsultas" value="2026-02-18">
                                </div>
                                <div class="compact-form-group">
                                    <label>Fecha respuesta a consultas</label>
                                    <input type="date" class="form-control" id="FechaRespuestaConsultas" value="2026-02-22">
                                </div>
                                <div class="compact-form-group">
                                    <label>Fecha visita terreno (si aplica)</label>
                                    <input type="date" class="form-control" id="FechaVisitaTerreno">
                                </div>
                                <div class="compact-form-group">
                                    <label>Fecha límite entrega propuesta</label>
                                    <input type="date" class="form-control" id="FechaLimiteEntrega" value="2026-03-01">
                                </div>
                                <div class="compact-form-group">
                                    <label>Fecha apertura técnica</label>
                                    <input type="date" class="form-control" id="FechaAperturaTecnica" value="2026-03-03">
                                </div>
                                <div class="compact-form-group">
                                    <label>Fecha apertura económica</label>
                                    <input type="date" class="form-control" id="FechaAperturaEconomica" value="2026-03-05">
                                </div>
                                <div class="compact-form-group">
                                    <label>Fecha adjudicación</label>
                                    <input type="date" class="form-control" id="FechaAdjudicacion" value="2026-03-12">
                                </div>
                                <div class="compact-form-group">
                                    <label>Fecha firma contrato</label>
                                    <input type="date" class="form-control" id="FechaFirmaContrato" value="2026-03-20">
                                </div>
                            </div>
                        </div>

                        <h4 class="section-title"><i class="fas fa-bell"></i> Alertas y semáforo</h4>

                        <div class="cards-row">
                            <div class="card-column">
                                <div class="form-section-card" style="height:100%;">
                                    <div class="form-grid cols-1">
                                        <div class="compact-form-group">
                                            <label style="font-size:12px; font-weight:700; color:#66615b; text-transform:uppercase; letter-spacing:0.4px; margin-bottom:8px;">Alertas automáticas</label>
                                            <label><input type="checkbox" checked> 30 días antes de cada hito</label>
                                            <label><input type="checkbox" checked> 14 días antes de cada hito</label>
                                            <label><input type="checkbox"> 7 días antes de cada hito</label>
                                            <label><input type="checkbox"> 3 días antes de cada hito</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-column">
                                <div class="form-section-card" style="height:100%;">
                                    <div class="form-grid cols-1">
                                        <div class="compact-form-group">
                                            <label style="font-size:12px; font-weight:700; color:#66615b; text-transform:uppercase; letter-spacing:0.4px; margin-bottom:8px;">Semáforo de tiempos</label>
                                            <div class="semaforo">
                                                <span class="dot green"></span>
                                                45+ días a entrega
                                            </div>
                                            <div class="semaforo">
                                                <span class="dot yellow"></span>
                                                15 - 44 días a entrega
                                            </div>
                                            <div class="semaforo">
                                                <span class="dot red"></span>
                                                Menos de 15 días
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="action-buttons">
                            <button class="btn btn-default js-prev-step" data-step="1">
                                <i class="fas fa-arrow-left"></i> Volver
                            </button>
                            <button type="button" class="btn btn-success js-next-step" data-step="3">
                                Finalizar Paso <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>

                    <div class="step-panel" id="step3">
                        <h4 class="section-title"><i class="fas fa-folder-open"></i> Repositorio documental</h4>

                        <div class="repo-toolbar repo-toolbar-tight">
                            <div class="repo-views">
                                <button class="repo-view-btn" onclick="switchRepoView('folders')">
                                    <i class="fas fa-th-large"></i> Carpetas
                                </button>
                                <button class="repo-view-btn active" onclick="switchRepoView('files')">
                                    <i class="fas fa-sitemap"></i> Árbol de repositorio
                                </button>
                            </div>
                        </div>

                        <!-- Vista Carpetas -->
                        <div class="repo-view-panel" id="repoViewFolders">
                            <div class="repo-folder-grid" id="repoFolderGrid">

                                <!-- Bases y Anexos -->
                                <div class="repo-folder" data-folder-id="bases">
                                    <div class="repo-folder-header">
                                        <h4><i class="fas fa-folder"></i> Bases y Anexos</h4>
                                        <span class="repo-folder-badge" data-folder="bases">2 archivos</span>
                                    </div>
                                    <div class="repo-folder-items">
                                        <span data-sub="bases-tecnicas" onclick="switchRepoView('files','bases','bases-tecnicas')"><i class="fas fa-file-alt"></i> Bases t&eacute;cnicas <span class="repo-sub-count" data-sub-count="bases-tecnicas">1</span></span>
                                        <span data-sub="bases-admin" onclick="switchRepoView('files','bases','bases-admin')"><i class="fas fa-file-alt"></i> Bases administrativas <span class="repo-sub-count" data-sub-count="bases-admin">0</span></span>
                                        <span data-sub="anexos-tecnicos" onclick="switchRepoView('files','bases','anexos-tecnicos')"><i class="fas fa-paperclip"></i> Anexos t&eacute;cnicos <span class="repo-sub-count" data-sub-count="anexos-tecnicos">1</span></span>
                                        <span data-sub="planos" onclick="switchRepoView('files','bases','planos')"><i class="fas fa-drafting-compass"></i> Planos / especificaciones <span class="repo-sub-count" data-sub-count="planos">0</span></span>
                                    </div>
                                    <div class="repo-folder-footer">
                                        <a onclick="triggerUpload('bases')"><i class="fas fa-upload"></i> Subir archivo</a>
                                        <a onclick="switchRepoView('files','bases')"><i class="fas fa-arrow-right"></i> Ver archivos</a>
                                    </div>
                                    <input type="file" class="repo-folder-input" data-folder="bases" hidden multiple onchange="handleRepoUpload(this)">
                                </div>

                                <!-- Consultas y Aclaraciones -->
                                <div class="repo-folder" data-folder-id="consultas">
                                    <div class="repo-folder-header">
                                        <h4><i class="fas fa-folder"></i> Consultas y Aclaraciones</h4>
                                        <span class="repo-folder-badge" data-folder="consultas">1 archivo</span>
                                    </div>
                                    <div class="repo-folder-items">
                                        <span data-sub="consultas-enviadas" onclick="switchRepoView('files','consultas','consultas-enviadas')"><i class="fas fa-paper-plane"></i> Consultas enviadas <span class="repo-sub-count" data-sub-count="consultas-enviadas">1</span></span>
                                        <span data-sub="respuestas" onclick="switchRepoView('files','consultas','respuestas')"><i class="fas fa-reply"></i> Respuestas oficiales <span class="repo-sub-count" data-sub-count="respuestas">0</span></span>
                                    </div>
                                    <div class="repo-folder-footer">
                                        <a onclick="triggerUpload('consultas')"><i class="fas fa-upload"></i> Subir archivo</a>
                                        <a onclick="switchRepoView('files','consultas')"><i class="fas fa-arrow-right"></i> Ver archivos</a>
                                    </div>
                                    <input type="file" class="repo-folder-input" data-folder="consultas" hidden multiple onchange="handleRepoUpload(this)">
                                </div>

                                <!-- Desarrollo Técnico -->
                                <div class="repo-folder" data-folder-id="tecnico">
                                    <div class="repo-folder-header">
                                        <h4><i class="fas fa-folder"></i> Desarrollo T&eacute;cnico</h4>
                                        <span class="repo-folder-badge" data-folder="tecnico">1 archivo</span>
                                    </div>
                                    <div class="repo-folder-items">
                                        <span data-sub="metodologia" onclick="switchRepoView('files','tecnico','metodologia')"><i class="fas fa-cogs"></i> Metodolog&iacute;a propuesta <span class="repo-sub-count" data-sub-count="metodologia">1</span></span>
                                        <span data-sub="plan-muestreo" onclick="switchRepoView('files','tecnico','plan-muestreo')"><i class="fas fa-vial"></i> Plan de muestreo <span class="repo-sub-count" data-sub-count="plan-muestreo">0</span></span>
                                        <span data-sub="protocolos" onclick="switchRepoView('files','tecnico','protocolos')"><i class="fas fa-flask"></i> Protocolos anal&iacute;ticos <span class="repo-sub-count" data-sub-count="protocolos">0</span></span>
                                        <span data-sub="certificaciones" onclick="switchRepoView('files','tecnico','certificaciones')"><i class="fas fa-certificate"></i> Certificaciones / acreditaciones <span class="repo-sub-count" data-sub-count="certificaciones">0</span></span>
                                    </div>
                                    <div class="repo-folder-footer">
                                        <a onclick="triggerUpload('tecnico')"><i class="fas fa-upload"></i> Subir archivo</a>
                                        <a onclick="switchRepoView('files','tecnico')"><i class="fas fa-arrow-right"></i> Ver archivos</a>
                                    </div>
                                    <input type="file" class="repo-folder-input" data-folder="tecnico" hidden multiple onchange="handleRepoUpload(this)">
                                </div>

                                <!-- Desarrollo Económico -->
                                <div class="repo-folder" data-folder-id="economico">
                                    <div class="repo-folder-header">
                                        <h4><i class="fas fa-folder"></i> Desarrollo Econ&oacute;mico</h4>
                                        <span class="repo-folder-badge" data-folder="economico">1 archivo</span>
                                    </div>
                                    <div class="repo-folder-items">
                                        <span data-sub="planilla-costos" onclick="switchRepoView('files','economico','planilla-costos')"><i class="fas fa-table"></i> Planilla de costos <span class="repo-sub-count" data-sub-count="planilla-costos">1</span></span>
                                        <span data-sub="precios-unitarios" onclick="switchRepoView('files','economico','precios-unitarios')"><i class="fas fa-calculator"></i> An&aacute;lisis de precios unitarios <span class="repo-sub-count" data-sub-count="precios-unitarios">0</span></span>
                                        <span data-sub="respaldos-cot" onclick="switchRepoView('files','economico','respaldos-cot')"><i class="fas fa-receipt"></i> Respaldos cotizaciones <span class="repo-sub-count" data-sub-count="respaldos-cot">0</span></span>
                                    </div>
                                    <div class="repo-folder-footer">
                                        <a onclick="triggerUpload('economico')"><i class="fas fa-upload"></i> Subir archivo</a>
                                        <a onclick="switchRepoView('files','economico')"><i class="fas fa-arrow-right"></i> Ver archivos</a>
                                    </div>
                                    <input type="file" class="repo-folder-input" data-folder="economico" hidden multiple onchange="handleRepoUpload(this)">
                                </div>

                                <!-- Docs Administrativos -->
                                <div class="repo-folder" data-folder-id="admin">
                                    <div class="repo-folder-header">
                                        <h4><i class="fas fa-folder"></i> Docs Administrativos</h4>
                                        <span class="repo-folder-badge" data-folder="admin">1 archivo</span>
                                    </div>
                                    <div class="repo-folder-items">
                                        <span data-sub="antecedentes-legales" onclick="switchRepoView('files','admin','antecedentes-legales')"><i class="fas fa-balance-scale"></i> Antecedentes legales <span class="repo-sub-count" data-sub-count="antecedentes-legales">0</span></span>
                                        <span data-sub="declaraciones" onclick="switchRepoView('files','admin','declaraciones')"><i class="fas fa-pen-nib"></i> Declaraciones juradas <span class="repo-sub-count" data-sub-count="declaraciones">1</span></span>
                                        <span data-sub="garantias" onclick="switchRepoView('files','admin','garantias')"><i class="fas fa-shield-alt"></i> Garant&iacute;as <span class="repo-sub-count" data-sub-count="garantias">0</span></span>
                                        <span data-sub="poderes" onclick="switchRepoView('files','admin','poderes')"><i class="fas fa-file-signature"></i> Poderes / mandatos <span class="repo-sub-count" data-sub-count="poderes">0</span></span>
                                    </div>
                                    <div class="repo-folder-footer">
                                        <a onclick="triggerUpload('admin')"><i class="fas fa-upload"></i> Subir archivo</a>
                                        <a onclick="switchRepoView('files','admin')"><i class="fas fa-arrow-right"></i> Ver archivos</a>
                                    </div>
                                    <input type="file" class="repo-folder-input" data-folder="admin" hidden multiple onchange="handleRepoUpload(this)">
                                </div>

                                <!-- Propuesta Final -->
                                <div class="repo-folder" data-folder-id="final">
                                    <div class="repo-folder-header">
                                        <h4><i class="fas fa-folder"></i> Propuesta Final</h4>
                                        <span class="repo-folder-badge" data-folder="final">0 archivos</span>
                                    </div>
                                    <div class="repo-folder-items">
                                        <span data-sub="prop-tecnica" onclick="switchRepoView('files','final','prop-tecnica')"><i class="fas fa-file-pdf"></i> Propuesta t&eacute;cnica (PDF) <span class="repo-sub-count" data-sub-count="prop-tecnica">0</span></span>
                                        <span data-sub="prop-economica" onclick="switchRepoView('files','final','prop-economica')"><i class="fas fa-file-pdf"></i> Propuesta econ&oacute;mica (PDF) <span class="repo-sub-count" data-sub-count="prop-economica">0</span></span>
                                        <span data-sub="comprobante-envio" onclick="switchRepoView('files','final','comprobante-envio')"><i class="fas fa-check-circle"></i> Comprobante de env&iacute;o <span class="repo-sub-count" data-sub-count="comprobante-envio">0</span></span>
                                    </div>
                                    <div class="repo-folder-footer">
                                        <a onclick="triggerUpload('final')"><i class="fas fa-upload"></i> Subir archivo</a>
                                        <a onclick="switchRepoView('files','final')"><i class="fas fa-arrow-right"></i> Ver archivos</a>
                                    </div>
                                    <input type="file" class="repo-folder-input" data-folder="final" hidden multiple onchange="handleRepoUpload(this)">
                                </div>

                            </div>
                        </div>

                        <!-- Vista Archivos con árbol lateral -->
                        <div class="repo-view-panel active" id="repoViewFiles">
                            <div class="form-section-card form-section-card-orange" style="padding:0; overflow:hidden;">
                                <div class="repo-files-layout">
                                    <!-- Árbol de carpetas -->
                                    <div class="repo-tree-panel" id="repoTreePanel">
                                        <div class="tree-title">
                                            <span class="tree-title-label"><i class="fas fa-sitemap"></i> Repositorio</span>
                                        </div>

                                        <div class="repo-tree-folder" data-tree-folder="all">
                                            <div class="repo-tree-folder-header active" onclick="treeSelectFolder('','')">
                                                <i class="fas fa-folder-open"></i>
                                                <span>Repositorio</span>
                                                <span class="tree-folder-count has-files" id="treeCountAll">6</span>
                                                <span class="repo-tree-actions">
                                                    <i class="fas fa-folder-plus" title="Agregar carpeta" onclick="event.stopPropagation(); crearNuevaCarpeta()"></i>
                                                </span>
                                            </div>
                                        </div>

                                        <div class="repo-tree-folder" data-tree-folder="bases">
                                            <div class="repo-tree-folder-header" onclick="treeToggleFolder(this, 'bases')">
                                                <i class="fas fa-caret-right tree-arrow"></i>
                                                <i class="fas fa-folder"></i>
                                                <span>Bases y Anexos</span>
                                                <span class="tree-folder-count has-files" data-tree-count="bases">2</span>
                                                <span class="repo-tree-actions">
                                                    <i class="fas fa-folder-plus" title="Agregar subcarpeta" onclick="event.stopPropagation(); agregarSubcarpeta('bases')"></i>
                                                </span>
                                            </div>
                                            <div class="repo-tree-subs" data-tree-subs="bases">
                                                <div class="repo-tree-sub" data-tree-sub="bases-tecnicas" onclick="treeSelectFolder('bases','bases-tecnicas')">
                                                    <i class="fas fa-file-alt"></i> Bases t&eacute;cnicas
                                                    <span class="tree-sub-count has-files" data-tree-subcount="bases-tecnicas">1</span>
                                                </div>
                                                <div class="repo-tree-sub" data-tree-sub="bases-admin" onclick="treeSelectFolder('bases','bases-admin')">
                                                    <i class="fas fa-file-alt"></i> Bases administrativas
                                                    <span class="tree-sub-count" data-tree-subcount="bases-admin">0</span>
                                                </div>
                                                <div class="repo-tree-sub" data-tree-sub="anexos-tecnicos" onclick="treeSelectFolder('bases','anexos-tecnicos')">
                                                    <i class="fas fa-paperclip"></i> Anexos t&eacute;cnicos
                                                    <span class="tree-sub-count has-files" data-tree-subcount="anexos-tecnicos">1</span>
                                                </div>
                                                <div class="repo-tree-sub" data-tree-sub="planos" onclick="treeSelectFolder('bases','planos')">
                                                    <i class="fas fa-drafting-compass"></i> Planos / especificaciones
                                                    <span class="tree-sub-count" data-tree-subcount="planos">0</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="repo-tree-folder" data-tree-folder="consultas">
                                            <div class="repo-tree-folder-header" onclick="treeToggleFolder(this, 'consultas')">
                                                <i class="fas fa-caret-right tree-arrow"></i>
                                                <i class="fas fa-folder"></i>
                                                <span>Consultas y Aclaraciones</span>
                                                <span class="tree-folder-count has-files" data-tree-count="consultas">1</span>
                                                <span class="repo-tree-actions">
                                                    <i class="fas fa-folder-plus" title="Agregar subcarpeta" onclick="event.stopPropagation(); agregarSubcarpeta('consultas')"></i>
                                                </span>
                                            </div>
                                            <div class="repo-tree-subs" data-tree-subs="consultas">
                                                <div class="repo-tree-sub" data-tree-sub="consultas-enviadas" onclick="treeSelectFolder('consultas','consultas-enviadas')">
                                                    <i class="fas fa-paper-plane"></i> Consultas enviadas
                                                    <span class="tree-sub-count has-files" data-tree-subcount="consultas-enviadas">1</span>
                                                </div>
                                                <div class="repo-tree-sub" data-tree-sub="respuestas" onclick="treeSelectFolder('consultas','respuestas')">
                                                    <i class="fas fa-reply"></i> Respuestas oficiales
                                                    <span class="tree-sub-count" data-tree-subcount="respuestas">0</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="repo-tree-folder" data-tree-folder="tecnico">
                                            <div class="repo-tree-folder-header" onclick="treeToggleFolder(this, 'tecnico')">
                                                <i class="fas fa-caret-right tree-arrow"></i>
                                                <i class="fas fa-folder"></i>
                                                <span>Desarrollo T&eacute;cnico</span>
                                                <span class="tree-folder-count has-files" data-tree-count="tecnico">1</span>
                                                <span class="repo-tree-actions">
                                                    <i class="fas fa-folder-plus" title="Agregar subcarpeta" onclick="event.stopPropagation(); agregarSubcarpeta('tecnico')"></i>
                                                </span>
                                            </div>
                                            <div class="repo-tree-subs" data-tree-subs="tecnico">
                                                <div class="repo-tree-sub" data-tree-sub="metodologia" onclick="treeSelectFolder('tecnico','metodologia')">
                                                    <i class="fas fa-cogs"></i> Metodolog&iacute;a propuesta
                                                    <span class="tree-sub-count has-files" data-tree-subcount="metodologia">1</span>
                                                </div>
                                                <div class="repo-tree-sub" data-tree-sub="plan-muestreo" onclick="treeSelectFolder('tecnico','plan-muestreo')">
                                                    <i class="fas fa-vial"></i> Plan de muestreo
                                                    <span class="tree-sub-count" data-tree-subcount="plan-muestreo">0</span>
                                                </div>
                                                <div class="repo-tree-sub" data-tree-sub="protocolos" onclick="treeSelectFolder('tecnico','protocolos')">
                                                    <i class="fas fa-flask"></i> Protocolos anal&iacute;ticos
                                                    <span class="tree-sub-count" data-tree-subcount="protocolos">0</span>
                                                </div>
                                                <div class="repo-tree-sub" data-tree-sub="certificaciones" onclick="treeSelectFolder('tecnico','certificaciones')">
                                                    <i class="fas fa-certificate"></i> Certificaciones
                                                    <span class="tree-sub-count" data-tree-subcount="certificaciones">0</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="repo-tree-folder" data-tree-folder="economico">
                                            <div class="repo-tree-folder-header" onclick="treeToggleFolder(this, 'economico')">
                                                <i class="fas fa-caret-right tree-arrow"></i>
                                                <i class="fas fa-folder"></i>
                                                <span>Desarrollo Econ&oacute;mico</span>
                                                <span class="tree-folder-count has-files" data-tree-count="economico">1</span>
                                                <span class="repo-tree-actions">
                                                    <i class="fas fa-folder-plus" title="Agregar subcarpeta" onclick="event.stopPropagation(); agregarSubcarpeta('economico')"></i>
                                                </span>
                                            </div>
                                            <div class="repo-tree-subs" data-tree-subs="economico">
                                                <div class="repo-tree-sub" data-tree-sub="planilla-costos" onclick="treeSelectFolder('economico','planilla-costos')">
                                                    <i class="fas fa-table"></i> Planilla de costos
                                                    <span class="tree-sub-count has-files" data-tree-subcount="planilla-costos">1</span>
                                                </div>
                                                <div class="repo-tree-sub" data-tree-sub="precios-unitarios" onclick="treeSelectFolder('economico','precios-unitarios')">
                                                    <i class="fas fa-calculator"></i> Precios unitarios
                                                    <span class="tree-sub-count" data-tree-subcount="precios-unitarios">0</span>
                                                </div>
                                                <div class="repo-tree-sub" data-tree-sub="respaldos-cot" onclick="treeSelectFolder('economico','respaldos-cot')">
                                                    <i class="fas fa-receipt"></i> Respaldos cotizaciones
                                                    <span class="tree-sub-count" data-tree-subcount="respaldos-cot">0</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="repo-tree-folder" data-tree-folder="admin">
                                            <div class="repo-tree-folder-header" onclick="treeToggleFolder(this, 'admin')">
                                                <i class="fas fa-caret-right tree-arrow"></i>
                                                <i class="fas fa-folder"></i>
                                                <span>Docs Administrativos</span>
                                                <span class="tree-folder-count has-files" data-tree-count="admin">1</span>
                                                <span class="repo-tree-actions">
                                                    <i class="fas fa-folder-plus" title="Agregar subcarpeta" onclick="event.stopPropagation(); agregarSubcarpeta('admin')"></i>
                                                </span>
                                            </div>
                                            <div class="repo-tree-subs" data-tree-subs="admin">
                                                <div class="repo-tree-sub" data-tree-sub="antecedentes-legales" onclick="treeSelectFolder('admin','antecedentes-legales')">
                                                    <i class="fas fa-balance-scale"></i> Antecedentes legales
                                                    <span class="tree-sub-count" data-tree-subcount="antecedentes-legales">0</span>
                                                </div>
                                                <div class="repo-tree-sub" data-tree-sub="declaraciones" onclick="treeSelectFolder('admin','declaraciones')">
                                                    <i class="fas fa-pen-nib"></i> Declaraciones juradas
                                                    <span class="tree-sub-count has-files" data-tree-subcount="declaraciones">1</span>
                                                </div>
                                                <div class="repo-tree-sub" data-tree-sub="garantias" onclick="treeSelectFolder('admin','garantias')">
                                                    <i class="fas fa-shield-alt"></i> Garant&iacute;as
                                                    <span class="tree-sub-count" data-tree-subcount="garantias">0</span>
                                                </div>
                                                <div class="repo-tree-sub" data-tree-sub="poderes" onclick="treeSelectFolder('admin','poderes')">
                                                    <i class="fas fa-file-signature"></i> Poderes / mandatos
                                                    <span class="tree-sub-count" data-tree-subcount="poderes">0</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="repo-tree-folder" data-tree-folder="final">
                                            <div class="repo-tree-folder-header" onclick="treeToggleFolder(this, 'final')">
                                                <i class="fas fa-caret-right tree-arrow"></i>
                                                <i class="fas fa-folder"></i>
                                                <span>Propuesta Final</span>
                                                <span class="tree-folder-count" data-tree-count="final">0</span>
                                                <span class="repo-tree-actions">
                                                    <i class="fas fa-folder-plus" title="Agregar subcarpeta" onclick="event.stopPropagation(); agregarSubcarpeta('final')"></i>
                                                </span>
                                            </div>
                                            <div class="repo-tree-subs" data-tree-subs="final">
                                                <div class="repo-tree-sub" data-tree-sub="prop-tecnica" onclick="treeSelectFolder('final','prop-tecnica')">
                                                    <i class="fas fa-file-pdf"></i> Prop. t&eacute;cnica
                                                    <span class="tree-sub-count" data-tree-subcount="prop-tecnica">0</span>
                                                </div>
                                                <div class="repo-tree-sub" data-tree-sub="prop-economica" onclick="treeSelectFolder('final','prop-economica')">
                                                    <i class="fas fa-file-pdf"></i> Prop. econ&oacute;mica
                                                    <span class="tree-sub-count" data-tree-subcount="prop-economica">0</span>
                                                </div>
                                                <div class="repo-tree-sub" data-tree-sub="comprobante-envio" onclick="treeSelectFolder('final','comprobante-envio')">
                                                    <i class="fas fa-check-circle"></i> Comprobante env&iacute;o
                                                    <span class="tree-sub-count" data-tree-subcount="comprobante-envio">0</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Panel de archivos -->
                                    <div class="repo-files-panel">
                                        <div class="repo-files-breadcrumb" id="repoBreadcrumb">
                                            <a onclick="treeSelectFolder('','')">Repositorio</a>
                                            <span id="repoBreadcrumbFolder"></span>
                                            <span id="repoBreadcrumbSub"></span>
                                        </div>

                                        <div class="repo-subfolder-list" id="repoSubfolderList" hidden></div>

                                        <div class="repo-files-empty" id="repoFilesEmpty" hidden>
                                            Selecciona una subcarpeta para ver sus archivos.
                                        </div>
                                        <div class="table-responsive" id="repoFilesTable">
                                            <table class="repo-file-table">
                                                <thead>
                                                    <tr>
                                                        <th style="width:30px;">#</th>
                                                        <th>Archivo</th>
                                                        <th style="width:140px;">Sub-tipo</th>
                                                        <th style="width:90px;">Fecha</th>
                                                        <th style="width:70px;">Tama&ntilde;o</th>
                                                        <th style="width:90px;">Acciones</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="repoFilesBody">
                                                    <tr data-folder="bases" data-sub="bases-tecnicas">
                                                        <td>1</td>
                                                        <td><span class="file-name"><i class="fas fa-file-pdf"></i> Bases_Tecnicas_2026.pdf</span></td>
                                                        <td>Bases t&eacute;cnicas</td>
                                                        <td>08/02/2026</td>
                                                        <td>2.4 MB</td>
                                                        <td><div class="file-actions">
                                                            <button class="btn btn-default btn-sm"><i class="fas fa-download"></i></button>
                                                            <button class="btn btn-danger btn-sm" onclick="deleteRepoFile(this)"><i class="fas fa-trash"></i></button>
                                                        </div></td>
                                                    </tr>
                                                    <tr data-folder="bases" data-sub="anexos-tecnicos">
                                                        <td>2</td>
                                                        <td><span class="file-name"><i class="fas fa-file-pdf"></i> Anexos_Tecnicos_v1.pdf</span></td>
                                                        <td>Anexos t&eacute;cnicos</td>
                                                        <td>08/02/2026</td>
                                                        <td>1.1 MB</td>
                                                        <td><div class="file-actions">
                                                            <button class="btn btn-default btn-sm"><i class="fas fa-download"></i></button>
                                                            <button class="btn btn-danger btn-sm" onclick="deleteRepoFile(this)"><i class="fas fa-trash"></i></button>
                                                        </div></td>
                                                    </tr>
                                                    <tr data-folder="consultas" data-sub="consultas-enviadas">
                                                        <td>3</td>
                                                        <td><span class="file-name"><i class="fas fa-file-word"></i> Consulta_Tecnica_01.docx</span></td>
                                                        <td>Consultas enviadas</td>
                                                        <td>10/02/2026</td>
                                                        <td>340 KB</td>
                                                        <td><div class="file-actions">
                                                            <button class="btn btn-default btn-sm"><i class="fas fa-download"></i></button>
                                                            <button class="btn btn-danger btn-sm" onclick="deleteRepoFile(this)"><i class="fas fa-trash"></i></button>
                                                        </div></td>
                                                    </tr>
                                                    <tr data-folder="tecnico" data-sub="metodologia">
                                                        <td>4</td>
                                                        <td><span class="file-name"><i class="fas fa-file-pdf"></i> Metodologia_Propuesta.pdf</span></td>
                                                        <td>Metodolog&iacute;a propuesta</td>
                                                        <td>12/02/2026</td>
                                                        <td>890 KB</td>
                                                        <td><div class="file-actions">
                                                            <button class="btn btn-default btn-sm"><i class="fas fa-download"></i></button>
                                                            <button class="btn btn-danger btn-sm" onclick="deleteRepoFile(this)"><i class="fas fa-trash"></i></button>
                                                        </div></td>
                                                    </tr>
                                                    <tr data-folder="economico" data-sub="planilla-costos">
                                                        <td>5</td>
                                                        <td><span class="file-name"><i class="fas fa-file-excel"></i> Planilla_Costos.xlsx</span></td>
                                                        <td>Planilla de costos</td>
                                                        <td>14/02/2026</td>
                                                        <td>520 KB</td>
                                                        <td><div class="file-actions">
                                                            <button class="btn btn-default btn-sm"><i class="fas fa-download"></i></button>
                                                            <button class="btn btn-danger btn-sm" onclick="deleteRepoFile(this)"><i class="fas fa-trash"></i></button>
                                                        </div></td>
                                                    </tr>
                                                    <tr data-folder="admin" data-sub="declaraciones">
                                                        <td>6</td>
                                                        <td><span class="file-name"><i class="fas fa-file-pdf"></i> Declaracion_Jurada.pdf</span></td>
                                                        <td>Declaraciones juradas</td>
                                                        <td>15/02/2026</td>
                                                        <td>180 KB</td>
                                                        <td><div class="file-actions">
                                                            <button class="btn btn-default btn-sm"><i class="fas fa-download"></i></button>
                                                            <button class="btn btn-danger btn-sm" onclick="deleteRepoFile(this)"><i class="fas fa-trash"></i></button>
                                                        </div></td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>

                                        <div class="repo-dropzone" id="repoDropzone" onclick="triggerUpload(currentUploadFolder)">
                                            <i class="fas fa-cloud-upload-alt"></i>
                                            Arrastra archivos aqui o haz clic para cargar desde tu equipo
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="action-buttons">
                            <button class="btn btn-default js-prev-step" data-step="2">
                                <i class="fas fa-arrow-left"></i> Volver
                            </button>
                            <button type="button" class="btn btn-success js-next-step" data-step="4">
                                Finalizar Paso <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>

                <div class="step-panel" id="step4">

                        <h4 class="section-title"><i class="fas fa-folder-open"></i> Propuesta técnica</h4>
                        <div class="repo-toolbar repo-toolbar-tight">
                            <div class="repo-views">
                                <button class="repo-view-btn active" id="techViewEditBtn"><i class="fas fa-edit"></i> Edición</button>
                                <button class="repo-view-btn" id="techViewDocBtn"><i class="fas fa-file-alt"></i> Documento</button>
                            </div>
                        </div>
                          <div class="tech-wiki-shell" id="techEditShell">
                              <div class="tech-wiki-layout">
                                  <div class="tech-wiki-tree">
                                      <div class="tech-tree-header">
                                          <div class="tech-tree-title">
                                              <i class="fas fa-sitemap"></i>
                                              <span>Secciones técnicas</span>
                                          </div>
                                          <button class="tech-tree-add-btn" id="techAddTopicBtn" title="Nueva sección"><i class="fas fa-plus"></i></button>
                                      </div>
                                      <div class="tech-tree-body" id="techWikiTree"></div>
                                  </div>
                                  <div class="tech-wiki-editor">
                                      <div class="tech-editor-header">
                                          <div class="tech-editor-breadcrumb">
                                              <span class="tech-editor-root">Propuesta técnica</span>
                                              <i class="fas fa-chevron-right"></i>
                                              <span class="tech-editor-current" id="techEditorTitle">Selecciona una sección</span>
                                          </div>
                                          <div class="tech-editor-status" id="techEditorStatus">Sin cambios</div>
                                      </div>
                                      <div class="tech-editor-fields">
                                      <div id="techViewEdit">
                                      <div id="techEditorDefaultFields">
                                          <div class="tech-editor-row">
                                              <label>Resumen</label>
                                              <textarea class="form-control" rows="3" id="techEditorSummary" placeholder="Resumen corto de la sección"></textarea>
                                          </div>
                                          <div class="tech-editor-row">
                                              <label>Contenido</label>
                                              <textarea class="form-control" rows="8" id="techEditorContent" placeholder="Redacta el contenido técnico aquí"></textarea>
                                          </div>
                                          <div class="tech-editor-row">
                                              <label>Notas internas</label>
                                              <textarea class="form-control" rows="3" id="techEditorNotes" placeholder="Notas internas para el equipo"></textarea>
                                          </div>
                                      </div>
                                      <div id="techEditorObjetivosFields" style="display:none;">
                                          <div class="tech-editor-row">
                                              <label>Objetivo del servicio</label>
                                              <textarea class="form-control" rows="6" id="techEditorObjetivo" placeholder="Describe el objetivo general y específicos"></textarea>
                                          </div>
                                          <div class="tech-editor-row">
                                              <label>Alcance del servicio</label>
                                              <textarea class="form-control" rows="6" id="techEditorAlcance" placeholder="Describe el alcance del servicio"></textarea>
                                          </div>
                                      </div>
                                      <div id="techEditorNormasFields" style="display:none;">
                                          <div class="tech-editor-row">
                                              <label>Introducción</label>
                                              <textarea class="form-control" rows="4" id="techEditorNormasIntro" placeholder="Describe el marco normativo aplicable a esta propuesta"></textarea>
                                          </div>
                                          <div class="tech-editor-row">
                                              <label>Normas aplicables</label>
                                              <div class="tech-editor-actions">
                                                  <button class="btn btn-default btn-sm" id="techOpenNormasModal"><i class="fas fa-search"></i> Buscar normas</button>
                                              </div>
                                              <div class="tech-normas-selected-list" id="techNormasSelectedList"></div>
                                              <div class="tech-normas-selected" id="techNormasSelected">Seleccionadas: 0</div>
                                          </div>
                                      </div>
                                      <div id="techEditorUbicacionFields" style="display:none;">
                                          <div class="tech-editor-row">
                                              <label>Introducción</label>
                                              <textarea class="form-control" rows="4" id="techEditorUbicacionIntro" placeholder="Describe la ubicación del servicio"></textarea>
                                          </div>
                                          <div class="tech-editor-row">
                                              <label>Mapa de ubicación</label>
                                              <div class="tech-map-upload" id="techMapUpload">
                                                  <i class="fas fa-map-marked-alt" style="font-size:20px;color:#ccc;display:block;margin-bottom:6px;"></i>
                                                  Subir imagen de mapa
                                              </div>
                                              <input type="file" id="techMapInput" accept="image/*" hidden>
                                              <div class="tech-map-preview" id="techMapPreview" style="display:none;">
                                                  <img id="techMapImg" alt="Mapa de ubicación">
                                                  <div class="tech-map-caption" id="techMapCaptionDisplay">
                                                      <span id="techMapCaptionText"></span>
                                                      <button type="button" id="techMapCaptionEdit"><i class="fas fa-pen"></i></button>
                                                  </div>
                                                  <input class="tech-map-caption-input" id="techMapCaptionInput" style="display:none;" placeholder="Figura 7.1: Área de estudio">
                                                  <div class="tech-map-actions">
                                                      <button class="btn btn-default btn-sm" id="techMapRemoveBtn"><i class="fas fa-trash"></i> Quitar imagen</button>
                                                  </div>
                                              </div>
                                          </div>
                                      </div>
                                      <div id="techEditorProfesionalesFields" style="display:none;">
                                          <div class="tech-editor-row">
                                              <label>Introducción</label>
                                              <textarea class="form-control" rows="4" id="techEditorProfesionalesIntro" placeholder="Describe el rol del equipo profesional"></textarea>
                                          </div>
                                          <div class="tech-editor-row">
                                              <label>Listado de profesionales</label>
                                              <div class="tech-pro-list" id="techProList"></div>
                                              <div class="tech-editor-actions" style="margin-top:8px;">
                                                  <button class="btn btn-default btn-sm" id="techOpenProModal"><i class="fas fa-search"></i> Seleccionar profesionales</button>
                                              </div>
                                          </div>
                                      </div>
                                        <div id="techEditorAutorizacionesFields" style="display:none;">
                                            <div class="tech-editor-row">
                                                <label>Introducción</label>
                                                <textarea class="form-control" rows="3" id="techEditorAutorizacionesIntro" placeholder="Describe el contexto de las autorizaciones"></textarea>
                                            </div>
                                          <div class="tech-editor-row">
                                              <label>Autorizaciones a solicitar</label>
                                              <div class="tech-auth-list" id="techAuthList"></div>
                                              <div class="tech-auth-actions" style="margin-top:8px;">
                                                  <button class="btn btn-default btn-sm" id="techOpenAuthModal"><i class="fas fa-search"></i> Seleccionar autorizaciones</button>
                                              </div>
                                            </div>
                                        </div>
                                        <div id="techEditorMetFQFields" style="display:none;">
                                            <div class="tech-editor-row">
                                                <label>Introducción</label>
                                                <textarea class="form-control" rows="4" id="techEditorMetFQIntro" placeholder="Describe la metodología para componentes físico-químicos"></textarea>
                                            </div>
                                            <div class="tech-editor-row">
                                                <label>Protocolo de muestreo</label>
                                                <div class="table-responsive">
                                                    <table class="econ-table" id="techMetFQTable">
                                                        <thead>
                                                            <tr>
                                                                <th style="width:40px;">#</th>
                                                                <th>Nombre Estación</th>
                                                                <th>Lugar de Muestreo</th>
                                                                <th>Coordenadas Geográficas</th>
                                                                <th>Matriz</th>
                                                                <th style="width:40px;"></th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="techMetFQTableBody"></tbody>
                                                    </table>
                                                </div>
                                                <div class="tech-editor-actions" style="margin-top:8px;">
                                                    <button class="btn btn-default btn-sm" id="techMetFQAddRow"><i class="fas fa-plus"></i> Agregar punto</button>
                                                </div>
                                            </div>
                                            <div class="tech-editor-row">
                                                <label>Imagen asociada</label>
                                                <div class="tech-map-upload" id="techMetFQImgUpload">
                                                    <i class="fas fa-image" style="font-size:20px;color:#ccc;display:block;margin-bottom:6px;"></i>
                                                    Subir imagen
                                                </div>
                                                <input type="file" id="techMetFQImgInput" accept="image/*" hidden>
                                                <div class="tech-map-preview" id="techMetFQImgPreview" style="display:none;">
                                                    <img id="techMetFQImgTag" alt="Imagen protocolo FQ">
                                                    <div class="tech-map-actions">
                                                        <button class="btn btn-default btn-sm" id="techMetFQImgRemove"><i class="fas fa-trash"></i> Quitar imagen</button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="tech-editor-row">
                                                <label>Descripción</label>
                                                <textarea class="form-control" rows="4" id="techEditorMetFQDesc" placeholder="Descripción del protocolo de muestreo para componentes físico-químicos"></textarea>
                                            </div>
                                        </div>
                                        <div id="techEditorCustomFields" style="display:none;">
                                            <div class="tech-editor-row">
                                                <label>Campos personalizados</label>
                                                <div class="tech-custom-fields" id="techCustomFieldsContainer"></div>
                                            </div>
                                      </div>
                                      <div class="tech-editor-row">
                                          <div class="tech-editor-hint">Los borradores se guardan localmente mientras navegas entre secciones.</div>
                                      </div>
                                      </div>
                                      </div>
                                      <div id="techViewDoc" style="display:none;">
                                          <div class="tech-doc-view" id="techDocView"></div>
                                      </div>
                                  </div>
                              </div>
                          </div>
                          <div class="tech-doc-full" id="techDocFull" style="display:none;">
                              <div class="tech-doc-page" id="techDocFullContent"></div>
                          </div>

                        <div class="proposal-actions">
                            <button class="btn btn-default js-prev-step" data-step="3" style="margin-right:auto;">Volver</button>
                            <button class="btn btn-default">Guardar propuesta técnica</button>
                            <button class="btn btn-info js-next-step" data-step="5">Continuar a Económica</button>
                        </div>
                </div>


                <div class="step-panel" id="step5">
                <div class="proposal-section">
                    <div class="proposal-card">
                        <h3><i class="fas fa-file-invoice-dollar"></i> Paso 5: Propuesta Económica</h3>
                        <div class="econ-grid">
                            <div class="econ-card">
                                <h4><i class="fas fa-table"></i> Tabla de precios por ítem</h4>
                                <div class="econ-actions">
                                    <button class="btn btn-warning btn-sm">Importar desde cotizador</button>
                                    <button class="btn btn-default btn-sm">Agregar ítem</button>
                                    <button class="btn btn-default btn-sm">Aplicar descuento</button>
                                </div>
                                <div class="table-responsive">
                                    <table class="econ-table">
                                        <thead>
                                            <tr>
                                                <th style="width:40px;">#</th>
                                                <th>Servicio / Ítem</th>
                                                <th style="width:110px;">Cantidad</th>
                                                <th style="width:140px;">Precio Unit.</th>
                                                <th style="width:110px;">Desc %</th>
                                                <th style="width:140px;">Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>1</td>
                                                <td><input type="text" class="form-control" value="Monitoreo ambiental"></td>
                                                <td><input type="number" class="form-control" value="1"></td>
                                                <td><input type="text" class="form-control" value="850000"></td>
                                                <td><input type="number" class="form-control" value="0"></td>
                                                <td>$850.000</td>
                                            </tr>
                                            <tr>
                                                <td>2</td>
                                                <td><input type="text" class="form-control" value="Análisis de laboratorio"></td>
                                                <td><input type="number" class="form-control" value="1"></td>
                                                <td><input type="text" class="form-control" value="420000"></td>
                                                <td><input type="number" class="form-control" value="5"></td>
                                                <td>$399.000</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="econ-card">
                                <h4><i class="fas fa-clipboard-list"></i> Condiciones comerciales</h4>
                                <div class="proposal-form-grid">
                                    <div class="proposal-field">
                                        <label>Forma de pago</label>
                                        <input type="text" class="form-control" placeholder="30 días fecha factura">
                                    </div>
                                    <div class="proposal-field">
                                        <label>Validez de la oferta</label>
                                        <input type="text" class="form-control" placeholder="60 días">
                                    </div>
                                    <div class="proposal-field">
                                        <label>Condiciones comerciales</label>
                                        <input type="text" class="form-control" placeholder="Precios netos + IVA">
                                    </div>
                                    <div class="proposal-field">
                                        <label>Notas adicionales</label>
                                        <input type="text" class="form-control" placeholder="Descuento por volumen">
                                    </div>
                                </div>
                            </div>

                            <div class="econ-card">
                                <h4><i class="fas fa-calculator"></i> Totales</h4>
                                <div class="econ-summary">
                                    <div class="summary-box">
                                        <span>Neto</span>
                                        <strong>$1.249.000</strong>
                                    </div>
                                    <div class="summary-box">
                                        <span>IVA 19%</span>
                                        <strong>$237.310</strong>
                                    </div>
                                    <div class="summary-box">
                                        <span>Total</span>
                                        <strong>$1.486.310</strong>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="proposal-actions">
                            <button class="btn btn-default js-prev-step" data-step="4" style="margin-right:auto;">Volver</button>
                            <button class="btn btn-default">Guardar propuesta económica</button>
                            <button class="btn btn-info js-next-step" data-step="6">Continuar a Aprobaci&oacute;n</button>
                        </div>
                    </div>
                </div>
                </div>

                    <div class="step-panel" id="step6">

                        <h4 class="section-title"><i class="fas fa-paper-plane"></i> Comprobante de env&iacute;o / recepci&oacute;n de propuesta</h4>

                        <div class="form-section-card">
                            <div class="notification-status-panel" id="notifPropPanel">
                                <!-- Estado: sin enviar -->
                                <div class="notif-state notif-pending" id="notifPropPending">
                                    <div class="notif-icon-box pending">
                                        <i class="fas fa-envelope"></i>
                                    </div>
                                    <div class="notif-info">
                                        <span class="notif-title">Pendiente de registro</span>
                                        <span class="notif-desc">A&uacute;n no se ha registrado el env&iacute;o o recepci&oacute;n de la propuesta.</span>
                                    </div>
                                    <button class="btn-notif-send" onclick="registrarEnvioPropuesta()">
                                        <i class="fas fa-check-circle"></i> Registrar env&iacute;o
                                    </button>
                                </div>

                                <!-- Estado: enviada (oculto por defecto) -->
                                <div class="notif-state notif-sent" id="notifPropSent" style="display:none;">
                                    <div class="notif-icon-box sent">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                    <div class="notif-info">
                                        <span class="notif-title sent">Propuesta enviada / recepcionada</span>
                                        <div class="notif-meta">
                                            <span><i class="fas fa-calendar-alt"></i> <span id="propEnvioFecha">07-02-2026 10:32</span></span>
                                            <span><i class="fas fa-user"></i> <span id="propEnvioUsuario">Cristian Toro</span></span>
                                            <span><i class="fas fa-at"></i> <span id="propEnvioEmail">csoto@arauco.cl</span></span>
                                        </div>
                                    </div>
                                    <div class="notif-actions">
                                        <button class="btn-notif-view" onclick="verComprobante()">
                                            <i class="fas fa-eye"></i> Ver comprobante
                                        </button>
                                        <button class="btn-notif-resend" onclick="registrarEnvioPropuesta()">
                                            <i class="fas fa-redo"></i> Actualizar
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="aprobacion-upload-divider"></div>

                            <div class="compact-form-group" style="margin-bottom: 0;">
                                <label><i class="fas fa-paperclip"></i> Documento de respaldo del env&iacute;o</label>
                            </div>
                            <input type="file" id="inputComprobanteFile" hidden accept=".pdf,.xls,.xlsx,.doc,.docx,.png,.jpg,.jpeg,.msg,.eml">
                            <div class="upload-area upload-area-compact" id="uploadComprobante">
                                <div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div>
                                <div class="upload-text">
                                    <span>Arrastra el archivo aqu&iacute; o</span>
                                    <button type="button" class="btn btn-success btn-sm" id="btnSeleccionarComprobante">
                                        <i class="fas fa-folder-open"></i> Seleccionar archivo
                                    </button>
                                </div>
                                <div class="upload-hint">Comprobante de env&iacute;o, acuse de recibo, correo de confirmaci&oacute;n u otro documento</div>
                            </div>
                            <div class="uploaded-file" id="uploadedComprobante" style="display: none;">
                                <div class="file-info">
                                    <i class="fas fa-file-alt file-icon" id="comprobanteFileIcon"></i>
                                    <div class="file-details">
                                        <span class="file-name" id="comprobanteFileName">documento.pdf</span>
                                        <span class="file-meta-line"><i class="fas fa-calendar-alt"></i> Subido: <strong id="comprobanteFileDate">&mdash;</strong></span>
                                        <span class="file-meta-line"><i class="fas fa-user"></i> Usuario: <strong id="comprobanteFileUser">&mdash;</strong></span>
                                    </div>
                                </div>
                                <div class="file-actions">
                                    <button type="button" class="btn-icon" title="Descargar" onclick="downloadComprobanteFile()">
                                        <i class="fas fa-download"></i>
                                    </button>
                                    <button type="button" class="btn-icon btn-icon-danger" title="Eliminar" onclick="removeComprobanteFile()">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <h4 class="section-title"><i class="fas fa-trophy"></i> Resultado de propuesta</h4>

                        <div class="form-section-card">
                            <div class="form-grid">
                                <div class="compact-form-group">
                                    <label>Resultado</label>
                                    <select class="form-control" id="ddlResultadoProp">
                                        <option value="-1">Seleccionar</option>
                                        <option value="ADJUDICADA">Adjudicada</option>
                                        <option value="NO_ADJUDICADA">No Adjudicada</option>
                                        <option value="DESIERTA">Desierta</option>
                                        <option value="EN_EVALUACION">En Evaluaci&oacute;n</option>
                                    </select>
                                </div>
                                <div class="compact-form-group">
                                    <label>Ranking</label>
                                    <input type="text" class="form-control" id="txtRanking" placeholder="Ej: 1 de 5">
                                </div>
                                <div class="compact-form-group">
                                    <label>Puntaje t&eacute;cnico</label>
                                    <input type="text" class="form-control" id="txtPuntajeTec" placeholder="Ej: 95 / 100">
                                </div>
                                <div class="compact-form-group">
                                    <label>Puntaje econ&oacute;mico</label>
                                    <input type="text" class="form-control" id="txtPuntajeEco" placeholder="Ej: 90 / 100">
                                </div>
                                <div class="compact-form-group">
                                    <label>Monto ofertado</label>
                                    <input type="text" class="form-control" id="txtMontoOfertado" placeholder="CLP 0">
                                </div>
                                <div class="compact-form-group">
                                    <label>Monto adjudicado</label>
                                    <input type="text" class="form-control" id="txtMontoAdjudicado" placeholder="CLP 0">
                                </div>
                                <div class="compact-form-group">
                                    <label>Fecha resultado</label>
                                    <input type="date" class="form-control" id="dtFechaResultado">
                                </div>
                                <div class="compact-form-group" style="grid-column: 1 / -1;">
                                    <label>Comentario / Feedback del cliente</label>
                                    <textarea class="form-control" id="txtComentarioResultado" rows="3" placeholder="Observaciones, motivos de adjudicaci&oacute;n o rechazo, lecciones aprendidas..."></textarea>
                                </div>
                            </div>

                            <div class="aprobacion-upload-divider"></div>

                            <div class="compact-form-group" style="margin-bottom: 0;">
                                <label><i class="fas fa-paperclip"></i> Documento de respaldo del resultado</label>
                            </div>
                            <input type="file" id="inputResultadoFile" hidden accept=".pdf,.xls,.xlsx,.doc,.docx,.png,.jpg,.jpeg,.msg,.eml">
                            <div class="upload-area upload-area-compact" id="uploadResultado">
                                <div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div>
                                <div class="upload-text">
                                    <span>Arrastra el archivo aqu&iacute; o</span>
                                    <button type="button" class="btn btn-success btn-sm" id="btnSeleccionarResultado">
                                        <i class="fas fa-folder-open"></i> Seleccionar archivo
                                    </button>
                                </div>
                                <div class="upload-hint">Acta de adjudicaci&oacute;n, carta de resultado, correo de notificaci&oacute;n u otro documento oficial</div>
                            </div>
                            <div class="uploaded-file" id="uploadedResultado" style="display: none;">
                                <div class="file-info">
                                    <i class="fas fa-file-alt file-icon" id="resultFileIcon"></i>
                                    <div class="file-details">
                                        <span class="file-name" id="resultFileName">documento.pdf</span>
                                        <span class="file-meta-line"><i class="fas fa-calendar-alt"></i> Subido: <strong id="resultFileDate">&mdash;</strong></span>
                                        <span class="file-meta-line"><i class="fas fa-user"></i> Usuario: <strong id="resultFileUser">&mdash;</strong></span>
                                    </div>
                                </div>
                                <div class="file-actions">
                                    <button type="button" class="btn-icon" title="Descargar" onclick="downloadResultadoFile()">
                                        <i class="fas fa-download"></i>
                                    </button>
                                    <button type="button" class="btn-icon btn-icon-danger" title="Eliminar" onclick="removeResultadoFile()">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <h4 class="section-title"><i class="fas fa-user-check"></i> Aprobaci&oacute;n final (Supervisor)</h4>

                        <div class="form-section-card">
                            <div class="table-documents-wrapper">
                                <table class="table-documents">
                                    <thead>
                                        <tr>
                                            <th style="width:40px;"></th>
                                            <th>Aprobador</th>
                                            <th>Nombre</th>
                                            <th style="width:130px;">Fecha</th>
                                            <th>Comentario</th>
                                            <th style="width:120px;">Estado</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbodyAprobadoresProp">
                                        <tr>
                                            <td>1</td>
                                            <td>Jefe Comercial</td>
                                            <td>Viviana Lopez Oyarce</td>
                                            <td>07-02-2026</td>
                                            <td>Aprobado, m&aacute;rgenes correctos.</td>
                                            <td><span class="badge badge-success" style="font-size:10px; padding:4px 10px;"><i class="fas fa-check"></i> Aprobado</span></td>
                                        </tr>
                                        <tr>
                                            <td>2</td>
                                            <td>Gerente &Aacute;rea</td>
                                            <td>Ricardo Valenzuela</td>
                                            <td>&mdash;</td>
                                            <td>&mdash;</td>
                                            <td><span class="badge badge-danger" style="font-size:10px; padding:4px 10px;"><i class="fas fa-exclamation-circle"></i> Pendiente</span></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="action-buttons">
                            <button type="button" class="btn btn-default js-prev-step" data-step="5">
                                <i class="fas fa-arrow-left"></i> Anterior
                            </button>
                            <button type="button" class="btn btn-success">
                                <i class="fas fa-save"></i> Guardar Aprobaci&oacute;n
                            </button>
                        </div>
                    </div>
            </div>

            <footer class="footer">
                <nav>
                    <a href="https://www.sgs.com/">SGS</a>
                </nav>
                <div class="copyright">
                    &copy; 2026, made by <a href="https://www.sgs.com/">SGS TI</a>
                </div>
            </footer>
        </div>
    </div>

    <div class="simple-modal-overlay" id="normasModal">
        <div class="simple-modal" role="dialog" aria-modal="true" aria-labelledby="normasModalTitle">
            <div class="simple-modal-header">
                <h4 id="normasModalTitle">Seleccionar normas aplicables</h4>
                <button class="btn btn-default btn-sm" id="normasModalClose"><i class="fas fa-times"></i></button>
            </div>
            <div class="simple-modal-body">
                <div class="tech-tree-search" style="margin:0;">
                    <i class="fas fa-search"></i>
                    <input type="text" id="normasModalSearch" placeholder="Buscar norma">
                </div>
                <div class="simple-modal-list" id="normasModalList"></div>
                <div style="display:flex;justify-content:flex-end;">
                    <button class="btn btn-warning btn-sm" id="normasModalApply">Listo</button>
                </div>
            </div>
        </div>
    </div>

    <div class="simple-modal-overlay" id="profesionalesModal">
        <div class="simple-modal" role="dialog" aria-modal="true" aria-labelledby="profesionalesModalTitle">
            <div class="simple-modal-header">
                <h4 id="profesionalesModalTitle">Seleccionar profesionales</h4>
                <button class="btn btn-default btn-sm" id="profesionalesModalClose"><i class="fas fa-times"></i></button>
            </div>
            <div class="simple-modal-body">
                <div class="tech-tree-search" style="margin:0;">
                    <i class="fas fa-search"></i>
                    <input type="text" id="profesionalesModalSearch" placeholder="Buscar profesional">
                </div>
                <div class="simple-modal-list" id="profesionalesModalList"></div>
                <div style="display:flex;justify-content:flex-end;">
                    <button class="btn btn-warning btn-sm" id="profesionalesModalApply">Listo</button>
                </div>
            </div>
        </div>
    </div>

    <div class="simple-modal-overlay" id="autorizacionesModal">
        <div class="simple-modal" role="dialog" aria-modal="true" aria-labelledby="autorizacionesModalTitle">
            <div class="simple-modal-header">
                <h4 id="autorizacionesModalTitle">Seleccionar autorizaciones</h4>
                <button class="btn btn-default btn-sm" id="autorizacionesModalClose"><i class="fas fa-times"></i></button>
            </div>
            <div class="simple-modal-body">
                <div class="tech-tree-search" style="margin:0;">
                    <i class="fas fa-search"></i>
                    <input type="text" id="autorizacionesModalSearch" placeholder="Buscar autorización">
                </div>
                <div class="simple-modal-list" id="autorizacionesModalList"></div>
                <div style="display:flex;justify-content:flex-end;">
                    <button class="btn btn-warning btn-sm" id="autorizacionesModalApply">Listo</button>
                </div>
            </div>
        </div>
    </div>

    <div class="simple-modal-overlay" id="customTopicModal">
        <div class="simple-modal" role="dialog" aria-modal="true" aria-labelledby="customTopicModalTitle">
            <div class="simple-modal-header">
                <h4 id="customTopicModalTitle">Nuevo tópico</h4>
                <button class="btn btn-default btn-sm" id="customTopicModalClose"><i class="fas fa-times"></i></button>
            </div>
            <div class="simple-modal-body">
                <div class="tech-editor-row" style="padding:0;border:none;">
                    <label>Nombre del tópico</label>
                    <input class="form-control" id="customTopicTitle" placeholder="Ej: Plan de trabajo">
                </div>
                <div class="tech-editor-row" style="padding:0;border:none;">
                    <label>Campos personalizados (uno por línea)</label>
                    <textarea class="form-control" rows="4" id="customTopicFields" placeholder="Ej:\nObjetivo\nMetodología\nEntregables"></textarea>
                </div>
                <div style="display:flex;justify-content:flex-end;gap:8px;">
                    <button class="btn btn-default btn-sm" id="customTopicCancel">Cancelar</button>
                    <button class="btn btn-warning btn-sm" id="customTopicCreate">Crear</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        var currentStep = 1;
        var viewingStep = 1;

        function showStepPanel(step) {
            var currentPanel = document.querySelector('.step-panel.active');
            if (currentPanel) {
                currentPanel.classList.remove('active');
            }
            var targetPanel = document.getElementById('step' + step);
            if (targetPanel) {
                targetPanel.classList.add('active');
            }
            var stepLabel = document.getElementById('proposalStepCurrent');
            if (stepLabel) {
                stepLabel.textContent = step;
            }
        }

        function updateStepperViewing(step) {
            document.querySelectorAll('.stepper-item.viewing').forEach(function(item) {
                item.classList.remove('viewing');
            });
            var viewingItem = document.querySelector('.stepper-item[data-step="' + step + '"]');
            if (viewingItem) {
                viewingItem.classList.add('viewing');
            }
        }

        function setStepState(step) {
            document.querySelectorAll('.stepper-item').forEach(function(item) {
                var itemStep = parseInt(item.getAttribute('data-step'), 10);
                item.classList.remove('active');
                item.classList.remove('completed');
                if (itemStep < step) {
                    item.classList.add('completed');
                }
                if (itemStep === step) {
                    item.classList.add('active');
                }
            });
            updateStepperViewing(step);
        }

        function goToStep(step) {
            var targetPanel = document.getElementById('step' + step);
            if (!targetPanel) {
                return;
            }
            currentStep = step;
            viewingStep = step;
            showStepPanel(step);
            setStepState(step);
            window.scrollTo(0, 0);
        }

        document.querySelectorAll('.stepper-item').forEach(function(item) {
            item.addEventListener('click', function() {
                var step = parseInt(item.getAttribute('data-step'), 10);
                if (!isNaN(step)) {
                    goToStep(step);
                }
            });
        });

        document.querySelectorAll('.js-next-step').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var step = parseInt(btn.getAttribute('data-step'), 10);
                if (!isNaN(step)) {
                    goToStep(step);
                }
            });
        });

        document.querySelectorAll('.js-prev-step').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var step = parseInt(btn.getAttribute('data-step'), 10);
                if (!isNaN(step)) {
                    goToStep(step);
                }
            });
        });

        goToStep(1);

        /* ========= Repositorio Documental (Paso 3) ========= */

        // Map of folder IDs to display names
        var repoFolderNames = {
            bases: 'Bases y Anexos',
            consultas: 'Consultas y Aclaraciones',
            tecnico: 'Desarrollo T\u00e9cnico',
            economico: 'Desarrollo Econ\u00f3mico',
            admin: 'Docs Administrativos',
            final: 'Propuesta Final'
        };

        // Map sub-tipo IDs to display names
        var repoSubNames = {
            'bases-tecnicas': 'Bases t\u00e9cnicas',
            'bases-admin': 'Bases administrativas',
            'anexos-tecnicos': 'Anexos t\u00e9cnicos',
            'planos': 'Planos / especificaciones',
            'consultas-enviadas': 'Consultas enviadas',
            'respuestas': 'Respuestas oficiales',
            'metodologia': 'Metodolog\u00eda propuesta',
            'plan-muestreo': 'Plan de muestreo',
            'protocolos': 'Protocolos anal\u00edticos',
            'certificaciones': 'Certificaciones / acreditaciones',
            'planilla-costos': 'Planilla de costos',
            'precios-unitarios': 'An\u00e1lisis de precios unitarios',
            'respaldos-cot': 'Respaldos cotizaciones',
            'antecedentes-legales': 'Antecedentes legales',
            'declaraciones': 'Declaraciones juradas',
            'garantias': 'Garant\u00edas',
            'poderes': 'Poderes / mandatos',
            'prop-tecnica': 'Propuesta t\u00e9cnica (PDF)',
            'prop-economica': 'Propuesta econ\u00f3mica (PDF)',
            'comprobante-envio': 'Comprobante de env\u00edo'
        };

        // Track selected folder/sub for uploads
        var currentUploadFolder = 'bases';
        var currentUploadSub = '';

        function switchRepoView(view, folder, sub) {
            var btns = document.querySelectorAll('.repo-view-btn');
            btns.forEach(function(b) { b.classList.remove('active'); });

            var panels = document.querySelectorAll('.repo-view-panel');
            panels.forEach(function(p) { p.classList.remove('active'); });

            if (view === 'files') {
                var filesPanel = document.getElementById('repoViewFiles');
                if (filesPanel) filesPanel.classList.add('active');
                if (btns[1]) btns[1].classList.add('active');
                treeSelectFolder(folder || '', sub || '');
            } else {
                var foldersPanel = document.getElementById('repoViewFolders');
                if (foldersPanel) foldersPanel.classList.add('active');
                if (btns[0]) btns[0].classList.add('active');
            }
        }

        function filterRepoFilesBySelection(folder, sub) {
            var rows = document.querySelectorAll('#repoFilesBody tr');
            var num = 0;
            var empty = document.getElementById('repoFilesEmpty');
            var table = document.getElementById('repoFilesTable');
            var dropzone = document.getElementById('repoDropzone');
            if (!folder && !sub) {
                rows.forEach(function(row) { row.style.display = 'none'; });
                if (table) table.hidden = true;
                if (empty) empty.hidden = true;
                if (dropzone) dropzone.hidden = true;
                return;
            }

            if (folder && !sub) {
                rows.forEach(function(row) { row.style.display = 'none'; });
                if (empty) empty.hidden = false;
                if (table) table.hidden = true;
                if (dropzone) dropzone.hidden = true;
                return;
            }
            if (empty) empty.hidden = false;
            if (table) table.hidden = false;
            if (dropzone) dropzone.hidden = false;

            rows.forEach(function(row) {
                var matchFolder = !folder || row.getAttribute('data-folder') === folder;
                var matchSub = !sub || row.getAttribute('data-sub') === sub;
                if (matchFolder && matchSub) {
                    row.style.display = '';
                    num++;
                    row.querySelector('td').textContent = num;
                } else {
                    row.style.display = 'none';
                }
            });

            if (empty) {
                empty.hidden = num > 0;
            }
        }

        function treeToggleFolder(headerEl, folderId) {
            var subs = document.querySelector('.repo-tree-subs[data-tree-subs="' + folderId + '"]');
            if (subs) {
                var isOpen = subs.classList.toggle('open');
                var arrow = headerEl.querySelector('.tree-arrow');
                if (arrow) {
                    arrow.classList.toggle('open', isOpen);
                }
                if (arrow && arrow.classList.contains('fa-caret-right')) {
                    arrow.classList.toggle('fa-caret-down', isOpen);
                    arrow.classList.toggle('fa-caret-right', !isOpen);
                }
                var folderIcon = headerEl.querySelector('.fa-folder, .fa-folder-open');
                if (folderIcon) {
                    folderIcon.classList.toggle('fa-folder-open', isOpen);
                    folderIcon.classList.toggle('fa-folder', !isOpen);
                }
            }
            treeSelectFolder(folderId, '', true);
        }

        function treeSelectFolder(folderId, subId, skipAutoOpen) {
            currentUploadFolder = folderId || currentUploadFolder || 'bases';
            currentUploadSub = subId || '';

            document.querySelectorAll('.repo-tree-folder-header').forEach(function(el) {
                el.classList.remove('active');
            });
            document.querySelectorAll('.repo-tree-sub').forEach(function(el) {
                el.classList.remove('active');
            });

            if (!folderId && !subId) {
                var allNode = document.querySelector('.repo-tree-folder[data-tree-folder="all"] .repo-tree-folder-header');
                if (allNode) allNode.classList.add('active');
                updateRepoBreadcrumb('', '');
                updateRepoUploadTarget('', '');
                renderSubfolders('', '');
                filterRepoFilesBySelection('', '');
                return;
            }

            var folderHeader = document.querySelector('.repo-tree-folder[data-tree-folder="' + folderId + '"] .repo-tree-folder-header');
            if (folderHeader) {
                folderHeader.classList.add('active');
                var subs = document.querySelector('.repo-tree-subs[data-tree-subs="' + folderId + '"]');
                if (subs && !subs.classList.contains('open') && !skipAutoOpen) {
                    subs.classList.add('open');
                    var arrow = folderHeader.querySelector('.tree-arrow');
                    if (arrow) arrow.classList.add('open');
                    if (arrow && arrow.classList.contains('fa-caret-right')) {
                        arrow.classList.add('fa-caret-down');
                        arrow.classList.remove('fa-caret-right');
                    }
                    var icon = folderHeader.querySelector('.fa-folder');
                    if (icon) {
                        icon.classList.remove('fa-folder');
                        icon.classList.add('fa-folder-open');
                    }
                }
            }

            if (subId) {
                var subEl = document.querySelector('.repo-tree-sub[data-tree-sub="' + subId + '"]');
                if (subEl) subEl.classList.add('active');
            }

            updateRepoBreadcrumb(folderId, subId);
            updateRepoUploadTarget(folderId, subId);
            renderSubfolders(folderId, subId);
            filterRepoFilesBySelection(folderId, subId);
        }

        function updateRepoBreadcrumb(folderId, subId) {
            var folderLabel = document.getElementById('repoBreadcrumbFolder');
            var subLabel = document.getElementById('repoBreadcrumbSub');
            if (!folderLabel || !subLabel) return;
            folderLabel.textContent = folderId ? ' / ' + (repoFolderNames[folderId] || folderId) : '';
            subLabel.textContent = subId ? ' / ' + (repoSubNames[subId] || subId) : '';
        }

        function updateRepoUploadTarget(folderId, subId) {
            var dropzone = document.getElementById('repoDropzone');
            if (!dropzone) return;
            if (!folderId || !subId) {
                dropzone.hidden = true;
                return;
            }
            dropzone.hidden = false;
        }

        // quick selector removed; selection happens from tree or subfolder list

        function renderSubfolders(folderId, subId) {
            var list = document.getElementById('repoSubfolderList');
            if (!list) return;

            if (!folderId && !subId) {
                var htmlRoot =
                    '<div class="table-responsive">' +
                        '<table class="repo-subfolder-table">' +
                            '<thead>' +
                                '<tr>' +
                                    '<th style="width:30px;">#</th>' +
                                    '<th>Carpeta</th>' +
                                    '<th style="width:120px;">Archivos</th>' +
                                '</tr>' +
                            '</thead>' +
                            '<tbody id="repoSubfolderBody"></tbody>' +
                        '</table>' +
                    '</div>';
                list.innerHTML = htmlRoot;
                var tbodyRoot = document.getElementById('repoSubfolderBody');
                var folders = document.querySelectorAll('.repo-tree-folder[data-tree-folder]:not([data-tree-folder="all"])');
                var idxRoot = 0;
                folders.forEach(function(folderEl) {
                    var folderIdLocal = folderEl.getAttribute('data-tree-folder');
                    var label = repoFolderNames[folderIdLocal] || folderIdLocal;
                    var count = document.querySelectorAll('#repoFilesBody tr[data-folder="' + folderIdLocal + '"]').length;
                    idxRoot += 1;
                    var row = document.createElement('tr');
                    row.className = 'repo-subfolder-row';
                    row.innerHTML =
                        '<td>' + idxRoot + '</td>' +
                        '<td><span class="repo-subfolder-name"><i class="fas fa-folder"></i>' + label + '</span></td>' +
                        '<td><span class="repo-subfolder-count' + (count > 0 ? ' has-files' : '') + '">' + count + '</span></td>';
                    row.addEventListener('click', function() {
                        treeSelectFolder(folderIdLocal, '');
                    });
                    tbodyRoot.appendChild(row);
                });
                list.hidden = false;
                return;
            }

            if (!folderId || subId) {
                list.innerHTML = '';
                list.hidden = true;
                return;
            }

            var subs = document.querySelectorAll('.repo-tree-subs[data-tree-subs="' + folderId + '"] .repo-tree-sub');
            var html =
                '<div class="table-responsive">' +
                    '<table class="repo-subfolder-table">' +
                        '<thead>' +
                            '<tr>' +
                                '<th style="width:30px;">#</th>' +
                                '<th>Subcarpeta</th>' +
                                '<th style="width:120px;">Archivos</th>' +
                            '</tr>' +
                        '</thead>' +
                        '<tbody id="repoSubfolderBody"></tbody>' +
                    '</table>' +
                '</div>';
            list.innerHTML = html;
            var tbody = document.getElementById('repoSubfolderBody');
            var idx = 0;
            subs.forEach(function(el) {
                var sid = el.getAttribute('data-tree-sub');
                var label = repoSubNames[sid] || sid;
                var count = document.querySelectorAll('#repoFilesBody tr[data-sub="' + sid + '"]').length;
                idx += 1;
                var row = document.createElement('tr');
                row.className = 'repo-subfolder-row';
                row.innerHTML =
                    '<td>' + idx + '</td>' +
                    '<td><span class="repo-subfolder-name"><i class="fas fa-folder"></i>' + label + '</span></td>' +
                    '<td><span class="repo-subfolder-count' + (count > 0 ? ' has-files' : '') + '">' + count + '</span></td>';
                row.addEventListener('click', function() {
                    treeSelectFolder(folderId, sid);
                });
                tbody.appendChild(row);
            });
            list.hidden = false;
        }

        function triggerUpload(folder) {
            if (!currentUploadSub) {
                return;
            }
            var targetFolder = folder || currentUploadFolder || 'bases';
            currentUploadFolder = targetFolder;
            var input = document.querySelector('.repo-folder-input[data-folder="' + targetFolder + '"]');
            if (input) {
                input.click();
            }
        }

        function deleteRepoFile(btn) {
            var row = btn.closest('tr');
            var folder = row.getAttribute('data-folder');
            var sub = row.getAttribute('data-sub');
            row.remove();
            renumberRepoFiles();
            updateFolderBadge(folder);
            updateSubCount(sub);
            updateTreeCounts();
        }

        function renumberRepoFiles() {
            var rows = document.querySelectorAll('#repoFilesBody tr');
            var num = 0;
            rows.forEach(function(row) {
                if (row.style.display !== 'none') {
                    num++;
                    row.querySelector('td').textContent = num;
                }
            });
        }

        function updateFolderBadge(folder) {
            var count = document.querySelectorAll('#repoFilesBody tr[data-folder="' + folder + '"]').length;
            var badge = document.querySelector('.repo-folder-badge[data-folder="' + folder + '"]');
            if (badge) {
                badge.textContent = count + (count === 1 ? ' archivo' : ' archivos');
            }
            updateTreeCounts();
        }

        function updateSubCount(subId) {
            if (!subId) return;
            var count = document.querySelectorAll('#repoFilesBody tr[data-sub="' + subId + '"]').length;
            var badge = document.querySelector('.repo-sub-count[data-sub-count="' + subId + '"]');
            if (badge) {
                badge.textContent = count;
                if (count > 0) {
                    badge.classList.add('has-files');
                } else {
                    badge.classList.remove('has-files');
                }
            }
            updateTreeCounts();
        }

        function updateAllSubCounts() {
            var badges = document.querySelectorAll('.repo-sub-count[data-sub-count]');
            badges.forEach(function(badge) {
                var subId = badge.getAttribute('data-sub-count');
                updateSubCount(subId);
            });
        }

        function updateTreeCounts() {
            var rows = document.querySelectorAll('#repoFilesBody tr');
            var total = rows.length;
            var allCount = document.getElementById('treeCountAll');
            if (allCount) {
                allCount.textContent = total;
                if (total > 0) allCount.classList.add('has-files');
            }
            document.querySelectorAll('[data-tree-count]').forEach(function(el) {
                var folder = el.getAttribute('data-tree-count');
                var count = document.querySelectorAll('#repoFilesBody tr[data-folder="' + folder + '"]').length;
                el.textContent = count;
                if (count > 0) el.classList.add('has-files');
                else el.classList.remove('has-files');
            });
            document.querySelectorAll('[data-tree-subcount]').forEach(function(el) {
                var sub = el.getAttribute('data-tree-subcount');
                var count = document.querySelectorAll('#repoFilesBody tr[data-sub="' + sub + '"]').length;
                el.textContent = count;
                if (count > 0) el.classList.add('has-files');
                else el.classList.remove('has-files');
            });
            renderSubfolders(currentUploadFolder, currentUploadSub);
        }

        function handleRepoUpload(input) {
            var files = input.files;
            if (!files || files.length === 0) return;

            var folder = input.getAttribute('data-folder') || currentUploadFolder || 'bases';
            // Get the first sub-type of this folder as default
            var folderCard = document.querySelector('.repo-folder[data-folder-id="' + folder + '"]');
            var firstSub = '';
            var firstSubName = '';
            if (folderCard) {
                var firstSubSpan = folderCard.querySelector('.repo-folder-items span[data-sub]');
                if (firstSubSpan) {
                    firstSub = firstSubSpan.getAttribute('data-sub');
                    firstSubName = repoSubNames[firstSub] || firstSub;
                }
            } else {
                var treeFirst = document.querySelector('.repo-tree-subs[data-tree-subs="' + folder + '"] .repo-tree-sub');
                if (treeFirst) {
                    firstSub = treeFirst.getAttribute('data-tree-sub');
                    firstSubName = repoSubNames[firstSub] || firstSub;
                }
            }

            // If there are multiple sub-types, ask which one
            var subs = folderCard ? folderCard.querySelectorAll('.repo-folder-items span[data-sub]') : [];
            var selectedSub = currentUploadSub || firstSub;
            var selectedSubName = repoSubNames[selectedSub] || firstSubName;

            if (!currentUploadSub && subs.length > 1) {
                var options = [];
                subs.forEach(function(s, idx) {
                    var sid = s.getAttribute('data-sub');
                    options.push((idx + 1) + '. ' + (repoSubNames[sid] || sid));
                });
                var choice = prompt('Seleccione el sub-tipo para los archivos:\n' + options.join('\n') + '\n\nIngrese el n\u00famero:', '1');
                if (choice !== null) {
                    var idx = parseInt(choice) - 1;
                    if (idx >= 0 && idx < subs.length) {
                        selectedSub = subs[idx].getAttribute('data-sub');
                        selectedSubName = repoSubNames[selectedSub] || selectedSub;
                    }
                }
            }

            var tbody = document.getElementById('repoFilesBody');
            var today = new Date();
            var dateStr = ('0' + today.getDate()).slice(-2) + '/' + ('0' + (today.getMonth() + 1)).slice(-2) + '/' + today.getFullYear();

            for (var i = 0; i < files.length; i++) {
                var file = files[i];
                var ext = file.name.split('.').pop().toLowerCase();
                var icon = 'fa-file';
                if (ext === 'pdf') icon = 'fa-file-pdf';
                else if (ext === 'doc' || ext === 'docx') icon = 'fa-file-word';
                else if (ext === 'xls' || ext === 'xlsx') icon = 'fa-file-excel';
                else if (ext === 'jpg' || ext === 'png') icon = 'fa-file-image';

                var size = file.size;
                var sizeStr = size > 1048576 ? (size / 1048576).toFixed(1) + ' MB' : (size / 1024).toFixed(0) + ' KB';

                var row = document.createElement('tr');
                row.setAttribute('data-folder', folder);
                row.setAttribute('data-sub', selectedSub);
                row.innerHTML =
                    '<td></td>' +
                    '<td><span class="file-name"><i class="fas ' + icon + '"></i> ' + file.name + '</span></td>' +
                    '<td>' + selectedSubName + '</td>' +
                    '<td>' + dateStr + '</td>' +
                    '<td>' + sizeStr + '</td>' +
                    '<td><div class="file-actions">' +
                        '<button class="btn btn-default btn-sm"><i class="fas fa-download"></i></button>' +
                        '<button class="btn btn-danger btn-sm" onclick="deleteRepoFile(this)"><i class="fas fa-trash"></i></button>' +
                    '</div></td>';
                tbody.appendChild(row);
            }

            renumberRepoFiles();
            updateFolderBadge(folder);
            updateSubCount(selectedSub);
            input.value = '';

            // Switch to files view filtered by the folder
            switchRepoView('files', folder, selectedSub);
        }

        // Crear nueva carpeta
        var newFolderCounter = 0;
        function crearNuevaCarpeta() {
            var nombre = prompt('Nombre de la nueva carpeta:');
            if (!nombre || !nombre.trim()) return;
            nombre = nombre.trim();

            newFolderCounter++;
            var folderId = 'custom-' + newFolderCounter;

            // Add to folder names map
            repoFolderNames[folderId] = nombre;

            // Add option to folder filter (if exists)
            var folderFilter = document.getElementById('repoFolderFilter');
            if (folderFilter) {
                var opt = document.createElement('option');
                opt.value = folderId;
                opt.textContent = nombre;
                folderFilter.appendChild(opt);
            }

            // Create folder card
            var folderHtml =
                '<div class="repo-folder" data-folder-id="' + folderId + '">' +
                    '<button class="repo-folder-delete" onclick="eliminarCarpeta(\'' + folderId + '\')" title="Eliminar carpeta"><i class="fas fa-times"></i></button>' +
                    '<div class="repo-folder-header">' +
                        '<h4><i class="fas fa-folder"></i> ' + nombre + '</h4>' +
                        '<span class="repo-folder-badge" data-folder="' + folderId + '">0 archivos</span>' +
                    '</div>' +
                    '<div class="repo-folder-items">' +
                        '<span data-sub="' + folderId + '-general" onclick="switchRepoView(\'files\',\'' + folderId + '\',\'' + folderId + '-general\')"><i class="fas fa-file-alt"></i> General <span class="repo-sub-count" data-sub-count="' + folderId + '-general">0</span></span>' +
                    '</div>' +
                    '<div class="repo-folder-footer">' +
                        '<a onclick="triggerUpload(\'' + folderId + '\')"><i class="fas fa-upload"></i> Subir archivo</a>' +
                        '<a onclick="switchRepoView(\'files\',\'' + folderId + '\')"><i class="fas fa-arrow-right"></i> Ver archivos</a>' +
                    '</div>' +
                    '<input type="file" class="repo-folder-input" data-folder="' + folderId + '" hidden multiple onchange="handleRepoUpload(this)">' +
                '</div>';

            var grid = document.getElementById('repoFolderGrid');
            grid.insertAdjacentHTML('beforeend', folderHtml);

            // Add sub-type to map
            repoSubNames[folderId + '-general'] = 'General';

            // Add to tree (vista archivos)
            var treePanel = document.getElementById('repoTreePanel');
            if (treePanel) {
                var treeHtml =
                    '<div class="repo-tree-folder" data-tree-folder="' + folderId + '">' +
                        '<div class="repo-tree-folder-header" onclick="treeToggleFolder(this, \'' + folderId + '\')">' +
                            '<i class="fas fa-caret-right tree-arrow"></i>' +
                            '<i class="fas fa-folder"></i>' +
                            '<span class="tree-folder-name">' + nombre + '</span>' +
                            '<span class="tree-folder-count" data-tree-count="' + folderId + '">0</span>' +
                            '<span class="repo-tree-actions">' +
                                '<i class="fas fa-folder-plus" title="Agregar subcarpeta" onclick="event.stopPropagation(); agregarSubcarpeta(\'' + folderId + '\')"></i>' +
                                '<i class="fas fa-ellipsis-v menu-trigger" title="Opciones" onclick="event.stopPropagation(); toggleTreeMenu(this)"></i>' +
                                '<div class="context-menu">' +
                                    '<button onclick="event.stopPropagation(); editarCarpetaNombre(\'' + folderId + '\')"><i class="fas fa-edit"></i> Editar</button>' +
                                    '<button onclick="event.stopPropagation(); eliminarCarpeta(\'' + folderId + '\')"><i class="fas fa-trash"></i> Eliminar</button>' +
                                '</div>' +
                            '</span>' +
                        '</div>' +
                        '<div class="repo-tree-subs" data-tree-subs="' + folderId + '">' +
                            '<div class="repo-tree-sub" data-tree-sub="' + folderId + '-general" onclick="treeSelectFolder(\'' + folderId + '\',\'' + folderId + '-general\')">' +
                                '<i class="fas fa-file-alt"></i> General' +
                                '<span class="tree-sub-count" data-tree-subcount="' + folderId + '-general">0</span>' +
                            '</div>' +
                        '</div>' +
                    '</div>';
                treePanel.insertAdjacentHTML('beforeend', treeHtml);
            }

            updateTreeCounts();
            if (!currentUploadFolder && !currentUploadSub) {
                renderSubfolders('', '');
            }
        }

        function eliminarCarpeta(folderId) {
            // Count files in this folder
            var fileCount = document.querySelectorAll('#repoFilesBody tr[data-folder="' + folderId + '"]').length;
            var msg = 'Eliminar carpeta "' + (repoFolderNames[folderId] || folderId) + '"';
            if (fileCount > 0) {
                msg += ' y sus ' + fileCount + ' archivo(s)';
            }
            msg += '?';

            if (!confirm(msg)) return;

            // Remove files from table
            var files = document.querySelectorAll('#repoFilesBody tr[data-folder="' + folderId + '"]');
            files.forEach(function(f) { f.remove(); });

            // Remove folder card
            var card = document.querySelector('.repo-folder[data-folder-id="' + folderId + '"]');
            if (card) card.remove();

            // Remove tree node
            var treeNode = document.querySelector('.repo-tree-folder[data-tree-folder="' + folderId + '"]');
            if (treeNode) treeNode.remove();

            // Remove from filter dropdown
            var opt = document.querySelector('#repoFolderFilter option[value="' + folderId + '"]');
            if (opt) opt.remove();

            // Remove from map
            delete repoFolderNames[folderId];

            renumberRepoFiles();
            updateTreeCounts();
            renderSubfolders('', '');
        }

        function editarCarpetaNombre(folderId) {
            var currentName = repoFolderNames[folderId] || folderId;
            var nombre = prompt('Nuevo nombre de carpeta:', currentName);
            if (!nombre || !nombre.trim()) return;
            nombre = nombre.trim();

            repoFolderNames[folderId] = nombre;

            var cardTitle = document.querySelector('.repo-folder[data-folder-id="' + folderId + '"] .repo-folder-header h4');
            if (cardTitle) {
                cardTitle.innerHTML = '<i class="fas fa-folder"></i> ' + nombre;
            }

            var treeLabel = document.querySelector('.repo-tree-folder[data-tree-folder="' + folderId + '"] .tree-folder-name');
            if (treeLabel) {
                treeLabel.textContent = nombre;
            }

            renderSubfolders('', '');
        }

        function agregarSubcarpeta(folderId) {
            var nombre = prompt('Nombre de la subcarpeta:');
            if (!nombre || !nombre.trim()) return;
            nombre = nombre.trim();

            var subId = folderId + '-' + nombre.toLowerCase().replace(/[^a-z0-9]+/gi, '-').replace(/(^-|-$)/g, '');
            var exists = document.querySelector('.repo-tree-sub[data-tree-sub="' + subId + '"]');
            if (exists) {
                alert('Ya existe una subcarpeta con ese nombre.');
                return;
            }

            repoSubNames[subId] = nombre;

            // Add to folder card (vista carpetas)
            var folderCard = document.querySelector('.repo-folder[data-folder-id="' + folderId + '"] .repo-folder-items');
            if (folderCard) {
                var span = document.createElement('span');
                span.setAttribute('data-sub', subId);
                span.setAttribute('onclick', "switchRepoView('files','" + folderId + "','" + subId + "')");
                span.innerHTML = '<i class="fas fa-file-alt"></i> ' + nombre + ' <span class="repo-sub-count" data-sub-count="' + subId + '">0</span>';
                folderCard.appendChild(span);
            }

            // Add to tree (vista archivos)
            var subs = document.querySelector('.repo-tree-subs[data-tree-subs="' + folderId + '"]');
            if (subs) {
                var subHtml =
                    '<div class="repo-tree-sub" data-tree-sub="' + subId + '" onclick="treeSelectFolder(\'' + folderId + '\',\'' + subId + '\')">' +
                        '<i class="fas fa-file-alt"></i> ' + nombre +
                        '<span class="tree-sub-count" data-tree-subcount="' + subId + '">0</span>' +
                        '<span class="sub-actions">' +
                            '<i class="fas fa-ellipsis-v menu-trigger" title="Opciones" onclick="event.stopPropagation(); toggleTreeMenu(this)"></i>' +
                            '<div class="context-menu">' +
                                '<button onclick="event.stopPropagation(); editarSubcarpeta(\'' + folderId + '\',\'' + subId + '\')"><i class="fas fa-edit"></i> Editar</button>' +
                                '<button onclick="event.stopPropagation(); eliminarSubcarpeta(\'' + folderId + '\',\'' + subId + '\')"><i class="fas fa-trash"></i> Eliminar</button>' +
                            '</div>' +
                        '</span>' +
                    '</div>';
                subs.insertAdjacentHTML('beforeend', subHtml);
                subs.classList.add('open');
            }

            updateTreeCounts();
            renderSubfolders(folderId, '');
        }

        function toggleTreeMenu(trigger) {
            document.querySelectorAll('.menu-trigger.active').forEach(function(el) {
                if (el !== trigger) el.classList.remove('active');
            });
            trigger.classList.toggle('active');
        }

        document.addEventListener('click', function() {
            document.querySelectorAll('.menu-trigger.active').forEach(function(el) {
                el.classList.remove('active');
            });
        });

        function editarSubcarpeta(folderId, subId) {
            var currentName = repoSubNames[subId] || subId;
            var nombre = prompt('Nuevo nombre de subcarpeta:', currentName);
            if (!nombre || !nombre.trim()) return;
            nombre = nombre.trim();

            repoSubNames[subId] = nombre;

            // Update folder card entry
            var cardItem = document.querySelector('.repo-folder[data-folder-id="' + folderId + '"] .repo-folder-items span[data-sub="' + subId + '"]');
            if (cardItem) {
                cardItem.innerHTML = '<i class="fas fa-file-alt"></i> ' + nombre + ' <span class="repo-sub-count" data-sub-count="' + subId + '">0</span>';
            }

            // Update tree label
            var subNode = document.querySelector('.repo-tree-sub[data-tree-sub="' + subId + '"]');
            if (subNode) {
                var countEl = subNode.querySelector('.tree-sub-count');
                var actions = subNode.querySelector('.sub-actions');
                subNode.innerHTML = '<i class="fas fa-file-alt"></i> ' + nombre;
                if (countEl) subNode.appendChild(countEl);
                if (actions) subNode.appendChild(actions);
            }

            renderSubfolders(folderId, '');
        }

        function eliminarSubcarpeta(folderId, subId) {
            var fileCount = document.querySelectorAll('#repoFilesBody tr[data-sub="' + subId + '"]').length;
            var msg = 'Eliminar subcarpeta "' + (repoSubNames[subId] || subId) + '"';
            if (fileCount > 0) {
                msg += ' y sus ' + fileCount + ' archivo(s)';
            }
            msg += '?';

            if (!confirm(msg)) return;

            // Remove files
            var files = document.querySelectorAll('#repoFilesBody tr[data-sub="' + subId + '"]');
            files.forEach(function(f) { f.remove(); });

            // Remove from folder card
            var cardItem = document.querySelector('.repo-folder[data-folder-id="' + folderId + '"] .repo-folder-items span[data-sub="' + subId + '"]');
            if (cardItem) cardItem.remove();

            // Remove from tree
            var subNode = document.querySelector('.repo-tree-sub[data-tree-sub="' + subId + '"]');
            if (subNode) subNode.remove();

            // Remove from map
            delete repoSubNames[subId];

            renumberRepoFiles();
            updateTreeCounts();
            renderSubfolders(folderId, '');
        }

        // Dropzone drag & drop
        var dropzone = document.getElementById('repoDropzone');
        if (dropzone) {
            dropzone.addEventListener('dragover', function(e) {
                e.preventDefault();
                dropzone.classList.add('dragover');
            });
            dropzone.addEventListener('dragleave', function() {
                dropzone.classList.remove('dragover');
            });
            dropzone.addEventListener('drop', function(e) {
                e.preventDefault();
                dropzone.classList.remove('dragover');
                // Use the current selected folder or default to bases
                var folder = currentUploadFolder || 'bases';
                currentUploadFolder = folder;
                var input = document.querySelector('.repo-folder-input[data-folder="' + folder + '"]');
                if (input) {
                    input.files = e.dataTransfer.files;
                    handleRepoUpload(input);
                }
            });
        }

        // Initialize sub-type counts
        updateAllSubCounts();
        updateTreeCounts();
        treeSelectFolder('', '');

        /* ========= Propuesta Técnica - Paso 4 ========= */

        var techSections = [
            { id: 'objetivos', title: 'Objetivos y alcance', group: 'Definición', icon: 'bullseye', enabled: true },
            { id: 'normas', title: 'Normas aplicables a los servicios', group: 'Definición', icon: 'book', enabled: true },
            { id: 'ubicacion', title: 'Ubicación del servicio', group: 'Definición', icon: 'map-marked-alt', enabled: true },
            { id: 'profesionales', title: 'Profesionales a cargo del servicio', group: 'Equipo', icon: 'users', enabled: true },
            { id: 'autorizaciones', title: 'Autorizaciones a solicitar', group: 'Gestión', icon: 'file-signature', enabled: true },
            { id: 'metodologias_fq', title: 'Componentes físico-químicos', group: 'Metodologías', icon: 'flask', enabled: true },
            { id: 'metodologias_bio', title: 'Componentes biológicos', group: 'Metodologías', icon: 'leaf', enabled: true },
            { id: 'metodologias_fis', title: 'Componentes físicos', group: 'Metodologías', icon: 'wind', enabled: true },
            { id: 'matrices', title: 'Matrices y puntos de muestreo', group: 'Muestreo', icon: 'map-marked-alt', enabled: true },
            { id: 'laboratorio', title: 'Análisis de laboratorio', group: 'Laboratorio', icon: 'flask', enabled: true },
            { id: 'terreno', title: 'Mediciones en terreno', group: 'Terreno', icon: 'hard-hat', enabled: true }
        ];

        var techCustomSections = [];
        var techTreeState = { expanded: {} };
        var techSectionOrder = techSections.map(function(s) { return s.id; });

        var techSectionFields = {
            objetivos: ['Objetivo del servicio', 'Alcance del servicio'],
            normas: ['Introducción', 'Normas aplicables'],
            ubicacion: ['Introducción', 'Mapa de ubicación'],
            profesionales: ['Introducción', 'Listado de profesionales'],
            autorizaciones: ['Introducción', 'Autorizaciones a solicitar'],
            metodologias_fq: ['Introducción', 'Protocolo de muestreo'],
            metodologias_bio: ['Resumen', 'Contenido'],
            metodologias_fis: ['Resumen', 'Contenido'],
            matrices: ['Listado de matrices', 'Puntos y frecuencia de muestreo', 'Condiciones de preservación'],
            laboratorio: ['Parámetros físico-químicos', 'Parámetros biológicos', 'Métodos analíticos y LOD/LOQ'],
            terreno: ['Mediciones in situ', 'Equipos y calibraciones', 'Registro y trazabilidad']
        };

        var techDrafts = {};
        var activeTechId = '';

        techDrafts.objetivos = {
            objetivo: 'La presente propuesta de licitación tiene como objetivo cautelar los diferentes alcances y requerimientos asociados al servicio, de manera que se efectúen con los más altos estándares de calidad, seguridad, ambiente y el nivel de cumplimiento de sus compromisos.\n\nUna vez adjudicado el servicio, Ecotecnos deberá desarrollar, ejecutar y cumplir todos aquellos trabajos, tareas, obligaciones, estudios, informes y requerimientos que se definen en el “Alcance del Servicio”, del presente documento.\n\nObjetivos específicos del PVA:\n- Conocer el efecto de la descarga causado por el Proyecto, a través de mediciones de las componentes de calidad de agua y biota marina;\n- Verificar el cumplimiento de las normas ambientales aplicables; y\n- Detectar de manera temprana cualquier efecto no previsto o no deseado, de modo que sea posible controlarlo, aplicando oportunamente las medidas o acciones pertinentes.',
            alcance: 'El Servicio que se solicita se entenderá en su más amplia acepción, e incluirá entre otros, aspectos administrativos, técnicos y de control de calidad permanente de sus servicios, y aquellos relacionados con el cumplimiento de la normativa ambiental vigente. En consecuencia, deberán contemplar todos los recursos para la obtención de resultados óptimos en la gestión que se les encomienda, no pudiendo en ningún caso condicionar su trabajo a aspectos que, a su juicio, no están contemplados en los presentes Términos de Referencia, que merezcan interpretación, u otras causas de orden similar.\n\nEsta Propuesta Técnica incluye las metodologías a utilizar para desarrollar levantamientos relacionados a la descripción del medio marino, tanto del medio físico como de los componentes ambientales que son objeto de protección (agua, biota y fondo marino), en la zona de estudio, asociadas al Programa de Vigilancia Ambiental.',
            updatedAt: ''
        };

        techDrafts.normas = {
            intro: 'Las normas aplicables a los servicios serán consideradas como marco de referencia para la ejecución, control de calidad y cumplimiento regulatorio de esta propuesta.',
            selected: [],
            updatedAt: ''
        };

        techDrafts.ubicacion = {
            intro: 'Los servicios serán realizados en la ciudad de Iquique, en la Región de Tarapacá, en las inmediaciones de APORT.',
            mapImage: '',
            mapName: '',
            mapCaption: '',
            updatedAt: ''
        };

        techDrafts.profesionales = {
            intro: 'Ecotecnos pone a disposición su staff de profesionales, asegurando la calidad de los estudios que se compromete a llevar a cabo.',
            selected: [],
            updatedAt: ''
        };

        techDrafts.autorizaciones = {
            intro: 'Se requerirá de las siguientes autorizaciones para la ejecución del servicio.',
            selected: [],
            updatedAt: ''
        };

        techDrafts.metodologias_fq = { intro: '', puntos: [], imagen: '', imagenName: '', descripcion: '', updatedAt: '' };
        techDrafts.metodologias_bio = { summary: '', content: '', notes: '', updatedAt: '' };
        techDrafts.metodologias_fis = { summary: '', content: '', notes: '', updatedAt: '' };

        var techProfesionalCatalog = [
            'Dr. Carlos Spano - Biólogo Marino. Dr. en Sistemática y Biodiversidad.',
            'Dr. Guillermo Feliú - Biólogo Marino. Dr. en Ciencias Ambientales.',
            'Alejandra Castro - Bióloga Marina. Especialista en comunidades bentónicas.',
            'Dra. Lissette Cárdenas - Bióloga Marina. Dra. en Biología y Ecología Aplicada.',
            'M. Sc. Daniela Contreras - Químico Industrial. M. Sc. en Oceanografía.',
            'Ricardo Castillo - Ingeniero Civil Oceánico.',
            'Dr. Ricardo Bravo - Dr. en Biología. Especialista en comunidades zooplanctónicas.',
            'Dr. Ítalo Masotti - Dr. en Biología. Especialista en comunidades fitoplanctónicas.'
        ];

        var techAutorizacionCatalog = [
            {
                name: 'Autorización SHOA',
                text: 'Se solicitará la autorización del Servicio Hidrográfico y Oceanográfico de la Armada de Chile (SHOA), de acuerdo con lo estipulado en el Decreto Supremo N° 711 de fecha 22 de agosto de 1975 “Reglamento de Control de las Investigaciones Científicas y Tecnológicas Marinas efectuadas en la Zona Marítima de Jurisdicción Nacional”.'
            },
            {
                name: 'Autorización SUBPESCA',
                text: 'En la actualidad la Subsecretaría de Pesca (SUBPESCA) se encuentra requiriendo la Solicitud de Pesca de Investigación, la cual será tramitada en este estudio. Para esto se utilizará el “Formulario para la Solicitud de Permisos de Pesca de Investigación correspondiente a Proyectos sometidos al Sistema de Evaluación de Impacto Ambiental”. Esto, en acuerdo al D.S. N° 430 de 1991 del Ministerio de Economía, Fomento y Reconstrucción, que establece los requisitos que deben cumplir las solicitudes de Pesca de Investigación.'
            }
        ];

        var techNormaCatalog = [
            'ISO 17025 - Requisitos generales para la competencia de los laboratorios de ensayo y calibración',
            'ISO 14001 - Sistemas de gestión ambiental',
            'ISO 9001 - Sistemas de gestión de la calidad',
            'NCh 1333 - Calidad del agua',
            'DS 90 - Norma de emisión para la regulación de contaminantes asociados a las descargas',
            'DS 46 - Norma de emisión para la regulación de contaminantes asociados a descargas al mar',
            'EPA 160.1 - Métodos de muestreo y preservación de agua',
            'EPA 200.7 - Determinación de metales por ICP'
        ];

        function getSectionById(id) {
            var all = techSections.concat(techCustomSections);
            return all.find(function(s) { return s.id === id; });
        }

        function getAllSections() {
            var all = techSections.concat(techCustomSections);
            if (!techSectionOrder || techSectionOrder.length === 0) return all;
            return techSectionOrder.map(function(id) {
                return all.find(function(s) { return s.id === id; });
            }).filter(Boolean);
        }

        function getSectionFields(section) {
            if (section.isCustom) return section.fields || [];
            return techSectionFields[section.id] || [];
        }

        function buildTechTree() {
            var tree = document.getElementById('techWikiTree');
            if (!tree) return;

            var html = '';
            getAllSections().forEach(function(section) {
                if (typeof techTreeState.expanded[section.id] === 'undefined') {
                    techTreeState.expanded[section.id] = section.id === activeTechId;
                }
                var active = section.id === activeTechId ? ' active' : '';
                var disabledClass = section.enabled === false ? ' disabled' : '';
                var expanded = techTreeState.expanded[section.id] ? ' open' : '';
                var fields = getSectionFields(section);
                var draggable = section.isCustom ? (section._editable ? 'false' : 'true') : 'true';
                html += '<div class="tech-tree-item' + active + disabledClass + '" data-tech-id="' + section.id + '" draggable="' + draggable + '">' +
                    '<button class="tech-tree-expand' + expanded + '" data-expand="' + section.id + '"><i class="fas fa-caret-right"></i></button>' +
                    '<i class="fas fa-folder"></i>' +
                    '<span class="tech-tree-name" data-tech-name="' + section.id + '">' + section.title + '</span>' +
                    (section.isCustom ? '<div class="tech-tree-menu" data-menu="' + section.id + '">' +
                        '<button class="tech-tree-menu-btn" data-menu-btn="' + section.id + '"><i class="fas fa-ellipsis-v"></i></button>' +
                        '<div class="tech-tree-menu-content">' +
                            '<button data-menu-edit="' + section.id + '"><i class="fas fa-pen"></i> Editar nombre</button>' +
                            '<button data-menu-add-field="' + section.id + '"><i class="fas fa-plus"></i> Agregar campo</button>' +
                            '<button data-menu-delete="' + section.id + '"><i class="fas fa-trash"></i> Eliminar sección</button>' +
                        '</div>' +
                    '</div>' : '') +
                    '<label class="tech-tree-toggle">' +
                        '<input type="checkbox" data-tech-toggle="' + section.id + '"' + (section.enabled === false ? '' : ' checked') + '>' +
                    '</label>' +
                '</div>';

                html += '<div class="tech-tree-fields" data-fields-for="' + section.id + '" style="display:' + (techTreeState.expanded[section.id] ? 'grid' : 'none') + ';">';
                if (fields.length === 0) {
                    html += '<div class="tech-editor-hint">Sin campos definidos.</div>';
                } else if (section.isCustom) {
                    fields.forEach(function(f) {
                        html += '<div class="tech-tree-field" draggable="true" data-field-parent="' + section.id + '" data-field-name="' + f + '">' +
                            '<i class="fas fa-file-alt" style="color:#b5b0a8;"></i>' +
                            '<span class="tech-tree-field-name" data-field-name-label="' + section.id + '">' + f + '</span>' +
                            '<div class="tech-tree-menu" data-menu-field="' + section.id + '" data-menu-field-name="' + f + '">' +
                                '<button class="tech-tree-menu-btn" data-menu-field-btn="' + section.id + '" data-menu-field-name="' + f + '"><i class="fas fa-ellipsis-v"></i></button>' +
                                '<div class="tech-tree-menu-content">' +
                                    '<button data-menu-field-edit="' + section.id + '" data-menu-field-name="' + f + '"><i class="fas fa-pen"></i> Editar</button>' +
                                    '<button data-menu-field-delete="' + section.id + '" data-menu-field-name="' + f + '"><i class="fas fa-trash"></i> Eliminar</button>' +
                                '</div>' +
                            '</div>' +
                        '</div>';
                    });
                } else {
                    fields.forEach(function(f) {
                        html += '<div class="tech-tree-field">' +
                            '<i class="fas fa-file-alt" style="color:#b5b0a8;"></i>' +
                            '<span>' + f + '</span>' +
                        '</div>';
                    });
                }
                if (section.isCustom) {
                    // add-field moved to contextual menu
                }
                html += '</div>';
            });

            tree.innerHTML = html ? '<div class="tech-tree-list">' + html + '</div>' : '<div class="tech-editor-hint" style="padding:10px 12px;">Sin resultados</div>';
            tree.querySelectorAll('.tech-tree-item[data-tech-id]').forEach(function(row) {
                row.addEventListener('click', function(e) {
                    if (e.target && (e.target.tagName === 'INPUT' || e.target.tagName === 'LABEL' || e.target.tagName === 'BUTTON' || e.target.tagName === 'I')) return;
                    var id = this.getAttribute('data-tech-id');
                    var section = getAllSections().find(function(s) { return s.id === id; });
                    if (section && section.enabled === false) return;
                    selectTechItem(this.getAttribute('data-tech-id'));
                });
            });

            tree.querySelectorAll('input[data-tech-toggle]').forEach(function(toggle) {
                toggle.addEventListener('change', function() {
                    var id = this.getAttribute('data-tech-toggle');
                    var section = getAllSections().find(function(s) { return s.id === id; });
                    if (!section) return;
                    section.enabled = this.checked;
                    if (!section.enabled && activeTechId === id) {
                        var next = getAllSections().find(function(s) { return s.enabled !== false; });
                        if (next) selectTechItem(next.id);
                    }
                    buildTechTree();
                    renderTechDocFull();
                });
            });

            tree.querySelectorAll('button[data-expand]').forEach(function(btn) {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    var id = this.getAttribute('data-expand');
                    techTreeState.expanded[id] = !techTreeState.expanded[id];
                    buildTechTree();
                });
            });

            tree.querySelectorAll('button[data-menu-btn]').forEach(function(btn) {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    var id = this.getAttribute('data-menu-btn');
                    tree.querySelectorAll('.tech-tree-menu.open').forEach(function(m) {
                        if (m.getAttribute('data-menu') !== id) m.classList.remove('open');
                    });
                    var menu = tree.querySelector('.tech-tree-menu[data-menu="' + id + '"]');
                    if (menu) menu.classList.toggle('open');
                });
            });

            tree.querySelectorAll('button[data-menu-edit]').forEach(function(btn) {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    var id = this.getAttribute('data-menu-edit');
                    var section = getAllSections().find(function(s) { return s.id === id; });
                    if (!section) return;
                    var nameEl = tree.querySelector('[data-tech-name="' + id + '"]');
                    if (!nameEl) return;
                    var input = document.createElement('input');
                    input.type = 'text';
                    input.value = section.title;
                    input.className = 'tech-map-caption-input';
                    nameEl.replaceWith(input);
                    input.focus();
                    function save() {
                        section.title = input.value.trim() || section.title;
                        if (section.isCustom) {
                            // enable dragging after edit
                            section._editable = false;
                        }
                        buildTechTree();
                        if (activeTechId === id) selectTechItem(id);
                    }
                    input.addEventListener('blur', save);
                    input.addEventListener('keydown', function(ev) {
                        if (ev.key === 'Enter') {
                            ev.preventDefault();
                            input.blur();
                        }
                    });
                });
            });

            tree.querySelectorAll('button[data-menu-add-field]').forEach(function(btn) {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    var id = this.getAttribute('data-menu-add-field');
                    var section = getAllSections().find(function(s) { return s.id === id; });
                    if (!section) return;
                    section.fields = section.fields || [];
                    section.fields.push('Nuevo campo');
                    techTreeState.expanded[id] = true;
                    buildTechTree();
                    if (activeTechId === id) selectTechItem(id);
                });
            });

            tree.querySelectorAll('button[data-menu-delete]').forEach(function(btn) {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    var id = this.getAttribute('data-menu-delete');
                    if (!confirm('Eliminar sección?')) return;
                    techCustomSections = techCustomSections.filter(function(s) { return s.id !== id; });
                    if (techSectionOrder) {
                        techSectionOrder = techSectionOrder.filter(function(sectionId) { return sectionId !== id; });
                    }
                    delete techDrafts[id];
                    if (activeTechId === id) activeTechId = '';
                    buildTechTree();
                    renderTechDocFull();
                });
            });

            tree.querySelectorAll('button[data-menu-field-btn]').forEach(function(btn) {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    var id = this.getAttribute('data-menu-field-btn');
                    var name = this.getAttribute('data-menu-field-name');
                    tree.querySelectorAll('.tech-tree-menu.open').forEach(function(m) {
                        if (m.getAttribute('data-menu-field') !== id || m.getAttribute('data-menu-field-name') !== name) {
                            m.classList.remove('open');
                        }
                    });
                    var menu = tree.querySelector('.tech-tree-menu[data-menu-field="' + id + '"][data-menu-field-name="' + name + '"]');
                    if (menu) menu.classList.toggle('open');
                });
            });

            tree.querySelectorAll('button[data-menu-field-edit]').forEach(function(btn) {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    var id = this.getAttribute('data-menu-field-edit');
                    var name = this.getAttribute('data-menu-field-name');
                    var section = getAllSections().find(function(s) { return s.id === id; });
                    if (!section) return;
                    var nameEl = tree.querySelector('.tech-tree-field[data-field-parent="' + id + '"][data-field-name="' + name + '"] .tech-tree-field-name');
                    if (!nameEl) return;
                    var input = document.createElement('input');
                    input.type = 'text';
                    input.value = name;
                    input.className = 'tech-map-caption-input';
                    nameEl.replaceWith(input);
                    input.focus();
                    function save() {
                        var fields = section.fields || [];
                        var index = fields.indexOf(name);
                        var newVal = input.value.trim() || name;
                        if (index >= 0) fields[index] = newVal;
                        if (techDrafts[id] && techDrafts[id].fields && name !== newVal) {
                            if (Object.prototype.hasOwnProperty.call(techDrafts[id].fields, name)) {
                                techDrafts[id].fields[newVal] = techDrafts[id].fields[name];
                                delete techDrafts[id].fields[name];
                            }
                        }
                        buildTechTree();
                        if (activeTechId === id) selectTechItem(id);
                    }
                    input.addEventListener('blur', save);
                    input.addEventListener('keydown', function(ev) {
                        if (ev.key === 'Enter') {
                            ev.preventDefault();
                            input.blur();
                        }
                    });
                });
            });

            tree.querySelectorAll('button[data-menu-field-delete]').forEach(function(btn) {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    var id = this.getAttribute('data-menu-field-delete');
                    var name = this.getAttribute('data-menu-field-name');
                    var section = getAllSections().find(function(s) { return s.id === id; });
                    if (!section) return;
                    section.fields = (section.fields || []).filter(function(f) { return f !== name; });
                    buildTechTree();
                    if (activeTechId === id) selectTechItem(id);
                });
            });

            // field delete handled by contextual menu

            document.addEventListener('click', function(e) {
                if (!e.target.closest('.tech-tree-menu')) {
                    document.querySelectorAll('.tech-tree-menu.open').forEach(function(m) {
                        m.classList.remove('open');
                    });
                }
            });

            tree.querySelectorAll('.tech-tree-item[draggable="true"]').forEach(function(row) {
                row.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('text/plain', JSON.stringify({ type: 'section', id: this.getAttribute('data-tech-id') }));
                });
                row.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.classList.add('tech-drag-over');
                });
                row.addEventListener('dragleave', function() {
                    this.classList.remove('tech-drag-over');
                });
                row.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('tech-drag-over');
                    var data = e.dataTransfer.getData('text/plain');
                    if (!data) return;
                    var payload = JSON.parse(data);
                    if (payload.type !== 'section') return;
                    var fromId = payload.id;
                    var toId = this.getAttribute('data-tech-id');
                    if (fromId === toId) return;
                    var order = techSectionOrder.slice();
                    var fromIndex = order.indexOf(fromId);
                    var toIndex = order.indexOf(toId);
                    if (fromIndex < 0 || toIndex < 0) return;
                    var moving = order[fromIndex];
                    order.splice(fromIndex, 1);
                    order.splice(toIndex, 0, moving);
                    techSectionOrder = order;
                    buildTechTree();
                    renderTechDocFull();
                });
            });

            tree.querySelectorAll('.tech-tree-item[draggable="false"]').forEach(function(row) {
                row.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.classList.add('tech-drag-over');
                });
                row.addEventListener('dragleave', function() {
                    this.classList.remove('tech-drag-over');
                });
                row.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('tech-drag-over');
                    var data = e.dataTransfer.getData('text/plain');
                    if (!data) return;
                    var payload = JSON.parse(data);
                    if (payload.type !== 'section') return;
                    var fromId = payload.id;
                    var toId = this.getAttribute('data-tech-id');
                    if (fromId === toId) return;
                    var order = techSectionOrder.slice();
                    var fromIndex = order.indexOf(fromId);
                    var toIndex = order.indexOf(toId);
                    if (fromIndex < 0 || toIndex < 0) return;
                    var moving = order[fromIndex];
                    order.splice(fromIndex, 1);
                    order.splice(toIndex, 0, moving);
                    techSectionOrder = order;
                    buildTechTree();
                    renderTechDocFull();
                });
                row.addEventListener('dragstart', function(e) {
                    e.preventDefault();
                });
            });


            tree.querySelectorAll('.tech-tree-field[draggable="true"]').forEach(function(row) {
                row.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('text/plain', JSON.stringify({
                        type: 'field',
                        parent: this.getAttribute('data-field-parent'),
                        name: this.getAttribute('data-field-name')
                    }));
                });
                row.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.classList.add('tech-drag-over');
                });
                row.addEventListener('dragleave', function() {
                    this.classList.remove('tech-drag-over');
                });
                row.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('tech-drag-over');
                    var data = e.dataTransfer.getData('text/plain');
                    if (!data) return;
                    var payload = JSON.parse(data);
                    if (payload.type !== 'field') return;
                    var parentId = this.getAttribute('data-field-parent');
                    if (payload.parent !== parentId) return;
                    var section = getAllSections().find(function(s) { return s.id === parentId; });
                    if (!section || !section.fields) return;
                    var fromIndex = section.fields.indexOf(payload.name);
                    var toName = this.getAttribute('data-field-name');
                    var toIndex = section.fields.indexOf(toName);
                    if (fromIndex < 0 || toIndex < 0 || fromIndex === toIndex) return;
                    var moving = section.fields[fromIndex];
                    section.fields.splice(fromIndex, 1);
                    section.fields.splice(toIndex, 0, moving);
                    buildTechTree();
                    if (activeTechId === parentId) selectTechItem(parentId);
                });
            });
        }

        function updateTechStatus(text) {
            var statusEl = document.getElementById('techEditorStatus');
            if (statusEl) statusEl.textContent = text;
        }

        function renderTechDocView() {
            var container = document.getElementById('techDocView');
            if (!container || !activeTechId) return;

            var section = getAllSections().find(function(s) { return s.id === activeTechId; });
            var title = section ? section.title : 'Sección';
            var draft = techDrafts[activeTechId] || {};

            if (activeTechId === 'objetivos') {
                container.innerHTML =
                    '<div class="tech-doc-title">Objetivo del servicio</div>' +
                    '<div class="tech-doc-text">' + (draft.objetivo || '—') + '</div>' +
                    '<div class="tech-doc-title">Alcance del servicio</div>' +
                    '<div class="tech-doc-text">' + (draft.alcance || '—') + '</div>';
                return;
            }

            if (activeTechId === 'normas') {
                var normas = (draft.selected || []);
                var normasHtml = normas.length
                    ? '<div class="tech-doc-list">' + normas.map(function(n) { return '<div>• ' + n + '</div>'; }).join('') + '</div>'
                    : '<div class="tech-doc-text">—</div>';
                container.innerHTML =
                    '<div class="tech-doc-text">' + (draft.intro || '—') + '</div>' +
                    '<div class="tech-doc-title">Normas aplicables</div>' +
                    normasHtml;
                return;
            }

            if (activeTechId === 'ubicacion') {
                var imgHtml = draft.mapImage
                    ? '<div class="tech-map-preview" style="margin-top:0;"><img src="' + draft.mapImage + '" alt="Mapa de ubicación"><div class="tech-map-meta">' + (draft.mapCaption || draft.mapName || '') + '</div></div>'
                    : '<div class="tech-doc-text">—</div>';
                container.innerHTML =
                    '<div class="tech-doc-text">' + (draft.intro || '—') + '</div>' +
                    '<div class="tech-doc-title">Mapa de ubicación</div>' +
                    imgHtml;
                return;
            }

            if (activeTechId === 'profesionales') {
                var items = draft.selected || [];
                var listHtml = items.length
                    ? '<div class="tech-doc-list">' + items.map(function(n, idx) { return '<div>' + (idx + 1) + '. ' + n + '</div>'; }).join('') + '</div>'
                    : '<div class="tech-doc-text">—</div>';
                container.innerHTML =
                    '<div class="tech-doc-text">' + (draft.intro || '—') + '</div>' +
                    '<div class="tech-doc-title">Profesionales</div>' +
                    listHtml;
                return;
            }

            if (activeTechId === 'autorizaciones') {
                var auths = draft.selected || [];
                var authHtml = auths.length
                    ? '<div class="tech-doc-list">' + auths.map(function(a, i) { return '<div>' + (i + 1) + '. <strong>' + a.name + '</strong>: ' + a.text + '</div>'; }).join('') + '</div>'
                    : '<div class="tech-doc-text">—</div>';
                container.innerHTML =
                    '<div class="tech-doc-text">' + (draft.intro || '—') + '</div>' +
                    '<div class="tech-doc-title">Autorizaciones</div>' +
                    authHtml;
                return;
            }


            if (activeTechId === 'metodologias_fq') {
                var puntos = draft.puntos || [];
                var tableHtml = '<table class="econ-table"><thead><tr><th>#</th><th>Nombre Estación</th><th>Lugar de Muestreo</th><th>Coordenadas Geográficas</th><th>Matriz</th></tr></thead><tbody>';
                if (puntos.length) {
                    puntos.forEach(function(p, i) {
                        tableHtml += '<tr><td>' + (i + 1) + '</td><td>' + (p.estacion || '—') + '</td><td>' + (p.lugar || '—') + '</td><td>' + (p.coordenadas || '—') + '</td><td>' + (p.matriz || '—') + '</td></tr>';
                    });
                } else {
                    tableHtml += '<tr><td colspan="5" style="text-align:center;color:#aaa;">Sin puntos de muestreo</td></tr>';
                }
                tableHtml += '</tbody></table>';
                var fqImgHtml = draft.imagen
                    ? '<div class="tech-doc-title">Imagen asociada</div><div class="tech-map-preview" style="margin-top:0;"><img src="' + draft.imagen + '" alt="Imagen protocolo FQ"></div>'
                    : '';
                container.innerHTML =
                    '<div class="tech-doc-text">' + (draft.intro || '—') + '</div>' +
                    '<div class="tech-doc-title">Protocolo de muestreo</div>' +
                    tableHtml +
                    fqImgHtml +
                    '<div class="tech-doc-title">Descripción</div>' +
                    '<div class="tech-doc-text">' + (draft.descripcion || '—') + '</div>';
                return;
            }

            if (section && section.isCustom) {
                var fields = section.fields || [];
                var fieldHtml = fields.map(function(f) {
                    var value = (draft.fields && draft.fields[f]) ? draft.fields[f] : '—';
                    return '<div class="tech-doc-title">' + f + '</div>' +
                        '<div class="tech-doc-text">' + value + '</div>';
                }).join('');
                container.innerHTML = fieldHtml || '<div class="tech-doc-text">—</div>';
                return;
            }

            container.innerHTML =
                '<div class="tech-doc-title">' + title + '</div>' +
                '<div class="tech-doc-text">' + (draft.summary || '—') + '</div>' +
                '<div class="tech-doc-title">Contenido</div>' +
                '<div class="tech-doc-text">' + (draft.content || '—') + '</div>';
        }

        function renderTechDocFull() {
            var container = document.getElementById('techDocFullContent');
            if (!container) return;
            var pagesHtml = '';

            getAllSections().filter(function(s) { return s.enabled !== false; }).forEach(function(section) {
                var draft = techDrafts[section.id] || {};
                var body = '';

                if (section.id === 'objetivos') {
                    body =
                        '<div class="tech-doc-title">Objetivo del servicio</div>' +
                        '<div class="tech-doc-text">' + (draft.objetivo || '—') + '</div>' +
                        '<div class="tech-doc-title">Alcance del servicio</div>' +
                        '<div class="tech-doc-text">' + (draft.alcance || '—') + '</div>';
                } else if (section.id === 'normas') {
                    var normas = (draft.selected || []);
                    var normasHtml = normas.length
                        ? '<div class="tech-doc-list">' + normas.map(function(n) { return '<div>• ' + n + '</div>'; }).join('') + '</div>'
                        : '<div class="tech-doc-text">—</div>';
                    body =
                        '<div class="tech-doc-text">' + (draft.intro || '—') + '</div>' +
                        '<div class="tech-doc-title">Normas aplicables</div>' +
                        normasHtml;
                } else if (section.id === 'ubicacion') {
                    var imgHtml = draft.mapImage
                        ? '<div class="tech-map-preview" style="margin-top:0;"><img src="' + draft.mapImage + '" alt="Mapa de ubicación"><div class="tech-map-meta">' + (draft.mapCaption || draft.mapName || '') + '</div></div>'
                        : '<div class="tech-doc-text">—</div>';
                    body =
                        '<div class="tech-doc-text">' + (draft.intro || '—') + '</div>' +
                        '<div class="tech-doc-title">Mapa de ubicación</div>' +
                        imgHtml;
                } else if (section.id === 'profesionales') {
                    var items = draft.selected || [];
                    var listHtml = items.length
                        ? '<div class="tech-doc-list">' + items.map(function(n, i) { return '<div>' + (i + 1) + '. ' + n + '</div>'; }).join('') + '</div>'
                        : '<div class="tech-doc-text">—</div>';
                    body =
                        '<div class="tech-doc-text">' + (draft.intro || '—') + '</div>' +
                        '<div class="tech-doc-title">Profesionales</div>' +
                        listHtml;
                } else if (section.id === 'autorizaciones') {
                    var auths = draft.selected || [];
                    var authHtml = auths.length
                        ? '<div class="tech-doc-list">' + auths.map(function(a, i) { return '<div>' + (i + 1) + '. <strong>' + a.name + '</strong>: ' + a.text + '</div>'; }).join('') + '</div>'
                        : '<div class="tech-doc-text">—</div>';
                    body =
                        '<div class="tech-doc-text">' + (draft.intro || '—') + '</div>' +
                        '<div class="tech-doc-title">Autorizaciones</div>' +
                        authHtml;
                } else if (section.id === 'metodologias_fq') {
                    var puntos = draft.puntos || [];
                    var tblHtml = '<table class="econ-table"><thead><tr><th>#</th><th>Nombre Estación</th><th>Lugar de Muestreo</th><th>Coordenadas Geográficas</th><th>Matriz</th></tr></thead><tbody>';
                    if (puntos.length) {
                        puntos.forEach(function(p, i) {
                            tblHtml += '<tr><td>' + (i + 1) + '</td><td>' + (p.estacion || '—') + '</td><td>' + (p.lugar || '—') + '</td><td>' + (p.coordenadas || '—') + '</td><td>' + (p.matriz || '—') + '</td></tr>';
                        });
                    } else {
                        tblHtml += '<tr><td colspan="5" style="text-align:center;color:#aaa;">Sin puntos de muestreo</td></tr>';
                    }
                    tblHtml += '</tbody></table>';
                    var fqFullImgHtml = draft.imagen
                        ? '<div class="tech-doc-title">Imagen asociada</div><div class="tech-map-preview" style="margin-top:0;"><img src="' + draft.imagen + '" alt="Imagen protocolo FQ"></div>'
                        : '';
                    body =
                        '<div class="tech-doc-text">' + (draft.intro || '—') + '</div>' +
                        '<div class="tech-doc-title">Protocolo de muestreo</div>' +
                        tblHtml +
                        fqFullImgHtml +
                        '<div class="tech-doc-title">Descripción</div>' +
                        '<div class="tech-doc-text">' + (draft.descripcion || '—') + '</div>';
                } else if (section.isCustom) {
                    var fields = section.fields || [];
                    var fieldHtml = fields.map(function(f) {
                        var value = (draft.fields && draft.fields[f]) ? draft.fields[f] : '—';
                        return '<div class="tech-doc-title">' + f + '</div>' +
                            '<div class="tech-doc-text">' + value + '</div>';
                    }).join('');
                    body = fieldHtml || '<div class="tech-doc-text">—</div>';
                } else {
                    body =
                        '<div class="tech-doc-title">Resumen</div>' +
                        '<div class="tech-doc-text">' + (draft.summary || '—') + '</div>' +
                        '<div class="tech-doc-title">Contenido</div>' +
                        '<div class="tech-doc-text">' + (draft.content || '—') + '</div>';
                }

                pagesHtml +=
                    '<div class="tech-doc-section">' +
                        '<div class="tech-doc-section-title">' + section.title + '</div>' +
                        body +
                    '</div>';
            });

            container.innerHTML = '<div class="tech-pdf">' + pagesHtml + '</div>';
        }

        function renderNormasList() {
            if (!techDrafts.normas) return;
            var selected = techDrafts.normas.selected || [];
            var normas = techNormaCatalog.slice();
            selected.forEach(function(norma) {
                if (normas.indexOf(norma) === -1) normas.push(norma);
            });
            updateNormasSelected();
        }

        function updateNormasSelected() {
            var label = document.getElementById('techNormasSelected');
            if (!label || !techDrafts.normas) return;
            var count = (techDrafts.normas.selected || []).length;
            label.textContent = 'Seleccionadas: ' + count;
            renderNormasSelectedList();
        }

        function renderNormasSelectedList() {
            if (!techDrafts.normas) return;
            var listEl = document.getElementById('techNormasSelectedList');
            if (!listEl) return;
            var selected = techDrafts.normas.selected || [];
            if (selected.length === 0) {
                listEl.innerHTML = '<div class="tech-editor-hint">No hay normas seleccionadas.</div>';
                return;
            }
            listEl.innerHTML = selected.map(function(norma, idx) {
                return '<div class="tech-norma-row">' +
                    '<span>' + norma + '</span>' +
                    '<button type="button" data-remove-norma="' + idx + '"><i class="fas fa-times"></i></button>' +
                '</div>';
            }).join('');

            listEl.querySelectorAll('button[data-remove-norma]').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var index = parseInt(this.getAttribute('data-remove-norma'), 10);
                    if (isNaN(index)) return;
                    selected.splice(index, 1);
                    techDrafts.normas.selected = selected;
                    updateNormasSelected();
                    updateTechStatus('Cambios sin guardar');
                });
            });
        }

        function renderProfesionalesList() {
            if (!techDrafts.profesionales) return;
            var listEl = document.getElementById('techProList');
            if (!listEl) return;
            var selected = techDrafts.profesionales.selected || [];
            if (selected.length === 0) {
                listEl.innerHTML = '<div class="tech-editor-hint">No hay profesionales seleccionados.</div>';
                return;
            }
            listEl.innerHTML = selected.map(function(item, idx) {
                return '<div class="tech-pro-item">' +
                    '<span>' + item + '</span>' +
                    '<button type="button" data-pro-index="' + idx + '"><i class="fas fa-times"></i></button>' +
                '</div>';
            }).join('');

            listEl.querySelectorAll('button[data-pro-index]').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var index = parseInt(this.getAttribute('data-pro-index'), 10);
                    if (isNaN(index)) return;
                    techDrafts.profesionales.selected.splice(index, 1);
                    renderProfesionalesList();
                    updateTechStatus('Cambios sin guardar');
                });
            });
        }

        function renderAutorizacionesList() {
            if (!techDrafts.autorizaciones) return;
            var listEl = document.getElementById('techAuthList');
            if (!listEl) return;
            var selected = techDrafts.autorizaciones.selected || [];
            if (selected.length === 0) {
                listEl.innerHTML = '<div class="tech-editor-hint">No hay autorizaciones seleccionadas.</div>';
                return;
            }
            listEl.innerHTML = selected.map(function(item, idx) {
                return '<div class="tech-auth-item">' +
                    '<div class="tech-auth-title">' + (idx + 1) + '. ' + item.name + '</div>' +
                    '<div class="tech-auth-text">' + item.text + '</div>' +
                    '<div class="tech-auth-actions">' +
                        '<button type="button" class="btn btn-default btn-sm" data-auth-index="' + idx + '"><i class="fas fa-trash"></i> Quitar</button>' +
                    '</div>' +
                '</div>';
            }).join('');

            listEl.querySelectorAll('button[data-auth-index]').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var index = parseInt(this.getAttribute('data-auth-index'), 10);
                    if (isNaN(index)) return;
                    techDrafts.autorizaciones.selected.splice(index, 1);
                    renderAutorizacionesList();
                    updateTechStatus('Cambios sin guardar');
                });
            });
        }

        function renderMetFQTable() {
            var tbody = document.getElementById('techMetFQTableBody');
            if (!tbody) return;
            var draft = techDrafts.metodologias_fq || {};
            var puntos = draft.puntos || [];
            tbody.innerHTML = '';
            if (puntos.length === 0) {
                for (var i = 0; i < 5; i++) {
                    puntos.push({ estacion: '', lugar: '', coordenadas: '', matriz: '' });
                }
                draft.puntos = puntos;
            }
            puntos.forEach(function(p, idx) {
                var tr = document.createElement('tr');
                tr.innerHTML =
                    '<td style="color:' + (idx % 2 === 0 ? '#c0a030' : '#66615b') + ';">' + (idx + 1) + '</td>' +
                    '<td><input type="text" class="form-control input-sm" value="' + (p.estacion || '') + '" data-fq-field="estacion" data-fq-idx="' + idx + '"></td>' +
                    '<td><input type="text" class="form-control input-sm" value="' + (p.lugar || '') + '" data-fq-field="lugar" data-fq-idx="' + idx + '"></td>' +
                    '<td><input type="text" class="form-control input-sm" value="' + (p.coordenadas || '') + '" data-fq-field="coordenadas" data-fq-idx="' + idx + '"></td>' +
                    '<td><input type="text" class="form-control input-sm" value="' + (p.matriz || '') + '" data-fq-field="matriz" data-fq-idx="' + idx + '"></td>' +
                    '<td><button class="btn btn-link btn-sm text-danger" data-fq-remove="' + idx + '" title="Eliminar"><i class="fas fa-times"></i></button></td>';
                tbody.appendChild(tr);
            });
            tbody.querySelectorAll('input[data-fq-field]').forEach(function(inp) {
                inp.addEventListener('input', function() {
                    var i = parseInt(this.getAttribute('data-fq-idx'));
                    var f = this.getAttribute('data-fq-field');
                    if (techDrafts.metodologias_fq.puntos[i]) {
                        techDrafts.metodologias_fq.puntos[i][f] = this.value;
                        updateTechStatus('Cambios sin guardar');
                        techDrafts.metodologias_fq.dirty = true;
                        renderTechDocFull();
                    }
                });
            });
            tbody.querySelectorAll('button[data-fq-remove]').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var i = parseInt(this.getAttribute('data-fq-remove'));
                    techDrafts.metodologias_fq.puntos.splice(i, 1);
                    updateTechStatus('Cambios sin guardar');
                    techDrafts.metodologias_fq.dirty = true;
                    renderMetFQTable();
                    renderTechDocFull();
                });
            });
        }

        function syncMetFQTableData() {
            var tbody = document.getElementById('techMetFQTableBody');
            if (!tbody) return;
            var draft = techDrafts.metodologias_fq;
            if (!draft || !draft.puntos) return;
            tbody.querySelectorAll('input[data-fq-field]').forEach(function(inp) {
                var i = parseInt(inp.getAttribute('data-fq-idx'));
                var f = inp.getAttribute('data-fq-field');
                if (draft.puntos[i]) {
                    draft.puntos[i][f] = inp.value;
                }
            });
        }

        function syncActiveDraft(markDirty) {
            if (!activeTechId) return;
            if (!techDrafts[activeTechId]) {
                techDrafts[activeTechId] = { summary: '', content: '', notes: '', updatedAt: '' };
            }

            var summaryEl = document.getElementById('techEditorSummary');
            var contentEl = document.getElementById('techEditorContent');
            var notesEl = document.getElementById('techEditorNotes');
            var objetivoEl = document.getElementById('techEditorObjetivo');
            var alcanceEl = document.getElementById('techEditorAlcance');
            var normasIntroEl = document.getElementById('techEditorNormasIntro');
            var ubicacionIntroEl = document.getElementById('techEditorUbicacionIntro');
            var mapCaptionInput = document.getElementById('techMapCaptionInput');
            var profesionalesIntroEl = document.getElementById('techEditorProfesionalesIntro');
            var autorizacionesIntroEl = document.getElementById('techEditorAutorizacionesIntro');
            if (activeTechId === 'objetivos') {
                techDrafts[activeTechId].objetivo = objetivoEl ? objetivoEl.value : '';
                techDrafts[activeTechId].alcance = alcanceEl ? alcanceEl.value : '';
            } else if (activeTechId === 'normas') {
                techDrafts[activeTechId].intro = normasIntroEl ? normasIntroEl.value : '';
            } else if (activeTechId === 'ubicacion') {
                techDrafts[activeTechId].intro = ubicacionIntroEl ? ubicacionIntroEl.value : '';
                techDrafts[activeTechId].mapCaption = mapCaptionInput ? mapCaptionInput.value : '';
            } else if (activeTechId === 'profesionales') {
                techDrafts[activeTechId].intro = profesionalesIntroEl ? profesionalesIntroEl.value : '';
            } else if (activeTechId === 'autorizaciones') {
                techDrafts[activeTechId].intro = autorizacionesIntroEl ? autorizacionesIntroEl.value : '';
            } else if (activeTechId === 'metodologias_fq') {
                var metFQIntroEl = document.getElementById('techEditorMetFQIntro');
                var metFQDescEl = document.getElementById('techEditorMetFQDesc');
                techDrafts[activeTechId].intro = metFQIntroEl ? metFQIntroEl.value : '';
                techDrafts[activeTechId].descripcion = metFQDescEl ? metFQDescEl.value : '';
                syncMetFQTableData();
            } else {
                techDrafts[activeTechId].summary = summaryEl ? summaryEl.value : '';
                techDrafts[activeTechId].content = contentEl ? contentEl.value : '';
                techDrafts[activeTechId].notes = notesEl ? notesEl.value : '';
            }

            if (markDirty) {
                techDrafts[activeTechId].dirty = true;
                updateTechStatus('Cambios sin guardar');
            }
            renderTechDocView();
            renderTechDocFull();
        }

        function selectTechItem(id) {
            if (!id) return;

            syncActiveDraft(false);
            activeTechId = id;

            var section = getAllSections().find(function(s) { return s.id === id; });
            var titleEl = document.getElementById('techEditorTitle');
            if (titleEl && section) titleEl.textContent = section.title;

            if (!techDrafts[id]) {
                techDrafts[id] = { summary: '', content: '', notes: '', updatedAt: '' };
            }

            var draft = techDrafts[id];
            var summaryEl = document.getElementById('techEditorSummary');
            var contentEl = document.getElementById('techEditorContent');
            var notesEl = document.getElementById('techEditorNotes');
            var objetivoEl = document.getElementById('techEditorObjetivo');
            var alcanceEl = document.getElementById('techEditorAlcance');
            var defaultFields = document.getElementById('techEditorDefaultFields');
            var objetivosFields = document.getElementById('techEditorObjetivosFields');
            var normasFields = document.getElementById('techEditorNormasFields');
            var normasIntroEl = document.getElementById('techEditorNormasIntro');
            var ubicacionFields = document.getElementById('techEditorUbicacionFields');
            var ubicacionIntroEl = document.getElementById('techEditorUbicacionIntro');
            var mapPreview = document.getElementById('techMapPreview');
            var mapImg = document.getElementById('techMapImg');
            var mapUpload = document.getElementById('techMapUpload');
            var mapCaptionText = document.getElementById('techMapCaptionText');
            var mapCaptionInput = document.getElementById('techMapCaptionInput');
            var profesionalesFields = document.getElementById('techEditorProfesionalesFields');
            var profesionalesIntroEl = document.getElementById('techEditorProfesionalesIntro');
            var autorizacionesFields = document.getElementById('techEditorAutorizacionesFields');
            var autorizacionesIntroEl = document.getElementById('techEditorAutorizacionesIntro');
            var metFQFields = document.getElementById('techEditorMetFQFields');
            var metFQIntroEl = document.getElementById('techEditorMetFQIntro');
            var customFields = document.getElementById('techEditorCustomFields');
            var customContainer = document.getElementById('techCustomFieldsContainer');

            if (activeTechId === 'objetivos') {
                if (defaultFields) defaultFields.style.display = 'none';
                if (objetivosFields) objetivosFields.style.display = '';
                if (normasFields) normasFields.style.display = 'none';
                if (ubicacionFields) ubicacionFields.style.display = 'none';
                if (profesionalesFields) profesionalesFields.style.display = 'none';
                if (autorizacionesFields) autorizacionesFields.style.display = 'none';
                if (metFQFields) metFQFields.style.display = 'none';
                if (customFields) customFields.style.display = 'none';
                if (objetivoEl) objetivoEl.value = draft.objetivo || '';
                if (alcanceEl) alcanceEl.value = draft.alcance || '';
            } else if (activeTechId === 'normas') {
                if (defaultFields) defaultFields.style.display = 'none';
                if (objetivosFields) objetivosFields.style.display = 'none';
                if (normasFields) normasFields.style.display = '';
                if (ubicacionFields) ubicacionFields.style.display = 'none';
                if (profesionalesFields) profesionalesFields.style.display = 'none';
                if (autorizacionesFields) autorizacionesFields.style.display = 'none';
                if (metFQFields) metFQFields.style.display = 'none';
                if (customFields) customFields.style.display = 'none';
                if (normasIntroEl) normasIntroEl.value = draft.intro || '';
                renderNormasList();
            } else if (activeTechId === 'ubicacion') {
                if (defaultFields) defaultFields.style.display = 'none';
                if (objetivosFields) objetivosFields.style.display = 'none';
                if (normasFields) normasFields.style.display = 'none';
                if (ubicacionFields) ubicacionFields.style.display = '';
                if (profesionalesFields) profesionalesFields.style.display = 'none';
                if (autorizacionesFields) autorizacionesFields.style.display = 'none';
                if (metFQFields) metFQFields.style.display = 'none';
                if (customFields) customFields.style.display = 'none';
                if (ubicacionIntroEl) ubicacionIntroEl.value = draft.intro || '';
                if (mapCaptionText) mapCaptionText.textContent = draft.mapCaption || draft.mapName || '';
                if (mapCaptionInput) mapCaptionInput.value = draft.mapCaption || draft.mapName || '';
                if (mapPreview && mapImg) {
                    if (draft.mapImage) {
                        mapImg.src = draft.mapImage;
                        mapPreview.style.display = '';
                        if (mapUpload) mapUpload.style.display = 'none';
                    } else {
                        mapPreview.style.display = 'none';
                        if (mapUpload) mapUpload.style.display = '';
                    }
                }
            } else if (activeTechId === 'profesionales') {
                if (defaultFields) defaultFields.style.display = 'none';
                if (objetivosFields) objetivosFields.style.display = 'none';
                if (normasFields) normasFields.style.display = 'none';
                if (ubicacionFields) ubicacionFields.style.display = 'none';
                if (profesionalesFields) profesionalesFields.style.display = '';
                if (autorizacionesFields) autorizacionesFields.style.display = 'none';
                if (metFQFields) metFQFields.style.display = 'none';
                if (customFields) customFields.style.display = 'none';
                if (profesionalesIntroEl) profesionalesIntroEl.value = draft.intro || '';
                renderProfesionalesList();
            } else if (activeTechId === 'autorizaciones') {
                if (defaultFields) defaultFields.style.display = 'none';
                if (objetivosFields) objetivosFields.style.display = 'none';
                if (normasFields) normasFields.style.display = 'none';
                if (ubicacionFields) ubicacionFields.style.display = 'none';
                if (profesionalesFields) profesionalesFields.style.display = 'none';
                if (autorizacionesFields) autorizacionesFields.style.display = '';
                if (metFQFields) metFQFields.style.display = 'none';
                if (customFields) customFields.style.display = 'none';
                if (autorizacionesIntroEl) autorizacionesIntroEl.value = draft.intro || '';
                renderAutorizacionesList();
            } else if (activeTechId === 'metodologias_fq') {
                if (defaultFields) defaultFields.style.display = 'none';
                if (objetivosFields) objetivosFields.style.display = 'none';
                if (normasFields) normasFields.style.display = 'none';
                if (ubicacionFields) ubicacionFields.style.display = 'none';
                if (profesionalesFields) profesionalesFields.style.display = 'none';
                if (autorizacionesFields) autorizacionesFields.style.display = 'none';
                if (metFQFields) metFQFields.style.display = '';
                if (customFields) customFields.style.display = 'none';
                if (metFQIntroEl) metFQIntroEl.value = draft.intro || '';
                var metFQDescEl = document.getElementById('techEditorMetFQDesc');
                if (metFQDescEl) metFQDescEl.value = draft.descripcion || '';
                var fqImgPreview = document.getElementById('techMetFQImgPreview');
                var fqImgUpload = document.getElementById('techMetFQImgUpload');
                var fqImgTag = document.getElementById('techMetFQImgTag');
                if (draft.imagen) {
                    if (fqImgTag) fqImgTag.src = draft.imagen;
                    if (fqImgPreview) fqImgPreview.style.display = '';
                    if (fqImgUpload) fqImgUpload.style.display = 'none';
                } else {
                    if (fqImgPreview) fqImgPreview.style.display = 'none';
                    if (fqImgUpload) fqImgUpload.style.display = '';
                }
                renderMetFQTable();
            } else if (section && section.isCustom) {
                if (defaultFields) defaultFields.style.display = 'none';
                if (objetivosFields) objetivosFields.style.display = 'none';
                if (normasFields) normasFields.style.display = 'none';
                if (ubicacionFields) ubicacionFields.style.display = 'none';
                if (profesionalesFields) profesionalesFields.style.display = 'none';
                if (autorizacionesFields) autorizacionesFields.style.display = 'none';
                if (metFQFields) metFQFields.style.display = 'none';
                if (customFields) customFields.style.display = '';
                if (customContainer) {
                    customContainer.innerHTML = (section.fields || []).map(function(field) {
                        var value = (draft.fields && draft.fields[field]) ? draft.fields[field] : '';
                        return '<div class="tech-custom-field">' +
                            '<label>' + field + '</label>' +
                            '<textarea class="form-control" rows="3" data-custom-field="' + field + '">' + value + '</textarea>' +
                        '</div>';
                    }).join('') || '<div class="tech-editor-hint">No hay campos definidos.</div>';
                    customContainer.querySelectorAll('textarea[data-custom-field]').forEach(function(el) {
                        el.addEventListener('input', function() {
                            if (!techDrafts[activeTechId].fields) techDrafts[activeTechId].fields = {};
                            techDrafts[activeTechId].fields[this.getAttribute('data-custom-field')] = this.value;
                            updateTechStatus('Cambios sin guardar');
                            renderTechDocFull();
                        });
                    });
                }
            } else {
                if (defaultFields) defaultFields.style.display = '';
                if (objetivosFields) objetivosFields.style.display = 'none';
                if (normasFields) normasFields.style.display = 'none';
                if (ubicacionFields) ubicacionFields.style.display = 'none';
                if (profesionalesFields) profesionalesFields.style.display = 'none';
                if (autorizacionesFields) autorizacionesFields.style.display = 'none';
                if (metFQFields) metFQFields.style.display = 'none';
                if (customFields) customFields.style.display = 'none';
                if (summaryEl) summaryEl.value = draft.summary || '';
                if (contentEl) contentEl.value = draft.content || '';
                if (notesEl) notesEl.value = draft.notes || '';
            }

            if (draft.updatedAt) {
                updateTechStatus('Guardado ' + draft.updatedAt);
            } else {
                updateTechStatus('Sin cambios');
            }

            buildTechTree();
            renderTechDocView();
        }

        document.addEventListener('DOMContentLoaded', function() {
            var summaryEl = document.getElementById('techEditorSummary');
            var contentEl = document.getElementById('techEditorContent');
            var notesEl = document.getElementById('techEditorNotes');
            var objetivoEl = document.getElementById('techEditorObjetivo');
            var alcanceEl = document.getElementById('techEditorAlcance');
            var normasIntroEl = document.getElementById('techEditorNormasIntro');
            var ubicacionIntroEl = document.getElementById('techEditorUbicacionIntro');
            var mapCaptionInput = document.getElementById('techMapCaptionInput');
            var profesionalesIntroEl = document.getElementById('techEditorProfesionalesIntro');
            var autorizacionesIntroEl = document.getElementById('techEditorAutorizacionesIntro');
            var metFQIntroEl = document.getElementById('techEditorMetFQIntro');
            [summaryEl, contentEl, notesEl, objetivoEl, alcanceEl, normasIntroEl, ubicacionIntroEl, mapCaptionInput, profesionalesIntroEl, autorizacionesIntroEl, metFQIntroEl].forEach(function(el) {
                if (!el) return;
                el.addEventListener('input', function() {
                    syncActiveDraft(true);
                });
            });

            var metFQAddBtn = document.getElementById('techMetFQAddRow');
            if (metFQAddBtn) {
                metFQAddBtn.addEventListener('click', function() {
                    if (!techDrafts.metodologias_fq.puntos) techDrafts.metodologias_fq.puntos = [];
                    techDrafts.metodologias_fq.puntos.push({ estacion: '', lugar: '', coordenadas: '', matriz: '' });
                    updateTechStatus('Cambios sin guardar');
                    techDrafts.metodologias_fq.dirty = true;
                    renderMetFQTable();
                    renderTechDocFull();
                });
            }

            var fqImgUploadDiv = document.getElementById('techMetFQImgUpload');
            var fqImgFileInput = document.getElementById('techMetFQImgInput');
            var fqImgRemoveBtn = document.getElementById('techMetFQImgRemove');
            if (fqImgUploadDiv && fqImgFileInput) {
                fqImgUploadDiv.addEventListener('click', function() { fqImgFileInput.click(); });
                fqImgFileInput.addEventListener('change', function() {
                    var file = this.files && this.files[0];
                    if (!file) return;
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        techDrafts.metodologias_fq.imagen = e.target.result;
                        techDrafts.metodologias_fq.imagenName = file.name;
                        techDrafts.metodologias_fq.dirty = true;
                        updateTechStatus('Cambios sin guardar');
                        var tag = document.getElementById('techMetFQImgTag');
                        var prev = document.getElementById('techMetFQImgPreview');
                        if (tag) tag.src = e.target.result;
                        if (prev) prev.style.display = '';
                        fqImgUploadDiv.style.display = 'none';
                        renderTechDocFull();
                    };
                    reader.readAsDataURL(file);
                });
            }
            if (fqImgRemoveBtn) {
                fqImgRemoveBtn.addEventListener('click', function() {
                    techDrafts.metodologias_fq.imagen = '';
                    techDrafts.metodologias_fq.imagenName = '';
                    techDrafts.metodologias_fq.dirty = true;
                    updateTechStatus('Cambios sin guardar');
                    var prev = document.getElementById('techMetFQImgPreview');
                    if (prev) prev.style.display = 'none';
                    if (fqImgUploadDiv) fqImgUploadDiv.style.display = '';
                    renderTechDocFull();
                });
            }

            var metFQDescEl = document.getElementById('techEditorMetFQDesc');
            if (metFQDescEl) {
                metFQDescEl.addEventListener('input', function() {
                    syncActiveDraft(true);
                });
            }

            var editBtn = document.getElementById('techViewEditBtn');
            var docBtn = document.getElementById('techViewDocBtn');
            var editView = document.getElementById('techViewEdit');
            var docView = document.getElementById('techViewDoc');
            var editShell = document.getElementById('techEditShell');
            var docFull = document.getElementById('techDocFull');
            function setTechView(mode) {
                if (!editView || !docView || !editBtn || !docBtn) return;
                if (mode === 'doc') {
                    editView.style.display = 'none';
                    docView.style.display = '';
                    editBtn.classList.remove('active');
                    docBtn.classList.add('active');
                    renderTechDocView();
                    if (editShell) editShell.style.display = 'none';
                    if (docFull) docFull.style.display = '';
                    renderTechDocFull();
                } else {
                    editView.style.display = '';
                    docView.style.display = 'none';
                    docBtn.classList.remove('active');
                    editBtn.classList.add('active');
                    if (editShell) editShell.style.display = '';
                    if (docFull) docFull.style.display = 'none';
                }
            }
            if (editBtn) editBtn.addEventListener('click', function() { setTechView('edit'); });
            if (docBtn) docBtn.addEventListener('click', function() { setTechView('doc'); });
            setTechView('edit');


            var btnSave = document.getElementById('techEditorSave');
            if (btnSave) {
                btnSave.addEventListener('click', function() {
                    if (!activeTechId) return;
                    syncActiveDraft(false);
                    var now = new Date();
                    var dateStr = ('0' + now.getDate()).slice(-2) + '-' + ('0' + (now.getMonth() + 1)).slice(-2) + '-' + now.getFullYear() + ' ' + ('0' + now.getHours()).slice(-2) + ':' + ('0' + now.getMinutes()).slice(-2);
                    techDrafts[activeTechId].updatedAt = dateStr;
                    techDrafts[activeTechId].dirty = false;
                    updateTechStatus('Guardado ' + dateStr);
                });
            }

            var btnClear = document.getElementById('techEditorClear');
            if (btnClear) {
                btnClear.addEventListener('click', function() {
                    if (!activeTechId) return;
                if (!confirm('Limpiar el contenido de esta sección?')) return;
                if (activeTechId === 'objetivos') {
                    techDrafts[activeTechId] = { objetivo: '', alcance: '', updatedAt: '' };
                } else if (activeTechId === 'normas') {
                    techDrafts[activeTechId] = { intro: '', normas: [], updatedAt: '' };
                } else if (activeTechId === 'metodologias_fq') {
                    techDrafts[activeTechId] = { intro: '', puntos: [], imagen: '', imagenName: '', descripcion: '', updatedAt: '' };
                } else {
                    techDrafts[activeTechId] = { summary: '', content: '', notes: '', updatedAt: '' };
                }
                    selectTechItem(activeTechId);
                    updateTechStatus('Sin cambios');
                });
            }

            var openModalBtn = document.getElementById('techOpenNormasModal');
            var modal = document.getElementById('normasModal');
            var modalClose = document.getElementById('normasModalClose');
            var modalSearch = document.getElementById('normasModalSearch');
            var modalList = document.getElementById('normasModalList');
            var modalApply = document.getElementById('normasModalApply');

            function renderNormasModalList(filterText) {
                if (!modalList) return;
                var filter = (filterText || '').toLowerCase().trim();
                var selected = techDrafts.normas ? (techDrafts.normas.selected || []) : [];
                var normas = techNormaCatalog.slice();
                selected.forEach(function(n) {
                    if (normas.indexOf(n) === -1) normas.push(n);
                });
                if (filter) {
                    normas = normas.filter(function(n) { return n.toLowerCase().indexOf(filter) !== -1; });
                }
                if (normas.length === 0) {
                    modalList.innerHTML = '<div class="tech-editor-hint">Sin resultados.</div>';
                    return;
                }
                modalList.innerHTML = normas.map(function(norma, idx) {
                    var checked = selected.indexOf(norma) !== -1 ? ' checked' : '';
                    return '<label class="simple-modal-item">' +
                        '<input type="checkbox" data-modal-norma="' + idx + '"' + checked + '>' +
                        '<span>' + norma + '</span>' +
                    '</label>';
                }).join('');

                modalList.querySelectorAll('input[type="checkbox"]').forEach(function(box) {
                    box.addEventListener('change', function() {
                        var index = parseInt(this.getAttribute('data-modal-norma'), 10);
                        if (isNaN(index)) return;
                        var norma = normas[index];
                        var pos = selected.indexOf(norma);
                        if (this.checked && pos === -1) selected.push(norma);
                        if (!this.checked && pos !== -1) selected.splice(pos, 1);
                        techDrafts.normas.selected = selected;
                        updateNormasSelected();
                        updateTechStatus('Cambios sin guardar');
                    });
                });
            }

            function openNormasModal() {
                if (!modal) return;
                modal.style.display = 'flex';
                if (modalSearch) modalSearch.value = '';
                renderNormasModalList('');
            }

            function closeNormasModal() {
                if (!modal) return;
                modal.style.display = 'none';
            }

            if (openModalBtn) {
                openModalBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    openNormasModal();
                });
            }
            if (modalClose) {
                modalClose.addEventListener('click', function() {
                    closeNormasModal();
                });
            }
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) closeNormasModal();
                });
            }
            if (modalSearch) {
                modalSearch.addEventListener('input', function() {
                    renderNormasModalList(this.value);
                });
            }
            if (modalApply) {
                modalApply.addEventListener('click', function() {
                    closeNormasModal();
                });
            }

            var authModalBtn = document.getElementById('techOpenAuthModal');
            var authModal = document.getElementById('autorizacionesModal');
            var authModalClose = document.getElementById('autorizacionesModalClose');
            var authModalSearch = document.getElementById('autorizacionesModalSearch');
            var authModalList = document.getElementById('autorizacionesModalList');
            var authModalApply = document.getElementById('autorizacionesModalApply');

            function renderAutorizacionesModalList(filterText) {
                if (!authModalList) return;
                var filter = (filterText || '').toLowerCase().trim();
                var selected = techDrafts.autorizaciones ? (techDrafts.autorizaciones.selected || []) : [];
                var items = techAutorizacionCatalog.slice();
                if (filter) {
                    items = items.filter(function(n) { return (n.name + ' ' + n.text).toLowerCase().indexOf(filter) !== -1; });
                }
                if (items.length === 0) {
                    authModalList.innerHTML = '<div class="tech-editor-hint">Sin resultados.</div>';
                    return;
                }
                authModalList.innerHTML = items.map(function(item, idx) {
                    var checked = selected.some(function(sel) { return sel.name === item.name; }) ? ' checked' : '';
                    return '<label class="simple-modal-item">' +
                        '<input type="checkbox" data-modal-auth="' + idx + '"' + checked + '>' +
                        '<span><strong>' + item.name + '</strong><br>' + item.text + '</span>' +
                    '</label>';
                }).join('');

                authModalList.querySelectorAll('input[type="checkbox"]').forEach(function(box) {
                    box.addEventListener('change', function() {
                        var index = parseInt(this.getAttribute('data-modal-auth'), 10);
                        if (isNaN(index)) return;
                        var auth = items[index];
                        var pos = selected.findIndex(function(sel) { return sel.name === auth.name; });
                        if (this.checked && pos === -1) selected.push(auth);
                        if (!this.checked && pos !== -1) selected.splice(pos, 1);
                        techDrafts.autorizaciones.selected = selected;
                        renderAutorizacionesList();
                        updateTechStatus('Cambios sin guardar');
                    });
                });
            }

            function openAutorizacionesModal() {
                if (!authModal) return;
                authModal.style.display = 'flex';
                if (authModalSearch) authModalSearch.value = '';
                renderAutorizacionesModalList('');
            }

            function closeAutorizacionesModal() {
                if (!authModal) return;
                authModal.style.display = 'none';
            }

            if (authModalBtn) {
                authModalBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    openAutorizacionesModal();
                });
            }
            if (authModalClose) {
                authModalClose.addEventListener('click', function() {
                    closeAutorizacionesModal();
                });
            }
            if (authModal) {
                authModal.addEventListener('click', function(e) {
                    if (e.target === authModal) closeAutorizacionesModal();
                });
            }
            if (authModalSearch) {
                authModalSearch.addEventListener('input', function() {
                    renderAutorizacionesModalList(this.value);
                });
            }
            if (authModalApply) {
                authModalApply.addEventListener('click', function() {
                    closeAutorizacionesModal();
                });
            }

            var addTopicBtn = document.getElementById('techAddTopicBtn');
            var customModal = document.getElementById('customTopicModal');
            var customModalClose = document.getElementById('customTopicModalClose');
            var customTitle = document.getElementById('customTopicTitle');
            var customFields = document.getElementById('customTopicFields');
            var customCancel = document.getElementById('customTopicCancel');
            var customCreate = document.getElementById('customTopicCreate');

            function openCustomModal() {
                if (!customModal) return;
                customModal.style.display = 'flex';
                if (customTitle) customTitle.value = '';
                if (customFields) customFields.value = '';
            }

            function closeCustomModal() {
                if (!customModal) return;
                customModal.style.display = 'none';
            }

            function slugify(text) {
                return (text || '')
                    .toLowerCase()
                    .replace(/[^a-z0-9]+/g, '-')
                    .replace(/(^-|-$)/g, '');
            }

            function createCustomTopic() {
                var title = (customTitle && customTitle.value || '').trim();
                var fieldsRaw = (customFields && customFields.value || '').trim();
                if (!title) return;
                var fields = fieldsRaw
                    ? fieldsRaw.split(/\r?\n|,/).map(function(f) { return f.trim(); }).filter(Boolean)
                    : [];
                var id = 'custom-' + slugify(title) + '-' + Date.now();
                techCustomSections.push({
                    id: id,
                    title: title,
                    group: 'Personalizado',
                    icon: 'file-alt',
                    enabled: true,
                    isCustom: true,
                    fields: fields
                });
                if (!techSectionOrder) techSectionOrder = [];
                techSectionOrder.push(id);
                techDrafts[id] = { fields: {} };
                techTreeState.expanded[id] = true;
                closeCustomModal();
                buildTechTree();
                selectTechItem(id);
            }

            function addQuickCustomTopic() {
                var id = 'custom-' + Date.now();
                techCustomSections.push({
                    id: id,
                    title: 'Nueva sección',
                    group: 'Personalizado',
                    icon: 'file-alt',
                    enabled: true,
                    isCustom: true,
                    fields: [],
                    _editable: true
                });
                if (!techSectionOrder) techSectionOrder = [];
                techSectionOrder.push(id);
                techDrafts[id] = { fields: {} };
                techTreeState.expanded[id] = true;
                buildTechTree();
                selectTechItem(id);
                var nameEl = document.querySelector('[data-tech-name="' + id + '"]');
                if (nameEl) {
                    var input = document.createElement('input');
                    input.type = 'text';
                    input.value = 'Nueva sección';
                    input.className = 'tech-map-caption-input';
                    nameEl.replaceWith(input);
                    input.focus();
                    input.select();
                    function save() {
                        var section = getAllSections().find(function(s) { return s.id === id; });
                        if (section) {
                            section.title = input.value.trim() || 'Nueva sección';
                            section._editable = false;
                        }
                        buildTechTree();
                        selectTechItem(id);
                    }
                    input.addEventListener('blur', save);
                    input.addEventListener('keydown', function(ev) {
                        if (ev.key === 'Enter') {
                            ev.preventDefault();
                            input.blur();
                        }
                    });
                }
            }

            if (addTopicBtn) addTopicBtn.addEventListener('click', function(e) {
                e.preventDefault();
                addQuickCustomTopic();
            });
            if (customModalClose) customModalClose.addEventListener('click', closeCustomModal);
            if (customCancel) customCancel.addEventListener('click', function(e) { e.preventDefault(); closeCustomModal(); });
            if (customCreate) customCreate.addEventListener('click', function(e) { e.preventDefault(); createCustomTopic(); });
            if (customModal) {
                customModal.addEventListener('click', function(e) {
                    if (e.target === customModal) closeCustomModal();
                });
            }

            var proModalBtn = document.getElementById('techOpenProModal');
            var proModal = document.getElementById('profesionalesModal');
            var proModalClose = document.getElementById('profesionalesModalClose');
            var proModalSearch = document.getElementById('profesionalesModalSearch');
            var proModalList = document.getElementById('profesionalesModalList');
            var proModalApply = document.getElementById('profesionalesModalApply');

            function renderProfesionalesModalList(filterText) {
                if (!proModalList) return;
                var filter = (filterText || '').toLowerCase().trim();
                var selected = techDrafts.profesionales ? (techDrafts.profesionales.selected || []) : [];
                var items = techProfesionalCatalog.slice();
                if (filter) {
                    items = items.filter(function(n) { return n.toLowerCase().indexOf(filter) !== -1; });
                }
                if (items.length === 0) {
                    proModalList.innerHTML = '<div class="tech-editor-hint">Sin resultados.</div>';
                    return;
                }
                proModalList.innerHTML = items.map(function(item, idx) {
                    var checked = selected.indexOf(item) !== -1 ? ' checked' : '';
                    return '<label class="simple-modal-item">' +
                        '<input type="checkbox" data-modal-pro="' + idx + '"' + checked + '>' +
                        '<span>' + item + '</span>' +
                    '</label>';
                }).join('');

                proModalList.querySelectorAll('input[type="checkbox"]').forEach(function(box) {
                    box.addEventListener('change', function() {
                        var index = parseInt(this.getAttribute('data-modal-pro'), 10);
                        if (isNaN(index)) return;
                        var pro = items[index];
                        var pos = selected.indexOf(pro);
                        if (this.checked && pos === -1) selected.push(pro);
                        if (!this.checked && pos !== -1) selected.splice(pos, 1);
                        techDrafts.profesionales.selected = selected;
                        renderProfesionalesList();
                        updateTechStatus('Cambios sin guardar');
                    });
                });
            }

            function openProfesionalesModal() {
                if (!proModal) return;
                proModal.style.display = 'flex';
                if (proModalSearch) proModalSearch.value = '';
                renderProfesionalesModalList('');
            }

            function closeProfesionalesModal() {
                if (!proModal) return;
                proModal.style.display = 'none';
            }

            if (proModalBtn) {
                proModalBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    openProfesionalesModal();
                });
            }
            if (proModalClose) {
                proModalClose.addEventListener('click', function() {
                    closeProfesionalesModal();
                });
            }
            if (proModal) {
                proModal.addEventListener('click', function(e) {
                    if (e.target === proModal) closeProfesionalesModal();
                });
            }
            if (proModalSearch) {
                proModalSearch.addEventListener('input', function() {
                    renderProfesionalesModalList(this.value);
                });
            }
            if (proModalApply) {
                proModalApply.addEventListener('click', function() {
                    closeProfesionalesModal();
                });
            }

            var mapUpload = document.getElementById('techMapUpload');
            var mapInput = document.getElementById('techMapInput');
            var mapPreview = document.getElementById('techMapPreview');
            var mapImg = document.getElementById('techMapImg');
            var mapRemoveBtn = document.getElementById('techMapRemoveBtn');
            var mapCaptionText = document.getElementById('techMapCaptionText');
            var mapCaptionInput = document.getElementById('techMapCaptionInput');
            var mapCaptionEdit = document.getElementById('techMapCaptionEdit');
            if (mapUpload && mapInput) {
                mapUpload.addEventListener('click', function() {
                    mapInput.click();
                });
            }
            if (mapInput) {
                mapInput.addEventListener('change', function() {
                    if (!this.files || this.files.length === 0) return;
                    var file = this.files[0];
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        if (!techDrafts.ubicacion) return;
                        techDrafts.ubicacion.mapImage = e.target.result;
                        techDrafts.ubicacion.mapName = file.name;
                        if (mapImg) mapImg.src = e.target.result;
                        if (mapCaptionText) mapCaptionText.textContent = techDrafts.ubicacion.mapCaption || file.name;
                        if (mapCaptionInput) mapCaptionInput.value = techDrafts.ubicacion.mapCaption || file.name;
                        if (mapPreview) mapPreview.style.display = '';
                        if (mapUpload) mapUpload.style.display = 'none';
                        updateTechStatus('Cambios sin guardar');
                    };
                    reader.readAsDataURL(file);
                });
            }
            if (mapRemoveBtn) {
                mapRemoveBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (!techDrafts.ubicacion) return;
                    techDrafts.ubicacion.mapImage = '';
                    techDrafts.ubicacion.mapName = '';
                    techDrafts.ubicacion.mapCaption = '';
                    if (mapImg) mapImg.src = '';
                    if (mapPreview) mapPreview.style.display = 'none';
                    if (mapCaptionText) mapCaptionText.textContent = '';
                    if (mapCaptionInput) mapCaptionInput.value = '';
                    if (mapUpload) mapUpload.style.display = '';
                    if (mapInput) mapInput.value = '';
                    updateTechStatus('Cambios sin guardar');
                });
            }
            if (mapCaptionEdit && mapCaptionInput && mapCaptionText) {
                mapCaptionEdit.addEventListener('click', function(e) {
                    e.preventDefault();
                    mapCaptionInput.style.display = '';
                    mapCaptionText.style.display = 'none';
                    mapCaptionEdit.style.display = 'none';
                    mapCaptionInput.focus();
                });
                mapCaptionInput.addEventListener('blur', function() {
                    var value = (mapCaptionInput.value || '').trim();
                    techDrafts.ubicacion.mapCaption = value;
                    mapCaptionText.textContent = value || (techDrafts.ubicacion.mapName || '');
                    mapCaptionText.style.display = '';
                    mapCaptionEdit.style.display = '';
                    mapCaptionInput.style.display = 'none';
                    updateTechStatus('Cambios sin guardar');
                });
                mapCaptionInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        mapCaptionInput.blur();
                    }
                });
            }

            buildTechTree();
            if (techSections.length > 0) {
                selectTechItem(techSections[0].id);
            }
        });

        /* ========= Aprobaci\u00f3n - Paso 6 ========= */

        // Registrar env\u00edo de propuesta
        function registrarEnvioPropuesta() {
            var today = new Date();
            var dateStr = ('0' + today.getDate()).slice(-2) + '-' + ('0' + (today.getMonth() + 1)).slice(-2) + '-' + today.getFullYear() + ' ' + ('0' + today.getHours()).slice(-2) + ':' + ('0' + today.getMinutes()).slice(-2);
            document.getElementById('propEnvioFecha').textContent = dateStr;
            document.getElementById('propEnvioUsuario').textContent = 'Cristian Toro';
            document.getElementById('propEnvioEmail').textContent = 'destinatario@cliente.cl';
            document.getElementById('notifPropPending').style.display = 'none';
            document.getElementById('notifPropSent').style.display = '';
        }

        function verComprobante() {
            alert('Abriendo comprobante de env\u00edo...');
        }

        // Upload de archivo de comprobante de envío
        var inputComprobanteFile = document.getElementById('inputComprobanteFile');
        var btnSeleccionarComprobante = document.getElementById('btnSeleccionarComprobante');
        var uploadComprobanteArea = document.getElementById('uploadComprobante');
        var uploadedComprobante = document.getElementById('uploadedComprobante');

        if (btnSeleccionarComprobante) {
            btnSeleccionarComprobante.addEventListener('click', function(e) {
                e.stopPropagation();
                inputComprobanteFile.click();
            });
        }

        if (uploadComprobanteArea) {
            uploadComprobanteArea.addEventListener('click', function() {
                inputComprobanteFile.click();
            });
            uploadComprobanteArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.style.borderColor = '#ef8157';
                this.style.background = '#fef6f3';
            });
            uploadComprobanteArea.addEventListener('dragleave', function() {
                this.style.borderColor = '';
                this.style.background = '';
            });
            uploadComprobanteArea.addEventListener('drop', function(e) {
                e.preventDefault();
                this.style.borderColor = '';
                this.style.background = '';
                if (e.dataTransfer.files.length > 0) {
                    showComprobanteFile(e.dataTransfer.files[0]);
                }
            });
        }

        if (inputComprobanteFile) {
            inputComprobanteFile.addEventListener('change', function() {
                if (this.files.length > 0) {
                    showComprobanteFile(this.files[0]);
                }
            });
        }

        function showComprobanteFile(file) {
            var ext = file.name.split('.').pop().toLowerCase();
            var iconClass = 'fa-file-alt';
            if (ext === 'pdf') iconClass = 'fa-file-pdf';
            else if (ext === 'doc' || ext === 'docx') iconClass = 'fa-file-word';
            else if (ext === 'xls' || ext === 'xlsx') iconClass = 'fa-file-excel';
            else if (ext === 'jpg' || ext === 'png' || ext === 'jpeg') iconClass = 'fa-file-image';
            else if (ext === 'msg' || ext === 'eml') iconClass = 'fa-envelope';

            var iconEl = document.getElementById('comprobanteFileIcon');
            iconEl.className = 'fas ' + iconClass + ' file-icon';
            if (ext === 'msg' || ext === 'eml') iconEl.style.color = '#51bcda';
            else iconEl.style.color = '';

            document.getElementById('comprobanteFileName').textContent = file.name;
            var today = new Date();
            document.getElementById('comprobanteFileDate').textContent = ('0' + today.getDate()).slice(-2) + '-' + ('0' + (today.getMonth() + 1)).slice(-2) + '-' + today.getFullYear();
            document.getElementById('comprobanteFileUser').textContent = 'Cristian Toro';

            uploadComprobanteArea.style.display = 'none';
            uploadedComprobante.style.display = '';
        }

        function removeComprobanteFile() {
            uploadComprobanteArea.style.display = '';
            uploadedComprobante.style.display = 'none';
            inputComprobanteFile.value = '';
        }

        function downloadComprobanteFile() {
            alert('Descargando comprobante...');
        }

        // Upload de archivo de resultado
        var inputResultadoFile = document.getElementById('inputResultadoFile');
        var btnSeleccionarResultado = document.getElementById('btnSeleccionarResultado');
        var uploadResultadoArea = document.getElementById('uploadResultado');
        var uploadedResultado = document.getElementById('uploadedResultado');

        if (btnSeleccionarResultado) {
            btnSeleccionarResultado.addEventListener('click', function(e) {
                e.stopPropagation();
                inputResultadoFile.click();
            });
        }

        if (uploadResultadoArea) {
            uploadResultadoArea.addEventListener('click', function() {
                inputResultadoFile.click();
            });
            uploadResultadoArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.style.borderColor = '#ef8157';
                this.style.background = '#fef6f3';
            });
            uploadResultadoArea.addEventListener('dragleave', function() {
                this.style.borderColor = '';
                this.style.background = '';
            });
            uploadResultadoArea.addEventListener('drop', function(e) {
                e.preventDefault();
                this.style.borderColor = '';
                this.style.background = '';
                if (e.dataTransfer.files.length > 0) {
                    showResultadoFile(e.dataTransfer.files[0]);
                }
            });
        }

        if (inputResultadoFile) {
            inputResultadoFile.addEventListener('change', function() {
                if (this.files.length > 0) {
                    showResultadoFile(this.files[0]);
                }
            });
        }

        function showResultadoFile(file) {
            var ext = file.name.split('.').pop().toLowerCase();
            var iconClass = 'fa-file-alt';
            if (ext === 'pdf') iconClass = 'fa-file-pdf';
            else if (ext === 'doc' || ext === 'docx') iconClass = 'fa-file-word';
            else if (ext === 'xls' || ext === 'xlsx') iconClass = 'fa-file-excel';
            else if (ext === 'jpg' || ext === 'png' || ext === 'jpeg') iconClass = 'fa-file-image';
            else if (ext === 'msg' || ext === 'eml') iconClass = 'fa-envelope';

            var iconEl = document.getElementById('resultFileIcon');
            iconEl.className = 'fas ' + iconClass + ' file-icon';
            if (ext === 'msg' || ext === 'eml') iconEl.style.color = '#51bcda';
            else iconEl.style.color = '';

            document.getElementById('resultFileName').textContent = file.name;
            var today = new Date();
            document.getElementById('resultFileDate').textContent = ('0' + today.getDate()).slice(-2) + '-' + ('0' + (today.getMonth() + 1)).slice(-2) + '-' + today.getFullYear();
            document.getElementById('resultFileUser').textContent = 'Cristian Toro';

            uploadResultadoArea.style.display = 'none';
            uploadedResultado.style.display = '';
        }

        function removeResultadoFile() {
            uploadResultadoArea.style.display = '';
            uploadedResultado.style.display = 'none';
            inputResultadoFile.value = '';
        }

        function downloadResultadoFile() {
            alert('Descargando archivo...');
        }
    </script>
</body>
</html>
