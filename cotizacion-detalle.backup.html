<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGS - Creación de Cotización</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', 'Helvetica Neue', Arial, sans-serif;
            font-size: 14px;
            color: #2c2c2c;
            background-color: #f4f3ef;
        }

        .wrapper {
            display: flex;
            min-height: 100vh;
        }

        /* SIDEBAR */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 260px;
            background: linear-gradient(to bottom, #5a5a5a 0%, #3c3c3c 100%);
            z-index: 1000;
        }

        .sidebar .logo {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar .logo-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .sidebar .logo-top-line {
            width: 80px;
            height: 4px;
            background: #ef8157;
            margin-bottom: 5px;
        }

        .sidebar .logo-text {
            font-size: 32px;
            font-weight: 700;
            color: #fff;
            letter-spacing: 2px;
        }

        .sidebar .user {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar .user-name {
            color: #fff;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sidebar .app-version {
            color: rgba(255,255,255,0.5);
            font-size: 11px;
            margin-top: 5px;
        }

        .sidebar .nav {
            list-style: none;
            padding: 15px 0;
        }

        .sidebar .nav li {
            margin: 2px 15px;
        }

        .sidebar .nav li a {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s;
        }

        .sidebar .nav li a:hover {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }

        .sidebar .nav li.active a {
            color: #ef8157;
        }

        .sidebar .nav li a i {
            width: 30px;
            font-size: 16px;
            text-align: center;
            margin-right: 10px;
        }

        /* MAIN PANEL */
        .main-panel {
            width: calc(100% - 260px);
            margin-left: 260px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* PAGE HEADER */
        .page-header {
            background: #fff;
            padding: 20px 30px;
            border-bottom: 1px solid #e9e9e9;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .page-header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .page-header .header-icon {
            width: 30px;
            height: 30px;
            background: #ef8157;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 14px;
        }

        .page-header h1 {
            font-size: 18px;
            font-weight: 400;
            color: #66615b;
            margin: 0;
        }

        /* Company Switcher */
        .company-switcher {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .company-switcher label {
            font-size: 12px;
            font-weight: 500;
            color: #66615b;
        }

        .company-select {
            padding: 8px 35px 8px 12px;
            font-size: 13px;
            font-weight: 500;
            color: #fff;
            background: #ef8157;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            min-width: 150px;
        }

        .company-select:hover {
            background-color: #e5734a;
        }

        .company-select option {
            background: #fff;
            color: #66615b;
        }

        /* CONTENT */
        .content {
            flex: 1;
            padding: 30px;
        }

        .card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            padding: 25px;
            margin-bottom: 20px;
        }

        /* BUTTONS */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s;
        }

        .btn-default {
            background: #66615b;
            color: #fff;
        }

        .btn-default:hover {
            background: #524d48;
        }

        .btn-success {
            background: #6bd098;
            color: #fff;
        }

        .btn-success:hover {
            background: #59c786;
        }

        .btn-warning {
            background: #fbc658;
            color: #fff;
        }

        .btn-warning:hover {
            background: #fab526;
        }

        .btn-danger {
            background: #ef8157;
            color: #fff;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 11px;
        }

        /* FORM */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: #66615b;
            margin-bottom: 8px;
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            font-size: 14px;
            color: #66615b;
            background: #f7f7f7;
            border: 1px solid #e8e8e8;
            border-radius: 4px;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: #ccc;
            background: #fff;
        }

        .form-control:disabled {
            background: #e9e9e9;
            cursor: not-allowed;
        }

        select.form-control {
            cursor: pointer;
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        .row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -15px;
        }

        .col-md-2, .col-md-3, .col-md-4, .col-md-5, .col-md-6, .col-md-12 {
            padding: 0 15px;
        }

        .col-md-2 { flex: 0 0 16.666667%; max-width: 16.666667%; }
        .col-md-3 { flex: 0 0 25%; max-width: 25%; }
        .col-md-4 { flex: 0 0 33.333333%; max-width: 33.333333%; }
        .col-md-5 { flex: 0 0 41.666667%; max-width: 41.666667%; }
        .col-md-6 { flex: 0 0 50%; max-width: 50%; }
        .col-md-12 { flex: 0 0 100%; max-width: 100%; }

        /* STEPPER / PROGRESS */
        .stepper {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            padding: 20px 0;
            border-bottom: 1px solid #e9e9e9;
        }

        .stepper-item {
            flex: 1;
            text-align: center;
            position: relative;
        }

        .stepper-item.completed,
        .stepper-item.active {
            cursor: pointer;
        }

        .stepper-item::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 50%;
            width: 100%;
            height: 2px;
            background: #e9e9e9;
            z-index: 1;
        }

        .stepper-item.viewing::before {
            background: #ef8157;
        }

        .stepper-item.completed::before {
            background: #6bd098;
        }

        .stepper-item:last-child::before {
            display: none;
        }

        .stepper-number {
            width: 30px;
            height: 30px;
            background: #e9e9e9;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            color: #66615b;
            position: relative;
            z-index: 2;
            margin-bottom: 8px;
        }

        .stepper-item.active .stepper-number {
            background: #ef8157;
            color: #fff;
        }

        .stepper-item.viewing .stepper-number {
            box-shadow: 0 0 0 3px rgba(239, 129, 87, 0.18);
            border-color: #ef8157;
        }

        .stepper-item.completed .stepper-number {
            background: #6bd098;
            color: transparent;
        }

        .stepper-item.completed .stepper-number::after {
            content: '\f00c';
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            position: absolute;
            color: #fff;
            font-size: 12px;
        }

        .stepper-label {
            font-size: 11px;
            font-weight: 600;
            color: #66615b;
            text-transform: uppercase;
        }

        .stepper-item.active .stepper-label {
            color: #ef8157;
            font-weight: 700;
            font-size: 13px;
        }

        .stepper-item.viewing .stepper-label {
            color: #c86b49;
            font-weight: 700;
            font-size: 13px;
        }

        /* SECTION TITLE */
        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #66615b;
            margin-top: 35px;
            margin-bottom: 20px;
        }

        .section-title i {
            margin-right: 10px;
            color: #ef8157;
        }

        .service-section {
            border: 1px solid #ece6de;
            background: #fffdfb;
            border-radius: 16px;
            padding: 16px 18px 18px;
            margin-bottom: 18px;
            box-shadow: 0 10px 24px rgba(0, 0, 0, 0.04);
        }

        .service-section-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 14px;
        }

        .service-section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
            font-weight: 700;
            color: #5e5e5e;
        }

        .service-section-title i {
            color: #ef8157;
        }

        .service-section-desc {
            margin-top: 4px;
            font-size: 12px;
            color: #9a9a9a;
        }

        .service-section-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Step 2 dummy services */
        .service-group {
            border: 1px solid #e7e4df;
            border-radius: 8px;
            margin-bottom: 24px;
            overflow: hidden;
            background: #fff;
        }

        .service-group-header {
            background: #e5e3e1;
            padding: 10px 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            font-weight: 600;
        }

        .service-group-header .group-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .service-group-header .group-actions i {
            margin-left: 10px;
            cursor: pointer;
        }

        .service-group-header .group-actions {
            display: flex;
            align-items: center;
            gap: 18px;
        }

        .service-group-header .group-actions i + i {
            margin-left: 2px;
        }

        .service-group-header .group-actions .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding-left: 10px;
            padding-right: 12px;
        }

        .group-edit-input {
            width: 100%;
            max-width: 420px;
            border: 1px solid #ece8e2;
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 13px;
            background: #fdfbf8;
            outline: none;
            box-shadow: none;
        }

        .group-edit-input:focus {
            border-color: #ef8157;
            box-shadow: 0 0 0 2px rgba(239, 129, 87, 0.15);
        }

        .group-edit-actions i {
            margin-left: 8px;
            cursor: pointer;
            color: #66615b;
        }

        .group-edit-actions i[data-action="save"] {
            color: #2fa06f;
        }

        .group-edit-actions i[data-action="cancel"] {
            color: #c05b4d;
        }

        .service-tags {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            padding: 6px 14px 0;
        }

        #divDetalleServicioMuestreo .service-tags {
            padding: 2px 0 0;
            margin-top: 2px;
            flex-wrap: nowrap;
            overflow: hidden;
        }

        #divDetalleServicioMuestreo .service-tag {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
        }

        #divDetalleServicioMuestreo td {
            vertical-align: middle;
        }

        #divDetalleServicioMuestreo .muestreo-duplicate {
            color: #9a9a9a;
            margin-left: 8px;
            cursor: pointer;
            font-size: 13px;
        }

        #divDetalleServicioMuestreo .muestreo-duplicate:hover {
            color: #66615b;
        }

        #divDetalleServicioMuestreo tr.is-editing {
            background: #fff8ef;
        }

        #divDetalleServicioMuestreo tr.is-editing .muestreo-edit-row {
            color: #2fa06f;
        }

        #divDetalleServicioMuestreo .muestreo-name {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #444;
        }

        #divDetalleServicioMuestreo .muestreo-name-edit {
            font-size: 12px;
            padding: 3px 6px;
            border-radius: 8px;
            border: 1px solid #e5e0db;
            background: #fff;
            max-width: 260px;
        }

        #divDetalleServicioMuestreo .muestreo-code {
            font-size: 10px;
            color: #9a9a9a;
            margin-left: auto;
        }

        #divDetalleServicioMuestreo .muestreo-cell-input {
            width: 70px;
            text-align: right;
            border: 1px solid #e5e0db;
            border-radius: 8px;
            padding: 2px 6px;
            font-size: 12px;
            background: #fff;
        }

        #divDetalleServicioMuestreo .table-lct th,
        #divDetalleServicioMuestreo .table-lct td,
        #divDetalleServicioMon .table-lct th,
        #divDetalleServicioMon .table-lct td {
            padding: 6px 8px;
            font-size: 12px;
            line-height: 1.2;
        }

        #divDetalleServicioMon .service-tags {
            padding: 2px 0 0;
            margin-top: 2px;
            flex-wrap: nowrap;
            overflow: hidden;
        }

        #divDetalleServicioMon .service-tag {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
        }

        #divDetalleServicioMon td {
            vertical-align: middle;
        }

        #divDetalleServicioMon .muestreo-duplicate {
            color: #9a9a9a;
            margin-left: 8px;
            cursor: pointer;
            font-size: 13px;
        }

        #divDetalleServicioMon .muestreo-duplicate:hover {
            color: #66615b;
        }

        #divDetalleServicioMon tr.is-editing {
            background: #fff8ef;
        }

        #divDetalleServicioMon tr.is-editing .otros-edit-row {
            color: #2fa06f;
        }

        #divDetalleServicioMon .muestreo-name {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #444;
        }

        #divDetalleServicioMon .muestreo-name-edit {
            font-size: 12px;
            padding: 3px 6px;
            border-radius: 8px;
            border: 1px solid #e5e0db;
            background: #fff;
            max-width: 260px;
        }

        #divDetalleServicioMon .muestreo-code {
            font-size: 10px;
            color: #9a9a9a;
            margin-left: auto;
        }

        #divDetalleServicioMon .muestreo-cell-input {
            width: 70px;
            text-align: right;
            border: 1px solid #e5e0db;
            border-radius: 8px;
            padding: 2px 6px;
            font-size: 12px;
            background: #fff;
        }

        .service-tag {
            background: #ef8157;
            color: #fff;
            font-size: 9px;
            padding: 2px 7px;
            border-radius: 12px;
            text-transform: uppercase;
            letter-spacing: 0.2px;
        }

        .service-subtotal {
            text-align: right;
            font-weight: 600;
            padding: 10px 14px 14px;
            border-top: 1px solid #f0ece8;
        }

        .simple-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .simple-modal {
            background: #fff;
            border-radius: 10px;
            width: min(900px, 92vw);
            max-height: 85vh;
            overflow: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .simple-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 18px;
            border-bottom: 1px solid #ece8e2;
            font-weight: 600;
            font-size: 16px;
        }

        .simple-modal-body {
            padding: 18px;
        }

        .simple-modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: 12px 18px 18px;
            border-top: 1px solid #ece8e2;
        }

        .service-drawer-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.35);
            display: none;
            justify-content: flex-end;
            align-items: stretch;
            z-index: 2100;
        }

        .service-drawer {
            background: #fff;
            width: min(55vw, 860px);
            height: 100%;
            display: flex;
            flex-direction: column;
            box-shadow: -20px 0 40px rgba(0, 0, 0, 0.18);
            border-radius: 12px 0 0 12px;
            overflow: hidden;
        }

        .service-drawer-body {
            padding: 8px 14px;
            overflow: auto;
            flex: 1;
        }

        .drawer-group-summary {
            background: #f5f3f0;
            border: 1px solid #e6e1da;
            border-radius: 10px;
            padding: 8px 10px;
            margin-bottom: 10px;
        }

        .drawer-group-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .drawer-group-title {
            font-weight: 600;
            color: #4a4a4a;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 4px;
        }

        .drawer-group-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .drawer-group-tags .service-tag {
            background: #ef8157;
            color: #fff;
        }

        .service-search-filters #btnBuscarServicioDrawer {
            height: 32px;
            width: 36px;
            padding: 0;
            align-self: end;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: #6b6b6b;
            border-color: #dcd6cf;
            background: #f6f4f1;
        }

        .service-search-filters #btnBuscarServicioDrawer i {
            font-size: 13px;
            line-height: 1;
        }

        .service-search-filters #btnBuscarServicioDrawer:hover {
            color: #3a3a3a;
            border-color: #cfc7be;
            background: #f0ede9;
        }

        .service-drawer-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 8px 16px 10px;
            border-top: 1px solid #ece8e2;
            background: #fbfaf8;
        }

        .drawer-summary {
            display: flex;
            flex-direction: column;
            gap: 2px;
            font-size: 12px;
            color: #6d6d6d;
        }

        .drawer-summary strong {
            color: #333;
        }

        .drawer-summary .drawer-total {
            font-weight: 700;
            color: #333;
        }

        .drawer-actions {
            display: flex;
            gap: 10px;
        }

        .service-card-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .service-field-table {
            display: none;
        }

        .service-card {
            border: 1px solid #e8e5df;
            border-radius: 12px;
            padding: 8px 9px 6px;
            background: #fff;
            display: grid;
            grid-template-columns: 22px 1fr;
            gap: 8px;
            align-items: start;
            position: relative;
        }

        .service-card:hover {
            border-color: #d8d2c9;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.05);
        }

        .service-card .service-card-code {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 1px 6px;
            border-radius: 999px;
            background: #5bc0de;
            color: #fff;
            font-size: 10px;
            font-weight: 600;
        }

        .service-card-title {
            font-weight: 600;
            font-size: 12.5px;
            color: #3a3a3a;
            margin-bottom: 4px;
        }

        .service-card-subtags {
            display: inline-flex;
            gap: 6px;
            margin-left: 8px;
            flex-wrap: wrap;
        }

        .service-card-subtag {
            background: #f2ede6;
            color: #6a6156;
            border: 1px solid #e2dbd3;
            border-radius: 999px;
            padding: 1px 6px;
            font-size: 9px;
            font-weight: 500;
            letter-spacing: 0.02em;
            text-transform: uppercase;
        }

        .service-card-meta {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 4px 10px;
            font-size: 11px;
            color: #7a7a7a;
        }

        .service-card-meta .field-only {
            display: none;
        }

        .service-card-meta .lab-only {
            display: inline-flex;
        }

        .drawer-field .service-card-meta .field-only {
            display: inline-flex;
        }

        .drawer-field .service-card-meta .lab-only {
            display: none;
        }

        .service-card-meta span {
            display: block;
        }

        .service-card-meta strong {
            font-weight: 500;
            font-size: 10px;
            color: #8a8a8a;
        }

        .service-card-meta .meta-span-2 {
            grid-column: span 2;
            color: #8a8a8a;
        }

        .service-card-etfa {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: #2f2f2f;
            position: absolute;
            top: 8px;
            right: 10px;
        }

        .drawer-field .service-card-etfa {
            display: none;
        }

        .service-card-code-pill {
            position: absolute;
            top: 8px;
            right: 10px;
            background: #eaf4ff;
            color: #2471b3;
            border: 1px solid #cfe4fb;
            border-radius: 999px;
            padding: 2px 8px;
            font-size: 10px;
            font-weight: 600;
        }

        .service-card-etfa i {
            color: #41b883;
        }

        .service-card-etfa-code {
            font-size: 10px;
            font-weight: 400;
            color: #6a6a6a;
        }

        .service-search-tabs {
            display: flex;
            justify-content: center;
            gap: 30px;
            border-bottom: 1px solid #e9e9e9;
            padding: 12px 0 0;
            margin-bottom: 10px;
        }

        .service-search-tabs button {
            background: none;
            border: none;
            padding: 10px 6px;
            font-weight: 600;
            color: #9a9a9a;
            cursor: pointer;
            position: relative;
        }

        .service-search-tabs button.active {
            color: #66615b;
        }

        .service-search-tabs button.active::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            bottom: -1px;
            height: 2px;
            background: #ef8157;
        }

        .service-search-filters {
            display: grid;
            grid-template-columns: 1.4fr 1fr 1fr auto;
            gap: 16px;
            align-items: end;
            margin-bottom: 14px;
        }

        .service-search-filters .etfa-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 6px;
            color: #66615b;
            font-weight: 500;
        }

        .service-search-filters {
            display: block;
            margin-bottom: 12px;
        }

        .service-search-row {
            display: flex;
            align-items: flex-end;
            gap: 10px;
        }

        .service-search-row.secondary {
            margin-top: 10px;
            display: none;
        }

        .field-only {
            display: none;
        }

        .drawer-field .field-only {
            display: flex;
        }

        .drawer-field .service-search-tabs {
            display: none;
        }

        .drawer-field .service-search-pane[data-tab="normas"] {
            display: none !important;
        }

        .service-search-field {
            flex: 1;
            min-width: 0;
        }

        .service-search-field label {
            display: block;
        }

        .service-search-field input {
            height: 36px;
            border-radius: 10px;
            border: 1px solid #e3ddd6;
            background: #fbfaf8;
        }

        .service-search-field select {
            height: 36px;
            border-radius: 10px;
            border: 1px solid #e3ddd6;
            background: #fbfaf8;
        }

        .service-search-row .etfa-toggle {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 999px;
            background: #f5f3f0;
            border: 1px solid #e1dbd4;
            margin-bottom: 2px;
            height: 36px;
        }

        .drawer-field .etfa-toggle {
            display: none;
        }

        .service-search-row .etfa-toggle span {
            font-weight: 600;
            font-size: 12px;
            color: #5f5f5f;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }

        .no-scroll {
            overflow: hidden;
        }

        .service-search-row #btnBuscarServicioDrawer {
            height: 36px;
            width: 40px;
            margin-bottom: 2px;
        }

        .service-search-pagination {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-top: 1px solid #e9e9e9;
        }

        .service-search-pagination .page-pill {
            min-width: 34px;
            text-align: center;
            padding: 6px 10px;
            border: 1px solid #e0dcd6;
            border-radius: 4px;
            background: #f7f5f2;
        }

        /* CATEGORY TEXT */
        .category {
            font-size: 13px;
            color: #9a9a9a;
            margin-bottom: 20px;
        }

        /* RADIO BUTTONS */
        .radio-group {
            display: flex;
            gap: 20px;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .radio-item input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* TABLE */
        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th, .table td {
            padding: 12px 10px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
            font-size: 12px;
        }

        .table th {
            font-weight: 600;
            color: #66615b;
            background: #f9f9f9;
        }

        /* FOOTER */
        .footer {
            background: #fff;
            padding: 20px 30px;
            border-top: 1px solid #e9e9e9;
            display: flex;
            justify-content: space-between;
        }

        .footer a {
            color: #66615b;
            text-decoration: none;
            font-size: 13px;
        }

        .footer .copyright {
            font-size: 13px;
            color: #9a9a9a;
        }

        .footer .copyright a {
            color: #ef8157;
        }

        /* STEP PANELS */
        .step-panel {
            display: none;
        }

        .step-panel.active {
            display: block;
        }

        /* ACTION BUTTONS */
        .action-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
        }

        .pull-right {
            margin-left: auto;
        }

        .pull-left {
            margin-right: auto;
        }

        /* HIDDEN */
        [hidden] {
            display: none !important;
        }

        /* MODAL */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-dialog {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            background: #fff;
            color: #66615b;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e9e9e9;
        }

        .modal-header h5 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }

        .modal-header .close-btn {
            background: none;
            border: none;
            color: #66615b;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .modal-header .close-btn:hover {
            color: #ef8157;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #e9e9e9;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Search results table */
        .search-results-table {
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e9e9e9;
            border-radius: 4px;
        }

        .search-results-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .search-results-table th,
        .search-results-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
            font-size: 12px;
        }

        .search-results-table th {
            background: #f9f9f9;
            font-weight: 600;
            color: #66615b;
            position: sticky;
            top: 0;
        }

        .search-results-table tr:hover {
            background: #f5f5f5;
            cursor: pointer;
        }

        .search-results-table tr.selected {
            background: #e8f4f8;
        }

        /* Client data display - Modern Card Style */
        .client-card {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-left: 3px solid #ef8157;
            border-radius: 6px;
            padding: 12px 15px;
        }

        .client-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .client-card-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .client-card-icon {
            width: 28px;
            height: 28px;
            background: #f5f5f5;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9a9a9a;
            font-size: 12px;
        }

        .client-card-name {
            font-size: 13px;
            font-weight: 600;
            color: #2c2c2c;
        }

        .client-card-code {
            font-size: 10px;
            color: #9a9a9a;
            font-weight: 400;
        }

        .client-card-actions {
            display: flex;
            gap: 8px;
        }

        .btn-change-client {
            background: none;
            border: 1px solid #e0e0e0;
            color: #66615b;
            padding: 6px 12px;
            font-size: 11px;
            border-radius: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }

        .btn-change-client:hover {
            background: #f5f5f5;
            border-color: #ccc;
        }

        .client-card-body {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .client-info-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #fff;
            border: 1px solid #e8e8e8;
            border-radius: 20px;
            padding: 6px 12px;
            font-size: 12px;
            color: #66615b;
            height: 34px;
            box-sizing: border-box;
        }

        .client-info-chip i {
            color: #9a9a9a;
            font-size: 11px;
        }

        .client-info-chip .chip-label {
            color: #9a9a9a;
            font-weight: 500;
            text-transform: capitalize;
        }

        .client-info-chip .chip-value {
            color: #2c2c2c;
            font-weight: 500;
        }

        .client-address-selector {
            flex: 1;
            min-width: 250px;
            display: flex;
            align-items: center;
            gap: 8px;
            background: #fff;
            border: 1px solid #e8e8e8;
            border-radius: 20px;
            padding: 4px 4px 4px 12px;
            height: 34px;
            box-sizing: border-box;
        }

        .client-address-selector i {
            color: #ef8157;
            font-size: 12px;
        }

        .client-address-selector select {
            flex: 1;
            border: none;
            background: transparent;
            font-size: 12px;
            color: #66615b;
            padding: 6px 8px;
            cursor: pointer;
            outline: none;
        }

        .client-address-selector select:focus {
            outline: none;
        }

        /* Client search prompt */
        .client-search-prompt {
            display: flex;
            align-items: center;
            gap: 12px;
            background: #fff;
            border: 1px solid #e0e0e0;
            border-left: 3px solid #ef8157;
            border-radius: 6px;
            padding: 12px 15px;
        }

        .search-prompt-icon {
            width: 32px;
            height: 32px;
            background: #f5f5f5;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9a9a9a;
            font-size: 14px;
        }

        .search-prompt-text {
            flex: 1;
        }

        .search-prompt-text span {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: #66615b;
        }

        .search-prompt-text small {
            font-size: 11px;
            color: #9a9a9a;
        }

        /* Cards row layout */
        .cards-row {
            display: flex;
            flex-direction: row;
            flex-wrap: nowrap;
            gap: 20px;
            margin-bottom: 20px;
            width: 100%;
        }

        .cards-row[hidden] {
            display: none !important;
        }

        .cards-row .card-column {
            flex: 1 1 50% !important;
            max-width: 50% !important;
            min-width: 0;
            box-sizing: border-box;
        }

        .cards-row .client-card,
        .cards-row .contact-card,
        .cards-row .client-search-prompt,
        .cards-row .contact-search-prompt {
            margin-bottom: 0;
            height: 100%;
            box-sizing: border-box;
        }

        /* Contact/Atención card */
        .contact-card {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-left: 3px solid #ef8157;
            border-radius: 6px;
            padding: 12px 15px;
        }

        .contact-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .contact-card-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .contact-card-icon {
            width: 36px;
            height: 36px;
            background: #e9e9e9;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9a9a9a;
            font-size: 16px;
        }

        .contact-card-label {
            font-size: 13px;
            font-weight: 600;
            color: #66615b;
            text-transform: capitalize;
        }

        .contact-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #fff;
            border: 1px solid #e8e8e8;
            border-radius: 20px;
            padding: 4px 4px 4px 12px;
            flex: 1;
            max-width: 280px;
            height: 34px;
            box-sizing: border-box;
        }

        .contact-selector i {
            color: #ef8157;
            font-size: 12px;
        }

        .contact-selector select {
            flex: 1;
            border: none;
            background: transparent;
            font-size: 12px;
            color: #66615b;
            padding: 4px 8px;
            cursor: pointer;
            outline: none;
        }

        .contact-card-body {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .contact-info-item {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #fff;
            border: 1px solid #e8e8e8;
            border-radius: 20px;
            padding: 6px 12px;
            font-size: 12px;
            color: #66615b;
            height: 34px;
            box-sizing: border-box;
        }

        .contact-info-item i {
            color: #9a9a9a;
            font-size: 11px;
            width: 16px;
            text-align: center;
        }

        .contact-info-item .info-label {
            color: #9a9a9a;
            font-size: 10px;
            text-transform: capitalize;
        }

        .contact-info-item .info-value {
            color: #2c2c2c;
            font-weight: 500;
            font-size: 12px;
        }

        .contact-info-item.empty .info-value {
            color: #ccc;
            font-style: italic;
        }

        /* Contact search prompt */
        .contact-search-prompt {
            display: flex;
            align-items: center;
            gap: 15px;
            background: linear-gradient(135deg, #f8f9fa 0%, #fff 100%);
            border: 1px solid #e0e0e0;
            border-left: 4px solid #ef8157;
            border-radius: 8px;
            padding: 20px;
            height: 100%;
            min-height: 120px;
        }

        .contact-search-prompt .search-prompt-icon {
            background: #e9e9e9;
        }

        /* Compact Form Section */
        .form-section-card {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-left: 3px solid #ef8157;
            border-radius: 6px;
            padding: 15px 20px;
            margin-bottom: 15px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px 15px;
        }

        .form-grid .span-2 {
            grid-column: span 2;
        }

        .form-grid .span-3 {
            grid-column: span 3;
        }

        .form-grid .span-4 {
            grid-column: span 4;
        }

        .compact-form-group {
            margin-bottom: 0;
        }

        .compact-form-group label {
            display: block;
            font-size: 11px;
            font-weight: 500;
            color: #9a9a9a;
            margin-bottom: 4px;
            text-transform: capitalize;
        }

        .compact-form-group .form-control {
            padding: 8px 10px;
            font-size: 12px;
            background: #fafafa;
            border: 1px solid #e8e8e8;
            border-radius: 4px;
        }

        .compact-form-group .form-control:focus {
            background: #fff;
            border-color: #ef8157;
        }

        .compact-form-group textarea.form-control {
            min-height: 60px;
            resize: vertical;
        }

        /* Compact Radio Toggle */
        .radio-toggle {
            display: inline-flex;
            background: #f5f5f5;
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid #e8e8e8;
        }

        .radio-toggle input[type="radio"] {
            display: none;
        }

        .radio-toggle label {
            padding: 6px 14px;
            font-size: 11px;
            font-weight: 500;
            color: #66615b;
            cursor: pointer;
            transition: all 0.2s;
            margin: 0;
            border-right: 1px solid #e8e8e8;
        }

        .radio-toggle label:last-of-type {
            border-right: none;
        }

        .radio-toggle input[type="radio"]:checked + label {
            background: #ef8157;
            color: #fff;
        }

        .inline-field-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .inline-field-group label.field-label {
            font-size: 11px;
            font-weight: 500;
            color: #9a9a9a;
            margin: 0;
            white-space: nowrap;
        }

        .toggle-pair {
            display: flex;
            flex-direction: row;
            gap: 20px;
            height: 100%;
            align-items: flex-end;
            padding-bottom: 2px;
        }

        .toggle-item {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 4px;
        }

        .toggle-item label {
            font-size: 11px;
            font-weight: 500;
            color: #9a9a9a;
            margin: 0;
            white-space: nowrap;
        }

        /* Quotation Summary Header */
        .quote-summary {
            background: #fff;
            border: 1px solid #ece8e2;
            border-radius: 12px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 10px 22px rgba(44, 44, 44, 0.06);
            position: sticky;
            top: 12px;
            z-index: 8;
            transition: box-shadow 0.2s ease, border-color 0.2s ease;
        }

        .quote-summary.expanded {
            position: relative;
        }

        .quote-summary-bar {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            padding: 14px 18px;
            cursor: pointer;
            gap: 16px;
            background: linear-gradient(135deg, #fff 0%, #fbfaf8 100%);
        }

        .quote-summary-bar:hover {
            background: #fdfbf8;
        }

        .quote-summary-left {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex: 1;
            min-width: 0;
        }

        .summary-topline {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .quote-number {
            display: flex;
            align-items: baseline;
            gap: 8px;
        }

        .quote-number-label {
            font-size: 10px;
            color: #9a9a9a;
            text-transform: uppercase;
            letter-spacing: 0.6px;
        }

        .quote-number-value {
            font-size: 17px;
            font-weight: 700;
            color: #ef8157;
        }

        .quote-number-value.empty {
            color: #c9c5bf;
            font-style: italic;
            font-weight: 500;
            font-size: 13px;
        }

        .summary-badges {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .status-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 5px 10px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
            background: #ef8157;
            color: #fff;
            letter-spacing: 0.3px;
            text-transform: uppercase;
        }

        .status-pill i {
            font-size: 11px;
        }

        .status-pill.draft {
            background: #a3a3a3;
        }

        .status-pill.subtle {
            background: #f4f1ee;
            color: #6d655d;
            font-weight: 500;
            text-transform: none;
        }

        .status-pill.subtle strong {
            color: #ef8157;
            font-weight: 600;
        }

        .status-pill.subtle.empty {
            color: #b6b0aa;
        }

        .status-pill.subtle.empty strong {
            color: #b6b0aa;
        }

        .summary-bottomline {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 12px;
        }

        .summary-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
            min-width: 0;
        }

        .summary-item-label {
            font-size: 10px;
            color: #9a9a9a;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .summary-item-value {
            font-size: 12px;
            font-weight: 600;
            color: #5a534c;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .summary-item-value.empty {
            color: #c9c5bf;
            font-style: italic;
            font-weight: 500;
        }

        .quote-summary-right {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .quote-total {
            text-align: right;
        }

        .quote-total-label {
            font-size: 10px;
            color: #9a9a9a;
            text-transform: uppercase;
        }

        .quote-total-value {
            font-size: 18px;
            font-weight: 700;
            color: #4f4943;
        }

        .quote-total-currency {
            font-size: 12px;
            color: #9a9a9a;
            font-weight: 500;
            margin-left: 4px;
        }

        .quote-expand-btn {
            width: 30px;
            height: 30px;
            border: 1px solid #e6e1db;
            background: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            color: #a29b94;
            font-size: 12px;
        }

        .quote-expand-btn:hover {
            background: #ef8157;
            border-color: #ef8157;
            color: #fff;
        }

        .quote-expand-btn i {
            transition: transform 0.3s;
        }

        .quote-summary.expanded .quote-expand-btn i {
            transform: rotate(180deg);
        }

        .quote-summary-details {
            display: none;
            padding: 0 18px 16px;
            border-top: 1px solid #f0ece8;
            background: #fff;
        }

        .quote-summary.expanded .quote-summary-details {
            display: block;
        }

        .floating-summary-btn {
            position: fixed;
            right: 22px;
            bottom: 22px;
            z-index: 2200;
            background: #ef8157;
            color: #fff;
            border: none;
            border-radius: 999px;
            padding: 12px 18px;
            font-weight: 600;
            font-size: 13px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.18);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .floating-summary-btn:hover {
            background: #e06f46;
        }

        .summary-drawer-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.35);
            display: none;
            justify-content: flex-end;
            align-items: stretch;
            z-index: 2300;
        }

        .summary-drawer {
            width: min(520px, 92vw);
            background: #fff;
            border-left: 1px solid #efe9e2;
            box-shadow: -20px 0 40px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
        }

        .summary-drawer-header {
            padding: 16px 18px;
            border-bottom: 1px solid #efe9e2;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }

        .summary-drawer-body {
            padding: 18px;
            overflow: auto;
        }

        .summary-doc {
            border: 1px solid #eee5dd;
            border-radius: 10px;
            padding: 14px 16px;
            background: #fffdfa;
        }

        .summary-doc h5 {
            font-size: 14px;
            margin: 0 0 10px 0;
            font-weight: 700;
            color: #3a3a3a;
        }

        .summary-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .summary-table th,
        .summary-table td {
            padding: 8px 6px;
            border-bottom: 1px solid #eee5dd;
            text-align: left;
            vertical-align: top;
        }

        .summary-table th {
            color: #8a7f75;
            font-weight: 600;
        }

        .summary-table .summary-tags {
            display: inline-flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 6px;
        }

        .summary-table .summary-tag {
            background: #f2ede6;
            color: #6a6156;
            border: 1px solid #e2dbd3;
            border-radius: 999px;
            padding: 2px 8px;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        .summary-total {
            margin-top: 10px;
            display: flex;
            justify-content: flex-end;
            font-weight: 700;
        }

        .quote-details-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 12px;
            padding-top: 14px;
        }

        .quote-detail-section {
            padding: 12px 14px;
            background: #f9f7f4;
            border: 1px solid #f0ece8;
            border-radius: 8px;
        }

        .quote-detail-section h6 {
            font-size: 11px;
            font-weight: 600;
            color: #ef8157;
            text-transform: uppercase;
            margin: 0 0 10px 0;
            letter-spacing: 0.3px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            padding: 3px 0;
        }

        .detail-row span:first-child {
            color: #9a9a9a;
        }

        .detail-row span:last-child {
            color: #5a534c;
            font-weight: 600;
            text-align: right;
        }

        @media (max-width: 1200px) {
            .summary-bottomline {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
            .summary-bottomline .summary-item:last-child {
                grid-column: span 2;
            }
            .quote-details-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 820px) {
            .quote-summary-bar {
                flex-direction: column;
                align-items: stretch;
            }
            .quote-summary-right {
                justify-content: space-between;
            }
        }

        @media (max-width: 1200px) {
            .cards-row {
                flex-direction: column;
            }
            .cards-row .card-column {
                flex: 0 0 100%;
                max-width: 100%;
            }
            .form-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .form-grid .span-3,
            .form-grid .span-4 {
                grid-column: span 2;
            }
        }

        @media (max-width: 991px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .main-panel {
                width: 100%;
                margin-left: 0;
            }
            .col-md-2, .col-md-3, .col-md-4, .col-md-5, .col-md-6 {
                flex: 0 0 100%;
                max-width: 100%;
                margin-bottom: 15px;
            }
            .stepper {
                flex-direction: column;
                gap: 10px;
            }
            .stepper-item::before {
                display: none;
            }
            .form-grid {
                grid-template-columns: 1fr;
            }
            .form-grid .span-2,
            .form-grid .span-3,
            .form-grid .span-4 {
                grid-column: span 1;
            }
        }
    </style>
</head>
    <body>
        <div class="wrapper">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="logo">
                <div class="logo-container">
                    <div class="logo-top-line"></div>
                    <div class="logo-text">SGS</div>
                </div>
            </div>

            <div class="user">
                <div class="user-name">
                    <i class="fa fa-user"></i>
                    Bienvenido <span id="NombreUsuarioSistema">Cristian Toro</span>
                </div>
                <div class="app-version">V.1.0.0</div>
            </div>

            <ul class="nav">
                <li>
                    <a href="#">
                        <i class="fas fa-home"></i>
                        <span>Inicio</span>
                    </a>
                </li>
                <li>
                    <a href="#">
                        <i class="far fa-square"></i>
                        <span>Tarifario</span>
                    </a>
                </li>
                <li class="active">
                    <a href="cotizaciones-sgs.html">
                        <i class="far fa-circle"></i>
                        <span>Listado de cotizaciones</span>
                    </a>
                </li>
                <li>
                    <a href="#">
                        <i class="fas fa-check"></i>
                        <span>Aprobar cotizaciones</span>
                    </a>
                </li>
                <li>
                    <a href="#">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Salir</span>
                    </a>
                </li>
            </ul>
        </div>

        <!-- MAIN PANEL -->
            <div class="main-panel">
            <!-- Page Header -->
            <div class="page-header">
                <div class="page-header-left">
                    <div class="header-icon">
                        <i class="fas fa-money-check"></i>
                    </div>
                    <h1>Creación cotización</h1>
                </div>
                <div class="company-switcher">
                    <label>Empresa:</label>
                    <select id="companySelect" class="company-select">
                        <option value="SGS" selected>SGS</option>
                        <option value="CONEMI">CONEMI</option>
                        <option value="ECOTECNOS">ECOTECNOS</option>
                    </select>
                </div>
            </div>

            <!-- Content -->
            <div class="content">
                <!-- Back Button -->
                <div style="margin-bottom: 20px;">
                    <a href="cotizaciones-sgs.html" class="btn btn-default">
                        <i class="fas fa-arrow-left"></i> Volver
                    </a>
                </div>

                <p class="category">Complete los pasos a continuación para crear una nueva cotización.</p>

                <!-- Quote Summary Header -->
                <div class="quote-summary" id="quoteSummary">
                    <div class="quote-summary-bar" onclick="toggleQuoteSummary()">
                        <div class="quote-summary-left">
                            <div class="summary-topline">
                                <div class="quote-number">
                                    <span class="quote-number-label">Cotización</span>
                                    <span class="quote-number-value empty" id="summaryQuoteNumber">Sin registrar</span>
                                </div>
                                <div class="summary-badges">
                                    <span class="status-pill draft" id="summaryStatus">
                                        <i class="fas fa-edit"></i>
                                        <span>Borrador</span>
                                    </span>
                                    <span class="status-pill subtle empty" id="summaryProposalBadge">
                                        <i class="fas fa-file-signature"></i>
                                        <span>Propuesta</span>
                                        <strong id="summaryProposalNumber">—</strong>
                                    </span>
                                </div>
                            </div>
                            <div class="summary-bottomline">
                                <div class="summary-item">
                                    <span class="summary-item-label">Cliente</span>
                                    <span class="summary-item-value empty" id="summaryClient">No seleccionado</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-item-label">Atención a</span>
                                    <span class="summary-item-value empty" id="summaryContact">No seleccionado</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-item-label">Fecha cotización</span>
                                    <span class="summary-item-value" id="summaryDate">30/01/2026</span>
                                </div>
                            </div>
                        </div>
                        <div class="quote-summary-right">
                            <div class="quote-total">
                                <div class="quote-total-label">Total</div>
                                <div class="quote-total-value">
                                    <span id="summaryTotal">0.00</span>
                                    <span class="quote-total-currency" id="summaryCurrency">CLP</span>
                                </div>
                            </div>
                            <div class="quote-expand-btn">
                                <i class="fas fa-chevron-down"></i>
                            </div>
                        </div>
                    </div>
                    <div class="quote-summary-details">
                        <div class="quote-details-grid">
                            <div class="quote-detail-section">
                                <h6><i class="fas fa-building"></i> Cliente</h6>
                                <div class="detail-row">
                                    <span>Razón social</span>
                                    <span id="detailClientName">-</span>
                                </div>
                                <div class="detail-row">
                                    <span>RUT</span>
                                    <span id="detailClientRut">-</span>
                                </div>
                                <div class="detail-row">
                                    <span>Dirección</span>
                                    <span id="detailClientAddress">-</span>
                                </div>
                            </div>
                            <div class="quote-detail-section">
                                <h6><i class="fas fa-user"></i> Contacto</h6>
                                <div class="detail-row">
                                    <span>Nombre</span>
                                    <span id="detailContactName">-</span>
                                </div>
                                <div class="detail-row">
                                    <span>Email</span>
                                    <span id="detailContactEmail">-</span>
                                </div>
                                <div class="detail-row">
                                    <span>Teléfono</span>
                                    <span id="detailContactPhone">-</span>
                                </div>
                            </div>
                            <div class="quote-detail-section">
                                <h6><i class="fas fa-file-invoice"></i> Cotización</h6>
                                <div class="detail-row">
                                    <span>Vendedor</span>
                                    <span id="detailVendedor">-</span>
                                </div>
                                <div class="detail-row">
                                    <span>Vigencia</span>
                                    <span id="detailVigencia">-</span>
                                </div>
                                <div class="detail-row">
                                    <span>Cond. Pago</span>
                                    <span id="detailCondPago">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stepper -->
                <div class="card">
                    <div class="stepper">
                        <div class="stepper-item active" data-step="1">
                            <div class="stepper-number">1</div>
                            <div class="stepper-label">Datos cotización</div>
                        </div>
                        <div class="stepper-item" data-step="2">
                            <div class="stepper-number">2</div>
                            <div class="stepper-label">Servicios</div>
                        </div>
                        <div class="stepper-item" data-step="3">
                            <div class="stepper-number">3</div>
                            <div class="stepper-label">Condiciones</div>
                        </div>
                        <div class="stepper-item" data-step="4">
                            <div class="stepper-number">4</div>
                            <div class="stepper-label">Previsualización</div>
                        </div>
                        <div class="stepper-item" data-step="5">
                            <div class="stepper-number">5</div>
                            <div class="stepper-label">Aprobación</div>
                        </div>
                    </div>

                    <!-- PASO 1: Datos Cotización -->
                    <div class="step-panel active" id="step1">
                        <h4 class="section-title"><i class="fas fa-file-alt"></i> Datos cotización</h4>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>División</label>
                                    <select class="form-control" id="DivisionId">
                                        <option value="">-- Seleccione --</option>
                                        <option value="10">H&N - Health & Nutrition</option>
                                        <option value="500">I&E - Industries & Environment</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Departamento</label>
                                    <select class="form-control" id="DepartamentoId">
                                        <option value="">-- Seleccione --</option>
                                        <option value="ADM">Adm Envi (DS)</option>
                                        <option value="COM">Comercial Envi (DS)</option>
                                        <option value="MA">Monitoreo Aguas</option>
                                        <option value="MM">Monitoreo Medio Marino</option>
                                        <option value="CON">Consultoría</option>
                                        <option value="MAIR">Monitoreo Aire</option>
                                        <option value="EMI">Emisiones</option>
                                        <option value="HI">Higiene Industrial</option>
                                        <option value="LAB">Laboratorio</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Localidad</label>
                                    <select class="form-control" id="LocalidadId">
                                        <option value="">-- Seleccione --</option>
                                        <option value="ANT">Zona A_Antofagasta</option>
                                        <option value="CM">Zona C_Casa Matriz</option>
                                        <option value="PV">Zona C_Puerto Varas</option>
                                        <option value="SAL">Zona C_Salamanca</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <h4 class="section-title"><i class="fas fa-building"></i> Cliente y Contacto</h4>

                        <!-- Hidden field for client ID -->
                        <input type="hidden" id="ClienteId">

                        <!-- Before client selection - show prompts -->
                        <div id="divBuscarCliente" class="cards-row">
                            <div class="card-column">
                                <div class="client-search-prompt">
                                    <div class="search-prompt-icon">
                                        <i class="fas fa-building"></i>
                                    </div>
                                    <div class="search-prompt-text">
                                        <span>No hay cliente seleccionado</span>
                                        <small>Haga clic en buscar para seleccionar un cliente</small>
                                    </div>
                                    <button type="button" class="btn btn-success" id="btnBuscarCliente">
                                        <i class="fas fa-search"></i> Buscar
                                    </button>
                                </div>
                            </div>
                            <div class="card-column">
                                <div class="contact-search-prompt">
                                    <div class="search-prompt-icon">
                                        <i class="fas fa-user-tie"></i>
                                    </div>
                                    <div class="search-prompt-text">
                                        <span>Atención a</span>
                                        <small>Seleccione primero un cliente para ver sus contactos</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- After client selection - show cards -->
                        <div id="divDatosCliente" hidden class="cards-row">
                            <!-- Client Card -->
                            <div class="card-column">
                                <div class="client-card">
                                    <div class="client-card-header">
                                        <div class="client-card-title">
                                            <div class="client-card-icon">
                                                <i class="fas fa-building"></i>
                                            </div>
                                            <div>
                                                <div class="client-card-name" id="lblNombre"></div>
                                                <div class="client-card-code" id="lblCodigo"></div>
                                            </div>
                                        </div>
                                        <div class="client-card-actions">
                                            <button type="button" class="btn-change-client" onclick="openClientModal()">
                                                <i class="fas fa-exchange-alt"></i> Cambiar
                                            </button>
                                        </div>
                                    </div>
                                    <div class="client-card-body">
                                        <div class="client-info-chip">
                                            <i class="fas fa-id-card"></i>
                                            <span class="chip-label">Rut:</span>
                                            <span class="chip-value" id="lblRut"></span>
                                        </div>
                                        <div class="client-info-chip">
                                            <i class="fas fa-globe-americas"></i>
                                            <span class="chip-label">País:</span>
                                            <span class="chip-value" id="lblPais"></span>
                                        </div>
                                        <div class="client-address-selector">
                                            <i class="fas fa-map-marker-alt"></i>
                                            <select id="cbDireccion">
                                                <option value="">-- Seleccione dirección --</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Contact/Atención Card -->
                            <div class="card-column">
                                <div class="contact-card">
                                    <div class="contact-card-header">
                                        <div class="contact-card-title">
                                            <div class="contact-card-icon">
                                                <i class="fas fa-user-tie"></i>
                                            </div>
                                            <span class="contact-card-label">Atención a</span>
                                        </div>
                                        <div class="contact-selector">
                                            <i class="fas fa-user"></i>
                                            <select id="AtendedorId">
                                                <option value="">-- Seleccione contacto --</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="contact-card-body">
                                        <div class="contact-info-item" id="contactTelefono">
                                            <i class="fas fa-phone"></i>
                                            <div>
                                                <span class="info-label">Teléfono</span>
                                                <span class="info-value" id="lblTelefono">--</span>
                                            </div>
                                        </div>
                                        <div class="contact-info-item" id="contactCargo">
                                            <i class="fas fa-briefcase"></i>
                                            <div>
                                                <span class="info-label">Cargo</span>
                                                <span class="info-value" id="lblCargo">--</span>
                                            </div>
                                        </div>
                                        <div class="contact-info-item" id="contactEmail">
                                            <i class="fas fa-envelope"></i>
                                            <div>
                                                <span class="info-label">Email</span>
                                                <span class="info-value" id="lblEmail">--</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <h4 class="section-title"><i class="fas fa-clipboard-list"></i> Datos de la Cotización</h4>

                        <div class="form-section-card">
                            <div class="form-grid">
                                <div class="compact-form-group">
                                    <label>Inicio vigencia</label>
                                    <input type="date" class="form-control" id="InicioVigencia" value="2026-01-30">
                                </div>
                                <div class="compact-form-group">
                                    <label>Fin vigencia</label>
                                    <input type="date" class="form-control" id="FinVigencia" value="2026-02-28">
                                </div>
                                <div class="compact-form-group">
                                    <label>Moneda</label>
                                    <select class="form-control" id="MonedaId">
                                        <option value="">-- Seleccione --</option>
                                        <option value="CLP">PESO CHILENO</option>
                                        <option value="CLU">UF</option>
                                        <option value="EUR">EURO</option>
                                        <option value="USD">DOLARES AMERICANOS</option>
                                    </select>
                                </div>
                                <div class="compact-form-group">
                                    <label>Tasa de cambio</label>
                                    <input type="text" class="form-control" id="TasaCambio" disabled value="0">
                                </div>
                                <div class="compact-form-group">
                                    <label>Vendedor</label>
                                    <select class="form-control" id="VendedorId">
                                        <option value="">-- Seleccione --</option>
                                        <option value="abreschi">ANITZA ROXANA BRESCHI</option>
                                        <option value="acossio">ANNIA MARLENE COSSIO</option>
                                        <option value="amartin">ASTRID DENISSE MARTIN</option>
                                        <option value="crojas">CAMILO ADRIAN ROJAS</option>
                                        <option value="ccaceres">CAMILO CACERES</option>
                                        <option value="cdiaz">CARLOS IGNACIO DÍAZ</option>
                                        <option value="dalvarez">DANIELA ALEJANDRA ALVAREZ</option>
                                        <option value="jvillalobos">JOSE JOAQUIN VILLALOBOS</option>
                                        <option value="morellana">MARINA BELEN ORELLANA</option>
                                        <option value="mampuero">MAURICIO ANDRES AMPUERO</option>
                                        <option value="psaavedra">PABLO FRANCISCO SAAVEDRA</option>
                                        <option value="pmellado">PABLO PATRICIO MELLADO</option>
                                        <option value="pbenavides">PAULETTE CAROLINA BENAVIDES</option>
                                        <option value="pcortes">PAULINA BELEN CORTES</option>
                                        <option value="rvalenzuela">RICARDO VALENZUELA</option>
                                        <option value="vgodoy">VICTOR HUGO GODOY</option>
                                    </select>
                                </div>
                                <div class="compact-form-group">
                                    <label>Encargado</label>
                                    <select class="form-control" id="EncargadoId">
                                        <option value="">-- Seleccione --</option>
                                        <option value="vlopez" selected>VIVIANA LOPEZ OYARCE</option>
                                    </select>
                                </div>
                                <div class="compact-form-group">
                                    <label>Condiciones de pago</label>
                                    <select class="form-control" id="CondicionPago">
                                        <option value="">-- Seleccione --</option>
                                        <option value="Anticipado">Anticipado</option>
                                        <option value="OC con pago a 30 días">OC con pago a 30 días</option>
                                        <option value="Otra por definir">Otra por definir</option>
                                    </select>
                                </div>
                                <div class="compact-form-group">
                                    <label>Tiempo entrega</label>
                                    <input type="number" min="0" class="form-control" id="TiempoEntrega" value="0">
                                </div>
                                <div class="compact-form-group span-3">
                                    <label>Asunto</label>
                                    <input type="text" class="form-control" id="Asunto">
                                </div>
                                <div class="compact-form-group">
                                    <div class="toggle-pair">
                                        <div class="toggle-item">
                                            <label>Licitación</label>
                                            <div class="radio-toggle">
                                                <input type="radio" name="LicitacionRadio" value="1" id="licitacionSi">
                                                <label for="licitacionSi">Sí</label>
                                                <input type="radio" name="LicitacionRadio" value="0" id="licitacionNo" checked>
                                                <label for="licitacionNo">No</label>
                                            </div>
                                        </div>
                                        <div class="toggle-item">
                                            <label>Cliente nuevo</label>
                                            <div class="radio-toggle">
                                                <input type="radio" name="TipoClienteRadio" value="1" id="clienteSi">
                                                <label for="clienteSi">Sí</label>
                                                <input type="radio" name="TipoClienteRadio" value="0" id="clienteNo" checked>
                                                <label for="clienteNo">No</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="compact-form-group span-2">
                                    <label>Observaciones</label>
                                    <textarea class="form-control" id="Observacion" rows="2"></textarea>
                                </div>
                                <div class="compact-form-group span-2">
                                    <label>Plan de muestreo / Alcance servicio</label>
                                    <textarea class="form-control" id="PlanMuestreo" rows="2"></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="action-buttons">
                            <div></div>
                            <button type="button" class="btn btn-success" onclick="nextStep(2)">
                                Finalizar Paso <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>

                        <!-- PASO 2: Servicios -->
                    <div class="step-panel" id="step2">
                        <div class="service-section">
                            <div class="service-section-header">
                                <div>
                                    <div class="service-section-title"><i class="fas fa-flask"></i> Servicios de laboratorio</div>
                                    <div class="service-section-desc">Agrupa servicios por producto y presentación. Los grupos sólo aplican a laboratorio.</div>
                                </div>
                                <div class="service-section-actions">
                                    <button class="btn btn-warning" id="btnAgregarNuevoGrupo">
                                        <i class="fas fa-plus"></i> Agregar Nuevo Grupo
                                    </button>
                                    <button class="btn btn-success">
                                        <i class="fas fa-plus"></i> Agregar Grupo Existente
                                    </button>
                                </div>
                            </div>

                            <div id="divGruposServicioLab">
                            <div class="service-group">
                                <div class="service-group-header">
                                    <div class="group-title">
                                        <i class="fas fa-expand-alt text-warning"></i>
                                        Grupo 1: Salmuera 1 - COT CIT
                                    </div>
                                    <div class="group-actions">
                                        <i class="fas fa-pen"></i>
                                        <i class="fas fa-trash"></i>
                                        <button class="btn btn-success btn-sm js-open-service-modal" data-context="lab">
                                            <i class="fas fa-plus"></i> Agregar servicio
                                        </button>
                                    </div>
                                </div>
                                <div class="service-tags">
                                    <span class="service-tag">Analisis Agua (2023)</span>
                                    <span class="service-tag">Agua de Mar (2023)</span>
                                </div>
                                <div class="table-responsive" style="padding: 10px 12px;">
                                    <table class="table table-lct">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>Servicio</th>
                                                <th>LD*</th>
                                                <th>Metodología</th>
                                                <th>Unidad</th>
                                                <th>Precio Unit.</th>
                                                <th>Tipo Var.</th>
                                                <th>Variación</th>
                                                <th>Cant</th>
                                                <th>Total</th>
                                                <th>Laboratorio</th>
                                                <th>Tiempo Resp.</th>
                                                <th>ETFA</th>
                                                <th></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>1</td>
                                                <td>Carbono Orgánico Disuelto</td>
                                                <td>0.2</td>
                                                <td>SM 5310 B Ed.24, 2023</td>
                                                <td>MG/L</td>
                                                <td>0.98</td>
                                                <td>PORCENTAJE</td>
                                                <td>0.00</td>
                                                <td>1.00</td>
                                                <td>0.98</td>
                                                <td>Lab. Santiago - ENV</td>
                                                <td>12</td>
                                                <td><input type="checkbox" disabled></td>
                                                <td>
                                                    <i class="fas fa-edit"></i>
                                                    <i class="fas fa-trash"></i>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>2</td>
                                                <td>Carbono Orgánico Total</td>
                                                <td>0.2</td>
                                                <td>SM 5310 B Ed.24, 2023</td>
                                                <td>UND</td>
                                                <td>0.68</td>
                                                <td>PORCENTAJE</td>
                                                <td>0.00</td>
                                                <td>1.00</td>
                                                <td>0.68</td>
                                                <td>Lab. Santiago - ENV</td>
                                                <td>12</td>
                                                <td><input type="checkbox" disabled></td>
                                                <td>
                                                    <i class="fas fa-edit"></i>
                                                    <i class="fas fa-trash"></i>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="service-subtotal">SubTotal 1.66 / CLU</div>
                            </div>

                            <div class="service-group">
                                <div class="service-group-header">
                                    <div class="group-title">
                                        <i class="fas fa-expand-alt text-warning"></i>
                                        Grupo 2: Salmuera
                                    </div>
                                    <div class="group-actions">
                                        <i class="fas fa-pen"></i>
                                        <i class="fas fa-trash"></i>
                                        <button class="btn btn-success btn-sm js-open-service-modal" data-context="lab">
                                            <i class="fas fa-plus"></i> Agregar servicio
                                        </button>
                                    </div>
                                </div>
                                <div class="service-tags">
                                    <span class="service-tag">Analisis Agua (2023)</span>
                                    <span class="service-tag">Aguas Residuales (2023)</span>
                                </div>
                                <div class="table-responsive" style="padding: 10px 12px;">
                                    <table class="table table-lct">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>Servicio</th>
                                                <th>LD*</th>
                                                <th>Metodología</th>
                                                <th>Unidad</th>
                                                <th>Precio Unit.</th>
                                                <th>Tipo Var.</th>
                                                <th>Variación</th>
                                                <th>Cant</th>
                                                <th>Total</th>
                                                <th>Laboratorio</th>
                                                <th>Tiempo Resp.</th>
                                                <th>ETFA</th>
                                                <th></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>1</td>
                                                <td>Carbono Inorgánico Total</td>
                                                <td>0.2</td>
                                                <td>SM 5310 B Ed.24, 2023</td>
                                                <td>MG/L</td>
                                                <td>0.98</td>
                                                <td>PORCENTAJE</td>
                                                <td>0.00</td>
                                                <td>1.00</td>
                                                <td>0.98</td>
                                                <td>Lab. Santiago - ENV</td>
                                                <td>12</td>
                                                <td><input type="checkbox" disabled></td>
                                                <td>
                                                    <i class="fas fa-edit"></i>
                                                    <i class="fas fa-trash"></i>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>2</td>
                                                <td>Carbono Orgánico Total</td>
                                                <td>0.2</td>
                                                <td>SM 5310 B Ed.24, 2023</td>
                                                <td>MG/L</td>
                                                <td>0.68</td>
                                                <td>PORCENTAJE</td>
                                                <td>0.00</td>
                                                <td>1.00</td>
                                                <td>0.68</td>
                                                <td>Lab. Santiago - ENV</td>
                                                <td>12</td>
                                                <td><input type="checkbox" disabled></td>
                                                <td>
                                                    <i class="fas fa-edit"></i>
                                                    <i class="fas fa-trash"></i>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="service-subtotal">SubTotal 1.66 / CLU</div>
                            </div>
                            </div>
                        </div>

                        <div class="service-section">
                            <div class="service-section-header">
                                <div>
                                    <div class="service-section-title"><i class="fas fa-map-marker-alt"></i> Servicios de Muestreo y Mediciones de Terreno</div>
                                    <div class="service-section-desc">Servicios en terreno que no requieren agrupación.</div>
                                </div>
                                <div class="service-section-actions">
                                    <button class="btn btn-success btn-sm js-open-service-modal" data-context="field">
                                        <i class="fas fa-plus"></i> Agregar Servicio
                                    </button>
                                </div>
                            </div>

                            <div id="divDetalleServicioMuestreo">
                                <div class="table-responsive">
                                    <table class="table table-lct">
                                        <thead>
                                            <tr>
                                                <th class="text-center" style="width:40px;">#</th>
                                                <th>Servicio</th>
                                                <th style="width:90px;">Unidad</th>
                                                <th style="width:90px;">Precio</th>
                                                <th style="width:90px;">Tipo Var.</th>
                                                <th style="width:90px;">Variación</th>
                                                <th style="width:70px;">Cant</th>
                                                <th style="width:110px;">Precio Final</th>
                                                <th style="width:90px;">Total</th>
                                                <th style="width:60px;"></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td class="text-center">1</td>
                                                <td>
                                                    <div class="muestreo-name">
                                                        <span class="muestreo-name-text" data-original="Muestreo compuesto 24 hrs" title="Original: Muestreo compuesto 24 hrs">Muestreo compuesto 24 hrs</span>
                                                        <i class="fas fa-copy muestreo-duplicate" title="Duplicar"></i>
                                                        <span class="muestreo-code">10010168</span>
                                                    </div>
                                                    <div class="service-tags" style="margin-top:6px;">
                                                        <span class="service-tag">MONITOREO AGUAS (2023)</span>
                                                        <span class="service-tag">MONITOREO AGUAS RESIDUALES (2023)</span>
                                                    </div>
                                                </td>
                                                <td>UND</td>
                                                <td align="right">0.00</td>
                                                <td>
                                                    <select class="muestreo-cell-input js-muestreo-tipo" disabled>
                                                        <option value="FIJO" selected>FIJO</option>
                                                        <option value="PORCENTAJE">PORCENTAJE</option>
                                                    </select>
                                                </td>
                                                <td align="right"><input type="number" min="0" step="0.01" value="1.00" class="muestreo-cell-input js-muestreo-variacion" disabled></td>
                                                <td align="right"><input type="number" min="1" step="1" value="1.00" class="muestreo-cell-input js-muestreo-cantidad" disabled></td>
                                                <td align="right" class="js-muestreo-precio-final">0.00</td>
                                                <td align="right" class="js-muestreo-total">0.00</td>
                                                <td class="text-center">
                                                    <i class="fas fa-edit muestreo-edit-row"></i>
                                                    &nbsp;&nbsp;
                                                    <i class="fas fa-trash"></i>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="service-subtotal">SubTotal 48.00 / CLU</div>
                            </div>
                        </div>

                        <div class="service-section">
                            <div class="service-section-header">
                                <div>
                                    <div class="service-section-title"><i class="fas fa-tag"></i> Otros Servicios</div>
                                    <div class="service-section-desc">Servicios adicionales que no pertenecen a laboratorio ni a terreno.</div>
                                </div>
                                  <div class="service-section-actions">
                                      <button class="btn btn-success btn-sm js-open-service-modal" data-context="other">
                                          <i class="fas fa-plus"></i> Agregar Servicio
                                      </button>
                                  </div>
                            </div>

                              <div id="divDetalleServicioMon">
                                  <div class="table-responsive">
                                      <table class="table table-lct">
                                          <thead>
                                              <tr>
                                                  <th class="text-center" style="width:40px;">#</th>
                                                  <th>Servicio</th>
                                                  <th style="width:90px;">Unidad</th>
                                                  <th style="width:90px;">Precio</th>
                                                  <th style="width:90px;">Tipo Var.</th>
                                                  <th style="width:90px;">Variación</th>
                                                  <th style="width:70px;">Cant</th>
                                                  <th style="width:110px;">Precio Final</th>
                                                  <th style="width:90px;">Total</th>
                                                  <th style="width:60px;"></th>
                                              </tr>
                                          </thead>
                                          <tbody>
                                              <tr>
                                                  <td class="text-center">1</td>
                                                  <td>
                                                      <div class="muestreo-name">
                                                          <span class="muestreo-name-text" data-original="Auditoria Ambiental de Cumplimiento" title="Original: Auditoria Ambiental de Cumplimiento">Auditoria Ambiental de Cumplimiento</span>
                                                          <i class="fas fa-copy muestreo-duplicate" title="Duplicar"></i>
                                                          <span class="muestreo-code">104582</span>
                                                      </div>
                                                      <div class="service-tags" style="margin-top:6px;">
                                                          <span class="service-tag">CONSULTORIA AMBIENTAL (2024)</span>
                                                          <span class="service-tag">AUDITORIA AMBIENTAL</span>
                                                      </div>
                                                  </td>
                                                  <td>SERV</td>
                                                  <td align="right">0.00</td>
                                                  <td>
                                                      <select class="muestreo-cell-input js-otros-tipo" disabled>
                                                          <option value="FIJO" selected>FIJO</option>
                                                          <option value="PORCENTAJE">PORCENTAJE</option>
                                                      </select>
                                                  </td>
                                                  <td align="right"><input type="number" min="0" step="0.01" value="0.00" class="muestreo-cell-input js-otros-variacion" disabled></td>
                                                  <td align="right"><input type="number" min="1" step="1" value="1.00" class="muestreo-cell-input js-otros-cantidad" disabled></td>
                                                  <td align="right" class="js-otros-precio-final">0.00</td>
                                                  <td align="right" class="js-otros-total">0.00</td>
                                                  <td class="text-center">
                                                      <i class="fas fa-edit otros-edit-row"></i>
                                                      &nbsp;&nbsp;
                                                      <i class="fas fa-trash"></i>
                                                  </td>
                                              </tr>
                                          </tbody>
                                      </table>
                                  </div>
                                  <div class="service-subtotal">SubTotal 0.00 / CLU</div>
                              </div>
                        </div>

                        <div class="action-buttons">
                            <button type="button" class="btn btn-default" onclick="prevStep(1)">
                                <i class="fas fa-arrow-left"></i> Anterior
                            </button>
                            <button type="button" class="btn btn-success" onclick="nextStep(3)">
                                Finalizar Paso <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>

                    <div class="simple-modal-overlay" id="modalNuevoGrupo">
                        <div class="simple-modal">
                            <div class="simple-modal-header">
                                <span>Agregar Nuevo Grupo</span>
                                <button class="btn btn-default btn-sm" id="btnCerrarModalGrupo">Cerrar</button>
                            </div>
                            <div class="simple-modal-body">
                                <div class="form-group">
                                    <label>Nombre</label>
                                    <input type="text" class="form-control" id="txtNombreGrupoNuevo" placeholder="Nombre del grupo">
                                </div>
                                <div class="form-group">
                                    <label>Producto</label>
                                    <select class="form-control" id="ddlProductoGrupoNuevo">
                                        <option value="">-- Seleccione --</option>
                                        <option value="Analisis Agua (2023)">Analisis Agua (2023)</option>
                                        <option value="Analisis Aire (2023)">Analisis Aire (2023)</option>
                                        <option value="Analisis Calidad del Aire (2023)">Analisis Calidad del Aire (2023)</option>
                                        <option value="Analisis Emisiones (2023)">Analisis Emisiones (2023)</option>
                                        <option value="Analisis Higiene (2023)">Analisis Higiene (2023)</option>
                                        <option value="Analisis Solido (2023)">Analisis Solido (2023)</option>
                                        <option value="Analisis Suelos (2023)">Analisis Suelos (2023)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Presentación</label>
                                    <select class="form-control" id="ddlPresentacionGrupoNuevo">
                                        <option value="">-- Seleccione --</option>
                                        <option value="Agua de Mar (2023)">Agua de Mar (2023)</option>
                                        <option value="Agua Potable (2023)">Agua Potable (2023)</option>
                                        <option value="Agua para fines Industriales (2023)">Agua para fines Industriales (2023)</option>
                                        <option value="Aguas Residuales (2023)">Aguas Residuales (2023)</option>
                                        <option value="Agua Subterránea (2023)">Agua Subterránea (2023)</option>
                                        <option value="Agua Superficial (2023)">Agua Superficial (2023)</option>
                                        <option value="Fuentes de Captacion (2023)">Fuentes de Captacion (2023)</option>
                                        <option value="Agua Salobres (2023)">Agua Salobres (2023)</option>
                                        <option value="Agua de Diálisis (2023)">Agua de Diálisis (2023)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="simple-modal-footer">
                                <button class="btn btn-warning" id="btnGuardarGrupoNuevo">
                                    <i class="fas fa-save"></i> Guardar
                                </button>
                                <button class="btn btn-default" id="btnCancelarGrupoNuevo">Cerrar</button>
                            </div>
                        </div>
                    </div>

                    <div class="service-drawer-overlay" id="modalBuscarServicios">
                        <div class="service-drawer">
                            <div class="service-drawer-body">
                                <div class="drawer-group-summary">
                                    <div class="drawer-group-header">
                                        <div>
                                            <div class="drawer-group-title">
                                                <i class="fas fa-pen"></i>
                                                <span id="drawerGroupTitle">Grupo</span>
                                            </div>
                                            <div class="drawer-group-tags" id="drawerGroupTags"></div>
                                        </div>
                                        <div class="service-search-tabs">
                                            <button class="active" data-tab="servicios">Servicios</button>
                                            <button data-tab="normas">Normas (Paquete)</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="service-search-filters">
                                    <div class="service-search-row">
                                        <div class="service-search-field">
                                            <input type="text" class="form-control" id="txtBuscarServicioDrawer" placeholder="Buscar servicio o método">
                                        </div>
                                        <label class="etfa-toggle">
                                            <input type="checkbox" id="chkEtfaServicios">
                                            <span>ETFA</span>
                                        </label>
                                        <button class="btn btn-default btn-sm" id="btnBuscarServicioDrawer">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                        <div class="service-search-row secondary field-only">
                                            <div class="service-search-field">
                                                  <select class="form-control" id="ddlProductoServicioDrawer">
                                                      <option value="">-- Seleccione producto --</option>
                                                      <option value="Consultoria 2023">Consultoria 2023</option>
                                                      <option value="Consultoria Ambiental (2024)">Consultoria Ambiental (2024)</option>
                                                      <option value="Oceanografia (2024)">Oceanografia (2024)</option>
                                                      <option value="Capacitaciones Ambientales (2024)">Capacitaciones Ambientales (2024)</option>
                                                    <option value="Higiene Industrial (2023)">Higiene Industrial (2023)</option>
                                                    <option value="Monitoreo Aguas (2023)">Monitoreo Aguas (2023)</option>
                                                    <option value="Monitoreo Aire (2023)">Monitoreo Aire (2023)</option>
                                                    <option value="Monitoreo de Emisiones (2023)">Monitoreo de Emisiones (2023)</option>
                                                    <option value="Monitoreo Sólidos (2023)">Monitoreo Sólidos (2023)</option>
                                                    <option value="Monitoreo Suelos (2023)">Monitoreo Suelos (2023)</option>
                                                </select>
                                            </div>
                                            <div class="service-search-field">
                                                  <select class="form-control" id="ddlPresentacionServicioDrawer">
                                                      <option value="">-- Seleccione presentación --</option>
                                                      <option value="Auditoria Ambiental">Auditoria Ambiental</option>
                                                      <option value="Pertinencia Ambiental">Pertinencia Ambiental</option>
                                                      <option value="Oceanografia Fisica">Oceanografia Fisica</option>
                                                      <option value="Capacitaciones">Capacitaciones</option>
                                                      <option value="Agua de Mar (2023)">Agua de Mar (2023)</option>
                                                    <option value="Riles (2023)">Riles (2023)</option>
                                                    <option value="Varias (2023)">Varias (2023)</option>
                                                    <option value="Agua para fines Industriales (2023)">Agua para fines Industriales (2023)</option>
                                                    <option value="Fuentes de Captacion (2023)">Fuentes de Captacion (2023)</option>
                                                    <option value="Sedimentos Acuaticos (2023)">Sedimentos Acuaticos (2023)</option>
                                                    <option value="Sedimentos Lacustres (2023)">Sedimentos Lacustres (2023)</option>
                                                    <option value="Sedimentos Marinos (2023)">Sedimentos Marinos (2023)</option>
                                                    <option value="Logisticd (2023)">Logisticd (2023)</option>
                                                    <option value="Monitoreo Aguas Potables (2023)">Monitoreo Aguas Potables (2023)</option>
                                                    <option value="Monitoreo Aguas Subterraneas (2023)">Monitoreo Aguas Subterraneas (2023)</option>
                                                    <option value="Monitoreo Aguas Superficiales (2023)">Monitoreo Aguas Superficiales (2023)</option>
                                                    <option value="Monitoreo Riles (2023)">Monitoreo Riles (2023)</option>
                                                    <option value="Monitoreo Aguas Residuales (2023)">Monitoreo Aguas Residuales (2023)</option>
                                                    <option value="Monitoreo Online (2023)">Monitoreo Online (2023)</option>
                                                    <option value="Gastos Operacionales (2023)">Gastos Operacionales (2023)</option>
                                                </select>
                                            </div>
                                        </div>
                                </div>

                                <div class="service-search-pane" data-tab="servicios">
                                    <div class="service-field-table">
                                        <div class="table-responsive">
                                            <table class="table table-lct">
                                                <thead>
                                                    <tr>
                                                        <th style="width:36px;"></th>
                                                        <th style="width:90px;">#</th>
                                                        <th>Servicio</th>
                                                        <th>Producto</th>
                                                        <th>Presentación</th>
                                                        <th>Unidad</th>
                                                        <th>Moneda</th>
                                                        <th>Precio</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="fieldServiceTableBody"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="service-card-list">
                                        <div class="service-card" data-context="lab" data-servicio="Recuento Algal (Subcontrato Universidad de Antofagasta)" data-metodo="Standard Methods 22th Ed. 10200F. Fluorescencia." data-ld="0" data-unidad="UEA/ML" data-precio="0.72" data-lab="Lab. Santiago - ENV, Lab. Antofagasta - ENV" data-etfa="true" data-etfa-code="1000862">
                                            <input type="checkbox" class="service-select-checkbox">
                                            <div>
                                                <div class="service-card-title">Recuento Algal (Subcontrato Universidad de Antofagasta)</div>
                                                <span class="service-card-etfa" title="ETFA"><i class="fas fa-check-circle"></i><span class="service-card-etfa-code">1000862</span></span>
                                                <div class="service-card-meta">
                                                    <span><strong>Código:</strong> <span class="service-card-code">10002732</span></span>
                                                    <span><strong>LD:</strong> 0</span>
                                                    <span><strong>Unidad:</strong> UEA/ML</span>
                                                    <span><strong>Precio:</strong> 0.72 CLU</span>
                                                    <span class="meta-span-2"><strong>Metodología:</strong> Standard Methods 22th Ed. 10200F. Fluorescencia.</span>
                                                    <span class="meta-span-2"><strong>Laboratorios:</strong> Lab. Santiago - ENV, Lab. Antofagasta - ENV</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="service-card" data-context="lab" data-servicio="Razón Adsorción Sodio Abs. Atómica" data-metodo="NCH1333. Of 87 Punto 3.7 (Cálculo)." data-ld="0" data-unidad="NOUNIT" data-precio="0.69" data-lab="Lab. Santiago - ENV, Lab. Antofagasta - ENV" data-etfa="false">
                                            <input type="checkbox" class="service-select-checkbox">
                                            <div>
                                                <div class="service-card-title">Razón Adsorción Sodio Abs. Atómica</div>
                                                
                                                <div class="service-card-meta">
                                                    <span><strong>Código:</strong> <span class="service-card-code">10002758</span></span>
                                                    <span><strong>LD:</strong> 0</span>
                                                    <span><strong>Unidad:</strong> NOUNIT</span>
                                                    <span><strong>Precio:</strong> 0.69 CLU</span>
                                                    <span class="meta-span-2"><strong>Metodología:</strong> NCH1333. Of 87 Punto 3.7 (Cálculo).</span>
                                                    <span class="meta-span-2"><strong>Laboratorios:</strong> Lab. Santiago - ENV, Lab. Antofagasta - ENV</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="service-card" data-context="lab" data-servicio="Clorato" data-metodo="I-ENV-LAB-320 Ed00 Basado en EPA 300.1-1" data-ld="0.02" data-unidad="MG/L" data-precio="1.84" data-lab="Lab. Santiago - ENV, Lab. Antofagasta - ENV" data-etfa="true" data-etfa-code="1000869">
                                            <input type="checkbox" class="service-select-checkbox">
                                            <div>
                                                <div class="service-card-title">Clorato</div>
                                                <span class="service-card-etfa" title="ETFA"><i class="fas fa-check-circle"></i><span class="service-card-etfa-code">1000869</span></span>
                                                <div class="service-card-meta">
                                                    <span><strong>Código:</strong> <span class="service-card-code">10002721</span></span>
                                                    <span><strong>LD:</strong> 0.02</span>
                                                    <span><strong>Unidad:</strong> MG/L</span>
                                                    <span><strong>Precio:</strong> 1.84 CLU</span>
                                                    <span class="meta-span-2"><strong>Metodología:</strong> I-ENV-LAB-320 Ed00 Basado en EPA 300.1-1</span>
                                                    <span class="meta-span-2"><strong>Laboratorios:</strong> Lab. Santiago - ENV, Lab. Antofagasta - ENV</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="service-card" data-context="lab" data-servicio="Carbono Total" data-metodo="SM 5310 B Ed.24, 2023" data-ld="0.4" data-unidad="MG/L" data-precio="0.00" data-lab="Lab. Santiago - ENV, Lab. Antofagasta - ENV" data-etfa="false">
                                            <input type="checkbox" class="service-select-checkbox">
                                            <div>
                                                <div class="service-card-title">Carbono Total</div>
                                                
                                                <div class="service-card-meta">
                                                    <span><strong>Código:</strong> <span class="service-card-code">10003040</span></span>
                                                    <span><strong>LD:</strong> 0.4</span>
                                                    <span><strong>Unidad:</strong> MG/L</span>
                                                    <span><strong>Precio:</strong> 0.00 CLU</span>
                                                    <span class="meta-span-2"><strong>Metodología:</strong> SM 5310 B Ed.24, 2023</span>
                                                    <span class="meta-span-2"><strong>Laboratorios:</strong> Lab. Santiago - ENV, Lab. Antofagasta - ENV</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="service-card" data-context="lab" data-servicio="Cis-Clordano" data-metodo="I-ENV-LAB-306 ED00 Basado en EPA 8081A, 6630 B" data-ld="25" data-unidad="UG/L" data-precio="1.02" data-lab="Lab. Santiago - ENV, Lab. Antofagasta - ENV" data-etfa="true" data-etfa-code="1009340">
                                            <input type="checkbox" class="service-select-checkbox">
                                            <div>
                                                <div class="service-card-title">Cis-Clordano</div>
                                                <span class="service-card-etfa" title="ETFA"><i class="fas fa-check-circle"></i><span class="service-card-etfa-code">1009340</span></span>
                                                <div class="service-card-meta">
                                                    <span><strong>Código:</strong> <span class="service-card-code">10003077</span></span>
                                                    <span><strong>LD:</strong> 25</span>
                                                    <span><strong>Unidad:</strong> UG/L</span>
                                                    <span><strong>Precio:</strong> 1.02 CLU</span>
                                                    <span class="meta-span-2"><strong>Metodología:</strong> I-ENV-LAB-306 ED00 Basado en EPA 8081A, 6630 B</span>
                                                    <span class="meta-span-2"><strong>Laboratorios:</strong> Lab. Santiago - ENV, Lab. Antofagasta - ENV</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="service-card" data-context="lab" data-servicio="Trans-Clordano" data-metodo="I-ENV-LAB-306 ED00 Basado en EPA 8081A, 6630 B" data-ld="25" data-unidad="UG/L" data-precio="1.02" data-lab="Lab. Santiago - ENV, Lab. Antofagasta - ENV" data-etfa="false">
                                            <input type="checkbox" class="service-select-checkbox">
                                            <div>
                                                <div class="service-card-title">Trans-Clordano</div>
                                                
                                                <div class="service-card-meta">
                                                    <span><strong>Código:</strong> <span class="service-card-code">10003079</span></span>
                                                    <span><strong>LD:</strong> 25</span>
                                                    <span><strong>Unidad:</strong> UG/L</span>
                                                    <span><strong>Precio:</strong> 1.02 CLU</span>
                                                    <span class="meta-span-2"><strong>Metodología:</strong> I-ENV-LAB-306 ED00 Basado en EPA 8081A, 6630 B</span>
                                                    <span class="meta-span-2"><strong>Laboratorios:</strong> Lab. Santiago - ENV, Lab. Antofagasta - ENV</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="service-card" data-context="lab" data-servicio="Rcto. Aerobio Mesófilo" data-metodo="SM 9215 B Ed.24, 2023" data-ld="1" data-unidad="UFC/100ML" data-precio="0.40" data-lab="Lab. Santiago - ENV" data-etfa="false">
                                            <input type="checkbox" class="service-select-checkbox">
                                            <div>
                                                <div class="service-card-title">Rcto. Aerobio Mesófilo</div>
                                                
                                                <div class="service-card-meta">
                                                    <span><strong>Código:</strong> <span class="service-card-code">10003082</span></span>
                                                    <span><strong>LD:</strong> 1</span>
                                                    <span><strong>Unidad:</strong> UFC/100ML</span>
                                                    <span><strong>Precio:</strong> 0.40 CLU</span>
                                                    <span class="meta-span-2"><strong>Metodología:</strong> SM 9215 B Ed.24, 2023</span>
                                                    <span class="meta-span-2"><strong>Laboratorios:</strong> Lab. Santiago - ENV</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="service-card" data-context="lab" data-servicio="Nitrato" data-metodo="SM 4500-NO3 B Ed.24, 2023" data-ld="0.1" data-unidad="MG/L" data-precio="0.55" data-lab="Lab. Santiago - ENV, Lab. Antofagasta - ENV" data-etfa="true" data-etfa-code="1011151">
                                            <input type="checkbox" class="service-select-checkbox">
                                            <div>
                                                <div class="service-card-title">Nitrato</div>
                                                <span class="service-card-etfa" title="ETFA"><i class="fas fa-check-circle"></i><span class="service-card-etfa-code">1011151</span></span>
                                                <div class="service-card-meta">
                                                    <span><strong>Código:</strong> <span class="service-card-code">10003110</span></span>
                                                    <span><strong>LD:</strong> 0.1</span>
                                                    <span><strong>Unidad:</strong> MG/L</span>
                                                    <span><strong>Precio:</strong> 0.55 CLU</span>
                                                    <span class="meta-span-2"><strong>Metodología:</strong> SM 4500-NO3 B Ed.24, 2023</span>
                                                    <span class="meta-span-2"><strong>Laboratorios:</strong> Lab. Santiago - ENV, Lab. Antofagasta - ENV</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="service-card" data-context="lab" data-servicio="Nitrito" data-metodo="SM 4500-NO2 B Ed.24, 2023" data-ld="0.05" data-unidad="MG/L" data-precio="0.48" data-lab="Lab. Santiago - ENV" data-etfa="false">
                                            <input type="checkbox" class="service-select-checkbox">
                                            <div>
                                                <div class="service-card-title">Nitrito</div>
                                                
                                                <div class="service-card-meta">
                                                    <span><strong>Código:</strong> <span class="service-card-code">10003111</span></span>
                                                    <span><strong>LD:</strong> 0.05</span>
                                                    <span><strong>Unidad:</strong> MG/L</span>
                                                    <span><strong>Precio:</strong> 0.48 CLU</span>
                                                    <span class="meta-span-2"><strong>Metodología:</strong> SM 4500-NO2 B Ed.24, 2023</span>
                                                    <span class="meta-span-2"><strong>Laboratorios:</strong> Lab. Santiago - ENV</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="service-card" data-context="lab" data-servicio="Sulfato" data-metodo="SM 4500-SO4 E Ed.24, 2023" data-ld="1" data-unidad="MG/L" data-precio="0.62" data-lab="Lab. Santiago - ENV, Lab. Antofagasta - ENV" data-etfa="false">
                                            <input type="checkbox" class="service-select-checkbox">
                                            <div>
                                                <div class="service-card-title">Sulfato</div>
                                                
                                                <div class="service-card-meta">
                                                    <span><strong>Código:</strong> <span class="service-card-code">10003125</span></span>
                                                    <span><strong>LD:</strong> 1</span>
                                                    <span><strong>Unidad:</strong> MG/L</span>
                                                    <span><strong>Precio:</strong> 0.62 CLU</span>
                                                    <span class="meta-span-2"><strong>Metodología:</strong> SM 4500-SO4 E Ed.24, 2023</span>
                                                    <span class="meta-span-2"><strong>Laboratorios:</strong> Lab. Santiago - ENV, Lab. Antofagasta - ENV</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="service-card" data-context="field" data-product="Monitoreo Aguas (2023)" data-present="Monitoreo Aguas Residuales (2023)" data-servicio="Conductividad" data-metodo="Procedimiento SGS-AG-2023" data-ld="0" data-unidad="" data-precio="0.00" data-lab="" data-etfa="false">
                                            <input type="checkbox" class="service-select-checkbox">
                                            <div>
                                                <div class="service-card-title">Conductividad<span class="service-card-subtags"><span class="service-card-subtag">Monitoreo Aguas (2023)</span><span class="service-card-subtag">Monitoreo Aguas Residuales (2023)</span></span></div>
                                                <span class="service-card-code-pill">10010161</span>
                                                <div class="service-card-meta">
                                                    <span class="lab-only"><strong>Código:</strong> <span class="service-card-code">10010161</span></span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="service-card" data-context="field" data-product="Monitoreo Aguas (2023)" data-present="Monitoreo Aguas Residuales (2023)" data-servicio="Muestreo compuesto" data-metodo="Procedimiento SGS-AG-2023" data-ld="0" data-unidad="" data-precio="0.00" data-lab="" data-etfa="false">
                                            <input type="checkbox" class="service-select-checkbox">
                                            <div>
                                                <div class="service-card-title">Muestreo compuesto<span class="service-card-subtags"><span class="service-card-subtag">Monitoreo Aguas (2023)</span><span class="service-card-subtag">Monitoreo Aguas Residuales (2023)</span></span></div>
                                                <span class="service-card-code-pill">10010167</span>
                                                <div class="service-card-meta">
                                                    <span class="lab-only"><strong>Código:</strong> <span class="service-card-code">10010167</span></span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="service-card" data-context="field" data-product="Monitoreo Aguas (2023)" data-present="Monitoreo Aguas Residuales (2023)" data-servicio="Muestreo compuesto 24 hrs" data-metodo="Procedimiento SGS-AG-2023" data-ld="0" data-unidad="" data-precio="0.00" data-lab="" data-etfa="false">
                                            <input type="checkbox" class="service-select-checkbox">
                                            <div>
                                                <div class="service-card-title">Muestreo compuesto 24 hrs<span class="service-card-subtags"><span class="service-card-subtag">Monitoreo Aguas (2023)</span><span class="service-card-subtag">Monitoreo Aguas Residuales (2023)</span></span></div>
                                                <span class="service-card-code-pill">10010168</span>
                                                <div class="service-card-meta">
                                                    <span class="lab-only"><strong>Código:</strong> <span class="service-card-code">10010168</span></span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="service-card" data-context="field" data-product="Monitoreo Aguas (2023)" data-present="Monitoreo Aguas Residuales (2023)" data-servicio="Muestreo Puntual" data-metodo="Procedimiento SGS-AG-2023" data-ld="0" data-unidad="" data-precio="0.00" data-lab="" data-etfa="false">
                                            <input type="checkbox" class="service-select-checkbox">
                                            <div>
                                                <div class="service-card-title">Muestreo Puntual<span class="service-card-subtags"><span class="service-card-subtag">Monitoreo Aguas (2023)</span><span class="service-card-subtag">Monitoreo Aguas Residuales (2023)</span></span></div>
                                                <span class="service-card-code-pill">10010170</span>
                                                <div class="service-card-meta">
                                                    <span class="lab-only"><strong>Código:</strong> <span class="service-card-code">10010170</span></span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="service-card" data-context="field" data-product="Monitoreo Aguas (2023)" data-present="Monitoreo Aguas Residuales (2023)" data-servicio="pH" data-metodo="Procedimiento SGS-AG-2023" data-ld="0" data-unidad="" data-precio="0.00" data-lab="" data-etfa="false">
                                            <input type="checkbox" class="service-select-checkbox">
                                            <div>
                                                <div class="service-card-title">pH<span class="service-card-subtags"><span class="service-card-subtag">Monitoreo Aguas (2023)</span><span class="service-card-subtag">Monitoreo Aguas Residuales (2023)</span></span></div>
                                                <span class="service-card-code-pill">10010176</span>
                                                <div class="service-card-meta">
                                                    <span class="lab-only"><strong>Código:</strong> <span class="service-card-code">10010176</span></span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="service-card" data-context="field" data-product="Monitoreo Aguas (2023)" data-present="Monitoreo Aguas Residuales (2023)" data-servicio="TEMPERATURA" data-metodo="Procedimiento SGS-AG-2023" data-ld="0" data-unidad="Temp." data-precio="0.00" data-lab="" data-etfa="false">
                                            <input type="checkbox" class="service-select-checkbox">
                                            <div>
                                                <div class="service-card-title">TEMPERATURA<span class="service-card-subtags"><span class="service-card-subtag">Monitoreo Aguas (2023)</span><span class="service-card-subtag">Monitoreo Aguas Residuales (2023)</span></span></div>
                                                <span class="service-card-code-pill">10010180</span>
                                                <div class="service-card-meta">
                                                    <span class="lab-only"><strong>Código:</strong> <span class="service-card-code">10010180</span></span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="service-card" data-context="field" data-product="Monitoreo Aguas (2023)" data-present="Agua de Mar (2023)" data-servicio="Muestreo Puntual" data-metodo="Procedimiento SGS-AG-2023" data-ld="0" data-unidad="" data-precio="0.00" data-lab="" data-etfa="false">
                                            <input type="checkbox" class="service-select-checkbox">
                                            <div>
                                                <div class="service-card-title">Muestreo Puntual<span class="service-card-subtags"><span class="service-card-subtag">Monitoreo Aguas (2023)</span><span class="service-card-subtag">Agua de Mar (2023)</span></span></div>
                                                <span class="service-card-code-pill">10010170</span>
                                                <div class="service-card-meta">
                                                    <span class="lab-only"><strong>Código:</strong> <span class="service-card-code">10010170</span></span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="service-card" data-context="field" data-product="Monitoreo Aguas (2023)" data-present="Agua de Mar (2023)" data-servicio="Transparencia" data-metodo="Procedimiento SGS-AG-2023" data-ld="0" data-unidad="" data-precio="0.00" data-lab="" data-etfa="false">
                                            <input type="checkbox" class="service-select-checkbox">
                                            <div>
                                                <div class="service-card-title">Transparencia<span class="service-card-subtags"><span class="service-card-subtag">Monitoreo Aguas (2023)</span><span class="service-card-subtag">Agua de Mar (2023)</span></span></div>
                                                <span class="service-card-code-pill">10010689</span>
                                                <div class="service-card-meta">
                                                    <span class="lab-only"><strong>Código:</strong> <span class="service-card-code">10010689</span></span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="service-card" data-context="field" data-product="Monitoreo Aguas (2023)" data-present="Riles (2023)" data-servicio="Muestreo compuesto" data-metodo="Procedimiento SGS-AG-2023" data-ld="0" data-unidad="" data-precio="0.00" data-lab="" data-etfa="false">
                                            <input type="checkbox" class="service-select-checkbox">
                                            <div>
                                                <div class="service-card-title">Muestreo compuesto<span class="service-card-subtags"><span class="service-card-subtag">Monitoreo Aguas (2023)</span><span class="service-card-subtag">Riles (2023)</span></span></div>
                                                <span class="service-card-code-pill">10010167</span>
                                                <div class="service-card-meta">
                                                    <span class="lab-only"><strong>Código:</strong> <span class="service-card-code">10010167</span></span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="service-card" data-context="field" data-product="Monitoreo Aguas (2023)" data-present="Riles (2023)" data-servicio="Muestreo Puntual" data-metodo="Procedimiento SGS-AG-2023" data-ld="0" data-unidad="" data-precio="0.00" data-lab="" data-etfa="false">
                                            <input type="checkbox" class="service-select-checkbox">
                                            <div>
                                                <div class="service-card-title">Muestreo Puntual<span class="service-card-subtags"><span class="service-card-subtag">Monitoreo Aguas (2023)</span><span class="service-card-subtag">Riles (2023)</span></span></div>
                                                <span class="service-card-code-pill">10010170</span>
                                                <div class="service-card-meta">
                                                    <span class="lab-only"><strong>Código:</strong> <span class="service-card-code">10010170</span></span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="service-card" data-context="field" data-product="Monitoreo Aguas (2023)" data-present="Riles (2023)" data-servicio="Visita Tecnica" data-metodo="Procedimiento SGS-AG-2023" data-ld="0" data-unidad="" data-precio="0.00" data-lab="" data-etfa="false">
                                            <input type="checkbox" class="service-select-checkbox">
                                            <div>
                                                <div class="service-card-title">Visita Tecnica<span class="service-card-subtags"><span class="service-card-subtag">Monitoreo Aguas (2023)</span><span class="service-card-subtag">Riles (2023)</span></span></div>
                                                <span class="service-card-code-pill">10010182</span>
                                                <div class="service-card-meta">
                                                    <span class="lab-only"><strong>Código:</strong> <span class="service-card-code">10010182</span></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="service-card" data-context="other" data-product="Consultoria Ambiental (2024)" data-present="Auditoria Ambiental" data-servicio="Auditoria Ambiental de Cumplimiento" data-metodo="Evaluacion normativa y verificacion de compromisos" data-ld="0" data-unidad="SERV" data-precio="0.00" data-lab="" data-etfa="false">
                                            <input type="checkbox" class="service-select-checkbox">
                                            <div>
                                                <div class="service-card-title">Auditoria Ambiental de Cumplimiento<span class="service-card-subtags"><span class="service-card-subtag">Consultoria Ambiental (2024)</span><span class="service-card-subtag">Auditoria Ambiental</span></span></div>
                                                <span class="service-card-code-pill">104582</span>
                                                <div class="service-card-meta"></div>
                                            </div>
                                        </div>
                                        <div class="service-card" data-context="other" data-product="Consultoria Ambiental (2024)" data-present="Auditoria Ambiental" data-servicio="Auditoria Ambiental ISO 14001" data-metodo="Revision de sistema de gestion ambiental" data-ld="0" data-unidad="SERV" data-precio="0.00" data-lab="" data-etfa="false">
                                            <input type="checkbox" class="service-select-checkbox">
                                            <div>
                                                <div class="service-card-title">Auditoria Ambiental ISO 14001<span class="service-card-subtags"><span class="service-card-subtag">Consultoria Ambiental (2024)</span><span class="service-card-subtag">Auditoria Ambiental</span></span></div>
                                                <span class="service-card-code-pill">118739</span>
                                                <div class="service-card-meta"></div>
                                            </div>
                                        </div>
                                        <div class="service-card" data-context="other" data-product="Consultoria Ambiental (2024)" data-present="Pertinencia Ambiental" data-servicio="Elaboracion de Pertinencia Ambiental (SEA)" data-metodo="Analisis de ingreso al SEIA" data-ld="0" data-unidad="SERV" data-precio="0.00" data-lab="" data-etfa="false">
                                            <input type="checkbox" class="service-select-checkbox">
                                            <div>
                                                <div class="service-card-title">Elaboracion de Pertinencia Ambiental (SEA)<span class="service-card-subtags"><span class="service-card-subtag">Consultoria Ambiental (2024)</span><span class="service-card-subtag">Pertinencia Ambiental</span></span></div>
                                                <span class="service-card-code-pill">126405</span>
                                                <div class="service-card-meta"></div>
                                            </div>
                                        </div>
                                        <div class="service-card" data-context="other" data-product="Consultoria Ambiental (2024)" data-present="Pertinencia Ambiental" data-servicio="Informe de Pertinencia Sectorial" data-metodo="Revision de permisos sectoriales aplicables" data-ld="0" data-unidad="SERV" data-precio="0.00" data-lab="" data-etfa="false">
                                            <input type="checkbox" class="service-select-checkbox">
                                            <div>
                                                <div class="service-card-title">Informe de Pertinencia Sectorial<span class="service-card-subtags"><span class="service-card-subtag">Consultoria Ambiental (2024)</span><span class="service-card-subtag">Pertinencia Ambiental</span></span></div>
                                                <span class="service-card-code-pill">135291</span>
                                                <div class="service-card-meta"></div>
                                            </div>
                                        </div>
                                        <div class="service-card" data-context="other" data-product="Oceanografia (2024)" data-present="Oceanografia Fisica" data-servicio="Oceanografia Fisica - Campana de Corrientes" data-metodo="Mediciones en terreno y analisis de series" data-ld="0" data-unidad="SERV" data-precio="0.00" data-lab="" data-etfa="false">
                                            <input type="checkbox" class="service-select-checkbox">
                                            <div>
                                                <div class="service-card-title">Oceanografia Fisica - Campana de Corrientes<span class="service-card-subtags"><span class="service-card-subtag">Oceanografia (2024)</span><span class="service-card-subtag">Oceanografia Fisica</span></span></div>
                                                <span class="service-card-code-pill">147808</span>
                                                <div class="service-card-meta"></div>
                                            </div>
                                        </div>
                                        <div class="service-card" data-context="other" data-product="Oceanografia (2024)" data-present="Oceanografia Fisica" data-servicio="Oceanografia Fisica - Modelacion Hidrodinamica" data-metodo="Modelos numericos y calibracion" data-ld="0" data-unidad="SERV" data-precio="0.00" data-lab="" data-etfa="false">
                                            <input type="checkbox" class="service-select-checkbox">
                                            <div>
                                                <div class="service-card-title">Oceanografia Fisica - Modelacion Hidrodinamica<span class="service-card-subtags"><span class="service-card-subtag">Oceanografia (2024)</span><span class="service-card-subtag">Oceanografia Fisica</span></span></div>
                                                <span class="service-card-code-pill">152604</span>
                                                <div class="service-card-meta"></div>
                                            </div>
                                        </div>
                                        <div class="service-card" data-context="other" data-product="Capacitaciones Ambientales (2024)" data-present="Capacitaciones" data-servicio="Capacitacion Ambiental para Operaciones" data-metodo="Taller teorico-practico" data-ld="0" data-unidad="SERV" data-precio="0.00" data-lab="" data-etfa="false">
                                            <input type="checkbox" class="service-select-checkbox">
                                            <div>
                                                <div class="service-card-title">Capacitacion Ambiental para Operaciones<span class="service-card-subtags"><span class="service-card-subtag">Capacitaciones Ambientales (2024)</span><span class="service-card-subtag">Capacitaciones</span></span></div>
                                                <span class="service-card-code-pill">163977</span>
                                                <div class="service-card-meta"></div>
                                            </div>
                                        </div>
                                        <div class="service-card" data-context="other" data-product="Capacitaciones Ambientales (2024)" data-present="Capacitaciones" data-servicio="Capacitacion en Manejo de Residuos" data-metodo="Curso presencial con casos practicos" data-ld="0" data-unidad="SERV" data-precio="0.00" data-lab="" data-etfa="false">
                                            <input type="checkbox" class="service-select-checkbox">
                                            <div>
                                                <div class="service-card-title">Capacitacion en Manejo de Residuos<span class="service-card-subtags"><span class="service-card-subtag">Capacitaciones Ambientales (2024)</span><span class="service-card-subtag">Capacitaciones</span></span></div>
                                                <span class="service-card-code-pill">171340</span>
                                                <div class="service-card-meta"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="service-search-pagination">
                                        <span>Anterior</span>
                                        <span class="page-pill">1</span>
                                        <span>2</span>
                                        <span>3</span>
                                        <span>4</span>
                                        <span>5</span>
                                        <span>...</span>
                                        <span>82</span>
                                        <span>Siguiente</span>
                                    </div>
                                </div>

                                <div class="service-search-pane" data-tab="normas" style="display:none;">
                                    <div class="table-responsive">
                                        <table class="table table-lct">
                                            <thead>
                                                <tr>
                                                    <th style="width:30px;"></th>
                                                    <th style="width:90px;">#</th>
                                                    <th>Paquete</th>
                                                    <th>Unidad</th>
                                                    <th>Moneda</th>
                                                    <th>Precio Unit.</th>
                                                    <th>ETFA</th>
                                                    <th>Laboratorios</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td colspan="8" style="text-align:center;color:#9a9a9a;">Sin datos para Normas (Paquete).</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="service-drawer-footer">
                                <div class="drawer-summary">
                                    <span class="drawer-count">Seleccionados: <strong id="selectedServicesCount">0</strong></span>
                                    <span class="drawer-hint">Puedes agregar varios y seguir buscando</span>
                                </div>
                                <div class="drawer-actions">
                                    <button class="btn btn-warning" id="btnSeleccionarServicios">Agregar al grupo</button>
                                    <button class="btn btn-default" id="btnCerrarModalServicios2">Cerrar</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- PASO 3: Condiciones -->
                    <div class="step-panel" id="step3">
                        <h4 class="section-title"><i class="fas fa-cog"></i> Datos propios</h4>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Dirección de muestreo</label>
                                    <input type="text" class="form-control" id="DireccionMuestreo">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Lugar de muestreo</label>
                                    <input type="text" class="form-control" id="LugarMuestreo">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Tipo de Servicio</label>
                                    <select class="form-control" id="TipoServicio">
                                        <option value="-1">Seleccionar</option>
                                        <option value="ETFA">ETFA</option>
                                        <option value="NO ETFA">NO ETFA</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Coordinación General</label>
                                    <input type="text" class="form-control" id="CoordinacionGeneral">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Teléfono de contacto SGS</label>
                                    <input type="text" class="form-control" id="TelefonoContacto">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Días pactados OI</label>
                                    <input type="text" class="form-control" id="DiasPactados">
                                </div>
                            </div>
                        </div>

                        <h4 class="section-title"><i class="fas fa-chart-line"></i> Evaluación económica</h4>

                        <div class="row">
                            <div class="col-md-3">
                                <button class="btn btn-success">
                                    <i class="fas fa-upload"></i> Subir evaluación
                                </button>
                            </div>
                        </div>

                        <h4 class="section-title" style="margin-top: 30px;"><i class="fas fa-paperclip"></i> Documentos adjuntos</h4>

                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Documento</th>
                                    <th>Descripción</th>
                                    <th>Fecha</th>
                                    <th>Responsable</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="5" style="text-align: center; color: #9a9a9a;">No se encontraron documentos adjuntos</td>
                                </tr>
                            </tbody>
                        </table>

                        <div class="action-buttons">
                            <button type="button" class="btn btn-default" onclick="prevStep(2)">
                                <i class="fas fa-arrow-left"></i> Anterior
                            </button>
                            <button type="button" class="btn btn-success" onclick="nextStep(4)">
                                Finalizar Paso <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>

                    <!-- PASO 4: Previsualización -->
                    <div class="step-panel" id="step4">
                        <h4 class="section-title"><i class="fas fa-file-pdf"></i> Cotización</h4>

                        <div class="row" style="margin-bottom: 20px;">
                            <div class="col-md-3">
                                <button class="btn btn-warning">
                                    <i class="fas fa-sync"></i> Actualizar PDF
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-warning">
                                    <i class="fas fa-download"></i> Descargar PDF
                                </button>
                            </div>
                        </div>

                        <div style="background: #f9f9f9; border: 1px solid #e9e9e9; border-radius: 8px; height: 500px; display: flex; align-items: center; justify-content: center; color: #9a9a9a;">
                            <div style="text-align: center;">
                                <i class="fas fa-file-pdf" style="font-size: 48px; margin-bottom: 15px;"></i>
                                <p>Vista previa del PDF</p>
                            </div>
                        </div>

                        <div class="action-buttons">
                            <button type="button" class="btn btn-default" onclick="prevStep(3)">
                                <i class="fas fa-arrow-left"></i> Anterior
                            </button>
                            <button type="button" class="btn btn-success" onclick="nextStep(5)">
                                Aprobar Propuesta <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>

                    <!-- PASO 5: Aprobación -->
                    <div class="step-panel" id="step5">
                        <h4 class="section-title"><i class="fas fa-bell"></i> A - Notificación cliente</h4>

                        <div class="row">
                            <div class="col-md-4">
                                <p>Estado notificación: <span id="Estado_Notificacion">--</span></p>
                                <p>Fecha notificación: <span id="Fecha_Notificacion">--</span></p>
                                <p>Usuario notificación: <span id="Usuario_Notificacion">--</span></p>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-warning">
                                    <i class="fas fa-envelope"></i> Notificar cliente
                                </button>
                            </div>
                        </div>

                        <h4 class="section-title"><i class="fas fa-thumbs-up"></i> B - Aprobación cliente</h4>

                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Respuesta Cliente</label>
                                    <select class="form-control" id="ddlAprobacion">
                                        <option value="-1">Seleccionar</option>
                                        <option value="6">Rechazado</option>
                                        <option value="3">Aprobado</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Propuesta</label>
                                    <select class="form-control" id="ddlPropuestas">
                                        <option value="-1">Seleccionar</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Fecha aprobación</label>
                                    <input type="text" class="form-control" id="FechaAprobacion">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label>Comentario</label>
                                    <textarea class="form-control" id="Comentarios" rows="3"></textarea>
                                </div>
                            </div>
                        </div>

                        <h4 class="section-title"><i class="fas fa-user-check"></i> C - Aprobación Final (Supervisor)</h4>

                        <table class="table">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>Aprobador</th>
                                    <th>Nombre</th>
                                    <th>Fecha</th>
                                    <th>Comentario</th>
                                    <th>Aprobar</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="6" style="text-align: center; color: #9a9a9a;">Sin aprobadores asignados</td>
                                </tr>
                            </tbody>
                        </table>

                        <div class="action-buttons">
                            <button type="button" class="btn btn-default" onclick="prevStep(4)">
                                <i class="fas fa-arrow-left"></i> Anterior
                            </button>
                            <button type="button" class="btn btn-success">
                                <i class="fas fa-save"></i> Guardar Aprobación
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <footer class="footer">
                <nav>
                    <a href="https://www.sgs.com/">SGS</a>
                </nav>
                <div class="copyright">
                    &copy; 2026, made by <a href="https://www.sgs.com/">SGS TI</a>
                </div>
            </footer>
        </div>
    </div>

    <!-- Modal Buscador de Clientes -->
    <div class="modal-overlay" id="modalBuscadorClientes">
        <div class="modal-dialog">
            <div class="modal-header">
                <h5><i class="fas fa-search"></i> Buscador de clientes</h5>
                <button type="button" class="close-btn" onclick="closeClientModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Clientes</label>
                    <input type="text" class="form-control" id="txtBuscarCliente" placeholder="Ingrese nombre o código del cliente...">
                </div>
                <div class="search-results-table" id="divResultadosClientes">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 50px;">#</th>
                                <th style="width: 120px;">Código</th>
                                <th>Nombre cliente</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyResultadosClientes">
                            <tr>
                                <td colspan="3" style="text-align: center; color: #9a9a9a;">Ingrese un término de búsqueda</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-warning" id="btnProspecto">
                    <i class="fas fa-user-plus"></i> Prospecto
                </button>
                <button type="button" class="btn btn-default" onclick="closeClientModal()">
                    Cerrar
                </button>
            </div>
        </div>

        <button class="floating-summary-btn" id="btnFloatingResumen">
            <i class="fas fa-file-alt"></i> Resumen
        </button>

        <div class="summary-drawer-overlay" id="summaryDrawer">
            <div class="summary-drawer">
                <div class="summary-drawer-header">
                    <span>Resumen de la propuesta</span>
                    <button class="btn btn-default btn-sm" id="btnCerrarResumen">Cerrar</button>
                </div>
                <div class="summary-drawer-body">
                    <div class="summary-doc">
                        <h5>Servicios</h5>
                        <table class="summary-table">
                            <thead>
                                <tr>
                                    <th style="width:32px;">#</th>
                                    <th>Servicio</th>
                                    <th style="width:80px;">Precio Unit.</th>
                                    <th style="width:60px;">Cant</th>
                                    <th style="width:70px;">Desc %</th>
                                    <th style="width:80px;">Total</th>
                                </tr>
                            </thead>
                            <tbody id="summaryServicesBody">
                                <tr>
                                    <td>1</td>
                                    <td>Servicio de ejemplo</td>
                                    <td>0.00</td>
                                    <td>1</td>
                                    <td>0.00</td>
                                    <td>0.00</td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="summary-total">Total: <span id="summaryServicesTotal" style="margin-left:8px;">0.00 / CLU</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let viewingStep = 1;
        let selectedClient = null;
        let quoteSaved = false;

        // Dummy client data for demo
        const clientesDemo = [
            {
                id: 'CLI001',
                codigo: 'C-00001',
                nombre: 'Minera Los Andes S.A.',
                rut: '76.123.456-7',
                pais: 'Chile',
                direcciones: [
                    'Av. Apoquindo 4500, Las Condes, Santiago',
                    'Ruta 5 Norte Km 1350, Antofagasta',
                    'Av. Industrial 2500, Calama'
                ],
                contactos: [
                    { nombre: 'Juan Pérez González', telefono: '+56 9 8765 4321', cargo: 'Gerente de Operaciones', email: 'jperez@mineralosandes.cl' },
                    { nombre: 'María Torres Silva', telefono: '+56 9 1234 5678', cargo: 'Jefe de Medio Ambiente', email: 'mtorres@mineralosandes.cl' }
                ]
            },
            {
                id: 'CLI002',
                codigo: 'C-00002',
                nombre: 'Pesquera del Sur Ltda.',
                rut: '78.456.789-0',
                pais: 'Chile',
                direcciones: [
                    'Puerto Montt, Av. Costanera 1200',
                    'Chiloé, Sector Industrial Puerto Quellon'
                ],
                contactos: [
                    { nombre: 'Pedro Martínez', telefono: '+56 9 5555 1234', cargo: 'Director Técnico', email: 'pmartinez@pesqueradelsur.cl' }
                ]
            },
            {
                id: 'CLI003',
                codigo: 'C-00003',
                nombre: 'Celulosa Arauco SpA',
                rut: '91.234.567-8',
                pais: 'Chile',
                direcciones: [
                    'Av. El Golf 150, Las Condes, Santiago',
                    'Planta Constitución, Región del Maule',
                    'Planta Valdivia, Región de Los Ríos'
                ],
                contactos: [
                    { nombre: 'Carolina Soto', telefono: '+56 9 7777 8888', cargo: 'Gerente Ambiental', email: 'csoto@arauco.cl' },
                    { nombre: 'Roberto Fuentes', telefono: '+56 9 6666 9999', cargo: 'Coordinador de Muestreos', email: 'rfuentes@arauco.cl' },
                    { nombre: 'Ana María Reyes', telefono: '+56 9 3333 2222', cargo: 'Asistente Técnico', email: 'areyes@arauco.cl' }
                ]
            },
            {
                id: 'CLI004',
                codigo: 'C-00004',
                nombre: 'Aguas Andinas S.A.',
                rut: '61.808.000-5',
                pais: 'Chile',
                direcciones: [
                    'Av. Presidente Balmaceda 1398, Santiago',
                    'Planta La Florida, Rojas Magallanes 0355'
                ],
                contactos: [
                    { nombre: 'Felipe Contreras', telefono: '+56 9 4444 5555', cargo: 'Jefe de Laboratorio', email: 'fcontreras@aguasandinas.cl' }
                ]
            },
            {
                id: 'CLI005',
                codigo: 'C-00005',
                nombre: 'ENAP Refinerías S.A.',
                rut: '87.654.300-K',
                pais: 'Chile',
                direcciones: [
                    'Av. Borgoño 25777, Concón',
                    'Refinería Aconcagua, Concón',
                    'Refinería Bío Bío, Hualpén'
                ],
                contactos: [
                    { nombre: 'Cristina Vargas', telefono: '+56 9 2222 1111', cargo: 'Ingeniero Ambiental', email: 'cvargas@enap.cl' },
                    { nombre: 'Andrés Muñoz', telefono: '+56 9 8888 7777', cargo: 'Supervisor HSE', email: 'amunoz@enap.cl' }
                ]
            }
        ];

        function nextStep(step) {
            if (!quoteSaved && currentStep === 1 && step === 2) {
                simulateSaveQuote();
            }
            // Mark current as completed
            document.querySelector(`.stepper-item[data-step="${currentStep}"]`).classList.remove('active');
            document.querySelector(`.stepper-item[data-step="${currentStep}"]`).classList.add('completed');

            // Show next panel
            currentStep = step;
            showStepPanel(currentStep);
            viewingStep = currentStep;
            document.querySelector(`.stepper-item[data-step="${currentStep}"]`).classList.add('active');
            updateStepperViewing(viewingStep);

            // Scroll to top
            window.scrollTo(0, 0);
        }

        function prevStep(step) {
            // Remove completed from current
            document.querySelector(`.stepper-item[data-step="${currentStep}"]`).classList.remove('active');

            // Show previous panel
            currentStep = step;
            showStepPanel(currentStep);
            viewingStep = currentStep;
            document.querySelector(`.stepper-item[data-step="${step}"]`).classList.remove('completed');
            document.querySelector(`.stepper-item[data-step="${step}"]`).classList.add('active');
            updateStepperViewing(viewingStep);

            // Scroll to top
            window.scrollTo(0, 0);
        }

        function showStepPanel(step) {
            var currentPanel = document.querySelector('.step-panel.active');
            if (currentPanel) {
                currentPanel.classList.remove('active');
            }
            var targetPanel = document.getElementById('step' + step);
            if (targetPanel) {
                targetPanel.classList.add('active');
            }
        }

        function updateStepperViewing(step) {
            document.querySelectorAll('.stepper-item.viewing').forEach(function(item) {
                item.classList.remove('viewing');
            });
            var viewingItem = document.querySelector('.stepper-item[data-step="' + step + '"]');
            if (viewingItem) {
                viewingItem.classList.add('viewing');
            }
        }

        function goToStep(step) {
            if (step === viewingStep) return;
            var targetPanel = document.getElementById('step' + step);
            if (!targetPanel) return;

            showStepPanel(step);
            viewingStep = step;
            updateStepperViewing(viewingStep);

            window.scrollTo(0, 0);
        }

        function simulateSaveQuote() {
            quoteSaved = true;

            var quoteNumber = '650952';
            var proposalNumber = '1';
            updateSummaryQuoteNumber(quoteNumber, 'Registrado');
            updateSummaryProposal('N° ' + proposalNumber);

            var propuestaSelect = document.getElementById('ddlPropuestas');
            if (propuestaSelect) {
                var existing = Array.from(propuestaSelect.options).some(option => option.value === proposalNumber);
                if (!existing) {
                    var option = document.createElement('option');
                    option.value = proposalNumber;
                    option.textContent = 'Propuesta N° ' + proposalNumber;
                    propuestaSelect.appendChild(option);
                }
                propuestaSelect.value = proposalNumber;
            }
        }

        function applyPrefillFromUrl() {
            var params = new URLSearchParams(window.location.search);
            if (params.get('prefill') === '1') {
                applyDummyQuote();
            }
        }

        function applyDummyQuote() {
            // Prefill client and contact
            selectClient('CLI003');
            var direccion = document.getElementById('cbDireccion');
            if (direccion) {
                direccion.value = '0';
            }
            var atendedor = document.getElementById('AtendedorId');
            if (atendedor) {
                atendedor.value = '0';
                onContactChange();
            }

            // Prefill basic fields
            setSelectValue('DivisionId', '500');
            setSelectValue('DepartamentoId', 'COM');
            setSelectValue('LocalidadId', 'CM');
            setInputValue('InicioVigencia', '2026-01-30');
            setInputValue('FinVigencia', '2026-02-28');
            setSelectValue('MonedaId', 'CLU');
            setSelectValue('VendedorId', 'psaavedra');
            setSelectValue('CondicionPago', 'OC con pago a 30 días');
            setInputValue('Asunto', 'Monitoreo planta - renovación 2026');

            updateSummaryDate('2026-01-30');
            updateSummaryTotal(3.32, 'CLU');

            // Set quote as already saved
            quoteSaved = true;
            updateSummaryQuoteNumber('650952', 'Registrado');
            updateSummaryProposal('N° 1');

            // Jump to step 2
            nextStep(2);
        }

        function setInputValue(id, value) {
            var el = document.getElementById(id);
            if (el) {
                el.value = value;
            }
        }

        function setSelectValue(id, value) {
            var el = document.getElementById(id);
            if (el) {
                el.value = value;
                el.dispatchEvent(new Event('change'));
            }
        }

        function openNuevoGrupoModal() {
            document.getElementById('modalNuevoGrupo').style.display = 'flex';
        }

        function closeNuevoGrupoModal() {
            document.getElementById('modalNuevoGrupo').style.display = 'none';
        }

        var currentServiceGroup = null;
        var currentServiceContext = 'lab';

        function openBuscarServiciosModal(context) {
            var modal = document.getElementById('modalBuscarServicios');
            if (modal) {
                currentServiceContext = context || 'lab';
                setDrawerContext(currentServiceContext);
                document.querySelectorAll('#modalBuscarServicios .service-select-checkbox:checked').forEach(function(cb) {
                    cb.checked = false;
                });
                if (currentServiceContext === 'field' || currentServiceContext === 'other') {
                    var producto = document.getElementById('ddlProductoServicioDrawer');
                    var presentacion = document.getElementById('ddlPresentacionServicioDrawer');
                    if (producto) producto.value = '';
                    if (presentacion) presentacion.value = '';
                }
                modal.style.display = 'flex';
                updateSelectedServicesCount();
                updateDrawerGroupSummary();
                document.body.classList.add('no-scroll');
            }
        }

        function closeBuscarServiciosModal() {
            var modal = document.getElementById('modalBuscarServicios');
            if (modal) {
                modal.style.display = 'none';
                document.body.classList.remove('no-scroll');
            }
        }

        function openResumenDrawer() {
            var drawer = document.getElementById('summaryDrawer');
            if (drawer) {
                drawer.style.display = 'flex';
                document.body.classList.add('no-scroll');
            }
        }

        function closeResumenDrawer() {
            var drawer = document.getElementById('summaryDrawer');
            if (drawer) {
                drawer.style.display = 'none';
                document.body.classList.remove('no-scroll');
            }
        }

        function updateSelectedServicesCount() {
            var countEl = document.getElementById('selectedServicesCount');
            if (!countEl) return;

            var checked = Array.from(document.querySelectorAll('#modalBuscarServicios .service-select-checkbox:checked'));
            countEl.textContent = checked.length.toString();
        }

        function updateDrawerGroupSummary() {
            var titleEl = document.getElementById('drawerGroupTitle');
            var tagsEl = document.getElementById('drawerGroupTags');
            if (!titleEl || !tagsEl) return;

            if (currentServiceContext === 'field') {
                titleEl.textContent = 'Servicios de Muestreo y Mediciones de Terreno';
                updateDrawerFieldTags();
                return;
            }

            if (currentServiceContext === 'other') {
                titleEl.textContent = 'Otros Servicios Ecotecnos';
                updateDrawerFieldTags();
                return;
            }

            if (!currentServiceGroup) {
                titleEl.textContent = 'Grupo';
                tagsEl.innerHTML = '';
                return;
            }

            var name = currentServiceGroup.dataset.groupName || '';
            var index = Array.from(document.querySelectorAll('#divGruposServicioLab .service-group')).indexOf(currentServiceGroup) + 1;
            titleEl.textContent = 'Grupo ' + index + ': ' + name;

            var tags = currentServiceGroup.querySelectorAll('.service-tags .service-tag');
            tagsEl.innerHTML = '';
            if (tags.length) {
                tags.forEach(function(tag) {
                    var clone = tag.cloneNode(true);
                    tagsEl.appendChild(clone);
                });
            }
        }

        function updateDrawerFieldTags() {
            var tagsEl = document.getElementById('drawerGroupTags');
            if (!tagsEl) return;
            var producto = document.getElementById('ddlProductoServicioDrawer');
            var presentacion = document.getElementById('ddlPresentacionServicioDrawer');
            tagsEl.innerHTML = '';
            if (producto && producto.value) return;
            if (presentacion && presentacion.value) return;
        }

        function updateGroupRowsAndSubtotal(group) {
            if (!group) return;
            var tbody = group.querySelector('tbody');
            if (!tbody) return;

            var rows = Array.from(tbody.querySelectorAll('tr')).filter(function(tr) {
                return !tr.classList.contains('empty-row');
            });

            if (rows.length === 0) {
                tbody.innerHTML = '<tr class="empty-row"><td colspan="14" style="text-align:center;color:#9a9a9a;">Sin servicios en este grupo.</td></tr>';
                var subtotalEmpty = group.querySelector('.service-subtotal');
                if (subtotalEmpty) {
                    subtotalEmpty.textContent = 'SubTotal 0.00 / CLU';
                }
                return;
            }

            var emptyRow = tbody.querySelector('tr.empty-row');
            if (emptyRow) {
                emptyRow.remove();
            }

            var subtotal = 0;
            rows.forEach(function(tr, index) {
                var numCell = tr.querySelector('td');
                if (numCell) {
                    numCell.textContent = (index + 1).toString();
                }
                var totalCell = tr.querySelectorAll('td')[9];
                if (totalCell) {
                    var totalVal = parseFloat(totalCell.textContent.replace(',', '.')) || 0;
                    subtotal += totalVal;
                }
            });

            var subtotalEl = group.querySelector('.service-subtotal');
            if (subtotalEl) {
                subtotalEl.textContent = 'SubTotal ' + subtotal.toFixed(2) + ' / CLU';
            }
        }

        function updateMuestreoRowsAndSubtotal() {
            var container = document.getElementById('divDetalleServicioMuestreo');
            if (!container) return;
            var tbody = container.querySelector('tbody');
            if (!tbody) return;
            var rows = Array.from(tbody.querySelectorAll('tr'));
            rows.forEach(function(row, index) {
                var numCell = row.querySelector('td');
                if (numCell) {
                    numCell.textContent = (index + 1).toString();
                }
                var precioCell = row.querySelectorAll('td')[3];
                var variacionInput = row.querySelector('.js-muestreo-variacion');
                var cantidadInput = row.querySelector('.js-muestreo-cantidad');
                var tipoSelect = row.querySelector('.js-muestreo-tipo');
                var precioFinalCell = row.querySelector('.js-muestreo-precio-final');
                var totalCell = row.querySelector('.js-muestreo-total');
                var precio = precioCell ? parseFloat(precioCell.textContent.replace(',', '.')) || 0 : 0;
                var variacion = variacionInput ? parseFloat(variacionInput.value.replace(',', '.')) || 0 : 0;
                var cantidad = cantidadInput ? parseFloat(cantidadInput.value.replace(',', '.')) || 0 : 0;
                var tipo = tipoSelect ? tipoSelect.value : 'FIJO';
                var precioFinal = tipo === 'PORCENTAJE'
                    ? (precio + (precio * variacion / 100))
                    : (precio + variacion);
                var total = precioFinal * cantidad;
                if (precioFinalCell) {
                    precioFinalCell.textContent = precioFinal.toFixed(2);
                }
                if (totalCell) {
                    totalCell.textContent = total.toFixed(2);
                }
            });
            var subtotalEl = container.querySelector('.service-subtotal');
            if (subtotalEl) {
                var subtotal = rows.reduce(function(sum, row) {
                    var totalCell = row.querySelectorAll('td')[8];
                    var totalVal = totalCell ? parseFloat(totalCell.textContent.replace(',', '.')) || 0 : 0;
                    return sum + totalVal;
                }, 0);
                subtotalEl.textContent = 'SubTotal ' + subtotal.toFixed(2) + ' / CLU';
            }
        }

        function filterServiceCards() {
            var input = document.getElementById('txtBuscarServicioDrawer');
            var etfa = document.getElementById('chkEtfaServicios');
            var query = input ? input.value.trim().toLowerCase() : '';
            var onlyEtfa = etfa ? etfa.checked : false;
            var producto = document.getElementById('ddlProductoServicioDrawer');
            var presentacion = document.getElementById('ddlPresentacionServicioDrawer');
            var productoVal = producto ? producto.value : '';
            var presentacionVal = presentacion ? presentacion.value : '';

            var cards = Array.from(document.querySelectorAll('#modalBuscarServicios .service-card'));
            cards.forEach(function(card) {
                var matchesContext = (card.getAttribute('data-context') || 'lab') === currentServiceContext;
                var name = (card.getAttribute('data-servicio') || '').toLowerCase();
                var metodo = (card.getAttribute('data-metodo') || '').toLowerCase();
                var matchesText = !query || name.includes(query) || metodo.includes(query);
                var matchesEtfa = !onlyEtfa || card.getAttribute('data-etfa') === 'true';
                var isFieldLike = currentServiceContext === 'field' || currentServiceContext === 'other';
                var matchesProducto = !isFieldLike || !productoVal || card.getAttribute('data-product') === productoVal;
                var matchesPresentacion = !isFieldLike || !presentacionVal || card.getAttribute('data-present') === presentacionVal;
                var matches = matchesContext && matchesText && matchesEtfa && matchesProducto && matchesPresentacion;
                card.style.display = matches ? 'grid' : 'none';
            });
        }

        function addSelectedServicesToGroup() {
            if (!currentServiceGroup) return;

            var tbody = currentServiceGroup.querySelector('tbody');
            if (!tbody) return;

            // Remove empty placeholder row
            var emptyRow = tbody.querySelector('tr td[colspan]');
            if (emptyRow) {
                emptyRow.parentElement.remove();
            }

            var cards = Array.from(document.querySelectorAll('#modalBuscarServicios .service-select-checkbox:checked'))
                .map(function(cb) { return cb.closest('.service-card'); })
                .filter(Boolean);

            if (!cards.length) return;

            var currentCount = tbody.querySelectorAll('tr').length;

            cards.forEach(function(card, idx) {
                var name = card.getAttribute('data-servicio') || '';
                var metodo = card.getAttribute('data-metodo') || '';
                var ld = card.getAttribute('data-ld') || '';
                var unidad = card.getAttribute('data-unidad') || '';
                var precio = card.getAttribute('data-precio') || '0';
                var laboratorio = card.getAttribute('data-lab') || '';

                var precioNum = parseFloat(precio.replace(',', '.')) || 0;

                var tr = document.createElement('tr');
                tr.innerHTML =
                    '<td class="text-center">' + (currentCount + idx + 1) + '</td>' +
                    '<td>' + name + '</td>' +
                    '<td>' + ld + '</td>' +
                    '<td>' + metodo + '</td>' +
                    '<td>' + unidad + '</td>' +
                    '<td align="right">' + precioNum.toFixed(2) + '</td>' +
                    '<td>PORCENTAJE</td>' +
                    '<td align="right">0.00</td>' +
                    '<td align="right">1.00</td>' +
                    '<td align="right">' + precioNum.toFixed(2) + '</td>' +
                    '<td>' + laboratorio + '</td>' +
                    '<td align="right">12</td>' +
                    '<td><input type="checkbox" disabled></td>' +
                    '<td style="width:110px"><i class="fas fa-edit"></i> <i class="fas fa-trash"></i></td>';

                tbody.appendChild(tr);
            });
            updateGroupRowsAndSubtotal(currentServiceGroup);

            // reset selection
            document.querySelectorAll('#modalBuscarServicios .service-select-checkbox:checked').forEach(function(cb) {
                cb.checked = false;
            });
            updateSelectedServicesCount();
        }

        function addSelectedServicesToMuestreo() {
            var container = document.getElementById('divDetalleServicioMuestreo');
            if (!container) return;

            var selectedCards = Array.from(document.querySelectorAll('#modalBuscarServicios .service-select-checkbox:checked'))
                .map(function(cb) { return cb.closest('.service-card'); })
                .filter(function(card) { return card && card.getAttribute('data-context') === 'field'; });

            if (!selectedCards.length) return;

            var table = container.querySelector('table');
            if (!table) {
                container.innerHTML =
                    '<div class="table-responsive">' +
                        '<table class="table table-lct">' +
                            '<thead>' +
                                '<tr>' +
                                    '<th class="text-center" style="width:40px;">#</th>' +
                                    '<th>Servicio</th>' +
                                    '<th style="width:90px;">Unidad</th>' +
                                    '<th style="width:90px;">Precio</th>' +
                                    '<th style="width:90px;">Tipo Var.</th>' +
                                    '<th style="width:90px;">Variación</th>' +
                                    '<th style="width:70px;">Cant</th>' +
                                    '<th style="width:110px;">Precio Final</th>' +
                                    '<th style="width:90px;">Total</th>' +
                                    '<th style="width:60px;"></th>' +
                                '</tr>' +
                            '</thead>' +
                            '<tbody></tbody>' +
                        '</table>' +
                    '</div>' +
                    '<div class="service-subtotal">SubTotal 0.00 / CLU</div>';
                table = container.querySelector('table');
            }

            var tbody = table.querySelector('tbody');
            var currentCount = tbody.querySelectorAll('tr').length;

            selectedCards.forEach(function(card, idx) {
                var name = card.getAttribute('data-servicio') || '';
                var productoVal = card.getAttribute('data-product') || '';
                var presentacionVal = card.getAttribute('data-present') || '';
                var unidad = 'UND';
                var precio = '0.00';
                var tipoVar = 'FIJO';
                var variacion = '1.00';
                var cantidad = '1.00';
                var precioFinal = precio;
                var total = (parseFloat(precioFinal) * parseFloat(cantidad)).toFixed(2);
                var codeEl = card.querySelector('.service-card-code');
                var codigo = codeEl ? codeEl.textContent.trim() : '';

                var tr = document.createElement('tr');
                tr.innerHTML =
                    '<td class="text-center">' + (currentCount + idx + 1) + '</td>' +
                    '<td>' +
                        '<div class="muestreo-name">' +
                            '<span class="muestreo-name-text" data-original="' + name + '" title="Original: ' + name + '">' + name + '</span>' +
                              '<i class="fas fa-copy muestreo-duplicate" title="Duplicar"></i>' +
                              '<span class="muestreo-code">' + codigo + '</span>' +
                          '</div>' +
                        '<div class="service-tags" style="margin-top:6px;">' +
                            '<span class="service-tag">' + productoVal.toUpperCase() + '</span>' +
                            '<span class="service-tag">' + presentacionVal.toUpperCase() + '</span>' +
                        '</div>' +
                    '</td>' +
                    '<td>' + unidad + '</td>' +
                    '<td align="right">' + precio + '</td>' +
                    '<td><select class="muestreo-cell-input js-muestreo-tipo" disabled><option value="FIJO"' + (tipoVar === 'FIJO' ? ' selected' : '') + '>FIJO</option><option value="PORCENTAJE"' + (tipoVar === 'PORCENTAJE' ? ' selected' : '') + '>PORCENTAJE</option></select></td>' +
                    '<td align="right"><input type="number" min="0" step="0.01" value="' + variacion + '" class="muestreo-cell-input js-muestreo-variacion" disabled></td>' +
                    '<td align="right"><input type="number" min="1" step="1" value="' + cantidad + '" class="muestreo-cell-input js-muestreo-cantidad" disabled></td>' +
                    '<td align="right" class="js-muestreo-precio-final">' + precioFinal + '</td>' +
                    '<td align="right" class="js-muestreo-total">' + total + '</td>' +
                    '<td class="text-center"><i class="fas fa-edit muestreo-edit-row"></i>&nbsp;&nbsp;<i class="fas fa-trash"></i></td>';

                tbody.appendChild(tr);
            });

            var subtotalEl = container.querySelector('.service-subtotal');
            updateMuestreoRowsAndSubtotal();

            document.querySelectorAll('#modalBuscarServicios .service-select-checkbox:checked').forEach(function(cb) {
                cb.checked = false;
            });
            updateSelectedServicesCount();
        }

        function addSelectedServicesToOtros() {
            var container = document.getElementById('divDetalleServicioMon');
            if (!container) return;

            var selectedCards = Array.from(document.querySelectorAll('#modalBuscarServicios .service-select-checkbox:checked'))
                .map(function(cb) { return cb.closest('.service-card'); })
                .filter(function(card) { return card && card.getAttribute('data-context') === 'other'; });

            if (!selectedCards.length) return;

            var table = container.querySelector('table');
            if (!table) {
                container.innerHTML =
                    '<div class="table-responsive">' +
                        '<table class="table table-lct">' +
                            '<thead>' +
                                '<tr>' +
                                    '<th class="text-center" style="width:40px;">#</th>' +
                                    '<th>Servicio</th>' +
                                    '<th style="width:90px;">Unidad</th>' +
                                    '<th style="width:90px;">Precio</th>' +
                                    '<th style="width:90px;">Tipo Var.</th>' +
                                    '<th style="width:90px;">Variación</th>' +
                                    '<th style="width:70px;">Cant</th>' +
                                    '<th style="width:110px;">Precio Final</th>' +
                                    '<th style="width:90px;">Total</th>' +
                                    '<th style="width:60px;"></th>' +
                                '</tr>' +
                            '</thead>' +
                            '<tbody></tbody>' +
                        '</table>' +
                    '</div>' +
                    '<div class="service-subtotal">SubTotal 0.00 / CLU</div>';
                table = container.querySelector('table');
            }

            var tbody = table.querySelector('tbody');
            var currentCount = tbody.querySelectorAll('tr').length;

            selectedCards.forEach(function(card, idx) {
                var name = card.getAttribute('data-servicio') || '';
                var productoVal = card.getAttribute('data-product') || '';
                var presentacionVal = card.getAttribute('data-present') || '';
                var unidad = card.getAttribute('data-unidad') || 'SERV';
                var precio = card.getAttribute('data-precio') || '0.00';
                var precioNum = parseFloat(precio.replace(',', '.')) || 0;
                var tipoVar = 'FIJO';
                var variacion = '0.00';
                var cantidad = '1.00';
                var precioFinal = precioNum;
                var total = precioFinal * parseFloat(cantidad);
                var codeEl = card.querySelector('.service-card-code-pill');
                var codigo = codeEl ? codeEl.textContent.trim() : '';

                var tr = document.createElement('tr');
                tr.innerHTML =
                    '<td class="text-center">' + (currentCount + idx + 1) + '</td>' +
                    '<td>' +
                        '<div class="muestreo-name">' +
                            '<span class="muestreo-name-text" data-original="' + name + '" title="Original: ' + name + '">' + name + '</span>' +
                            '<i class="fas fa-copy muestreo-duplicate" title="Duplicar"></i>' +
                            '<span class="muestreo-code">' + codigo + '</span>' +
                        '</div>' +
                        '<div class="service-tags" style="margin-top:6px;">' +
                            '<span class="service-tag">' + (productoVal || '').toUpperCase() + '</span>' +
                            '<span class="service-tag">' + (presentacionVal || '').toUpperCase() + '</span>' +
                        '</div>' +
                    '</td>' +
                    '<td>' + unidad + '</td>' +
                    '<td align="right">' + precioNum.toFixed(2) + '</td>' +
                    '<td><select class="muestreo-cell-input js-otros-tipo" disabled><option value="FIJO"' + (tipoVar === 'FIJO' ? ' selected' : '') + '>FIJO</option><option value="PORCENTAJE"' + (tipoVar === 'PORCENTAJE' ? ' selected' : '') + '>PORCENTAJE</option></select></td>' +
                    '<td align="right"><input type="number" min="0" step="0.01" value="' + variacion + '" class="muestreo-cell-input js-otros-variacion" disabled></td>' +
                    '<td align="right"><input type="number" min="1" step="1" value="' + cantidad + '" class="muestreo-cell-input js-otros-cantidad" disabled></td>' +
                    '<td align="right" class="js-otros-precio-final">' + precioFinal.toFixed(2) + '</td>' +
                    '<td align="right" class="js-otros-total">' + total.toFixed(2) + '</td>' +
                    '<td class="text-center"><i class="fas fa-edit otros-edit-row"></i>&nbsp;&nbsp;<i class="fas fa-trash"></i></td>';

                tbody.appendChild(tr);
            });

            updateOtrosRowsAndSubtotal();

            document.querySelectorAll('#modalBuscarServicios .service-select-checkbox:checked').forEach(function(cb) {
                cb.checked = false;
            });
            updateSelectedServicesCount();
        }

        function updateOtrosRowsAndSubtotal() {
            var container = document.getElementById('divDetalleServicioMon');
            if (!container) return;
            var tbody = container.querySelector('tbody');
            if (!tbody) return;

            var rows = Array.from(tbody.querySelectorAll('tr'));
            rows.forEach(function(row, index) {
                var numCell = row.querySelector('td');
                if (numCell) {
                    numCell.textContent = (index + 1).toString();
                }
                var precioCell = row.querySelectorAll('td')[3];
                var variacionInput = row.querySelector('.js-otros-variacion');
                var cantidadInput = row.querySelector('.js-otros-cantidad');
                var tipoSelect = row.querySelector('.js-otros-tipo');
                var precioFinalCell = row.querySelector('.js-otros-precio-final');
                var totalCell = row.querySelector('.js-otros-total');
                var precio = precioCell ? parseFloat(precioCell.textContent.replace(',', '.')) || 0 : 0;
                var variacion = variacionInput ? parseFloat(variacionInput.value.replace(',', '.')) || 0 : 0;
                var cantidad = cantidadInput ? parseFloat(cantidadInput.value.replace(',', '.')) || 0 : 0;
                var tipo = tipoSelect ? tipoSelect.value : 'FIJO';
                var precioFinal = tipo === 'PORCENTAJE'
                    ? (precio + (precio * variacion / 100))
                    : (precio + variacion);
                var total = precioFinal * cantidad;
                if (precioFinalCell) {
                    precioFinalCell.textContent = precioFinal.toFixed(2);
                }
                if (totalCell) {
                    totalCell.textContent = total.toFixed(2);
                }
            });

            var subtotalEl = container.querySelector('.service-subtotal');
            if (subtotalEl) {
                var subtotal = rows.reduce(function(sum, row) {
                    var totalCell = row.querySelectorAll('td')[8];
                    var totalVal = totalCell ? parseFloat(totalCell.textContent.replace(',', '.')) || 0 : 0;
                    return sum + totalVal;
                }, 0);
                subtotalEl.textContent = 'SubTotal ' + subtotal.toFixed(2) + ' / CLU';
            }
        }

        function toggleOtrosNameEdit(row, isEditing) {
            if (!row) return;
            var nameCell = row.querySelector('.muestreo-name');
            if (!nameCell) return;
            var input = nameCell.querySelector('.muestreo-name-edit');
            var span = nameCell.querySelector('.muestreo-name-text');

            if (isEditing) {
                if (span) {
                    var current = span.textContent.trim();
                    var original = span.getAttribute('data-original') || current;
                    var nameInput = document.createElement('input');
                    nameInput.type = 'text';
                    nameInput.value = current;
                    nameInput.className = 'muestreo-name-edit';
                    nameInput.setAttribute('data-original', original);
                    span.replaceWith(nameInput);
                    nameInput.focus();
                    nameInput.select();
                }
                return;
            }

            if (input) {
                var currentText = input.value.trim();
                var originalText = input.getAttribute('data-original') || currentText;
                var spanEl = document.createElement('span');
                spanEl.className = 'muestreo-name-text';
                spanEl.setAttribute('data-original', originalText);
                spanEl.textContent = currentText || originalText;
                spanEl.title = 'Original: ' + originalText;
                input.replaceWith(spanEl);
            }
        }

        function toggleMuestreoNameEdit(row, isEditing) {
            if (!row) return;
            var nameCell = row.querySelector('.muestreo-name');
            if (!nameCell) return;
            var input = nameCell.querySelector('.muestreo-name-edit');
            var span = nameCell.querySelector('.muestreo-name-text');

            if (isEditing) {
                if (span) {
                    var current = span.textContent.trim();
                    var original = span.getAttribute('data-original') || current;
                    var nameInput = document.createElement('input');
                    nameInput.type = 'text';
                    nameInput.value = current;
                    nameInput.className = 'muestreo-name-edit';
                    nameInput.setAttribute('data-original', original);
                    span.replaceWith(nameInput);
                    nameInput.focus();
                    nameInput.select();
                }
                return;
            }

            if (input) {
                var currentText = input.value.trim();
                var originalText = input.getAttribute('data-original') || currentText;
                var spanEl = document.createElement('span');
                spanEl.className = 'muestreo-name-text';
                spanEl.setAttribute('data-original', originalText);
                spanEl.textContent = currentText || originalText;
                spanEl.title = 'Original: ' + originalText;
                input.replaceWith(spanEl);
            }
        }

        function addSelectedServices() {
            if (currentServiceContext === 'field') {
                addSelectedServicesToMuestreo();
            } else if (currentServiceContext === 'other') {
                addSelectedServicesToOtros();
            } else {
                addSelectedServicesToGroup();
            }
        }

        function setDrawerContext(context) {
            var drawer = document.querySelector('.service-drawer');
            if (!drawer) return;
            if (context === 'field' || context === 'other') {
                drawer.classList.add('drawer-field');
            } else {
                drawer.classList.remove('drawer-field');
            }
            var icon = document.querySelector('.drawer-group-title i');
            if (icon) {
                icon.className = context === 'field' ? 'fas fa-map-marker-alt' : (context === 'other' ? 'fas fa-tag' : 'fas fa-pen');
            }
            document.querySelectorAll('.service-search-tabs button').forEach(function(btn) {
                btn.classList.remove('active');
            });
            var tabServicios = document.querySelector('.service-search-tabs button[data-tab="servicios"]');
            if (tabServicios) {
                tabServicios.classList.add('active');
            }
            document.querySelectorAll('.service-search-pane').forEach(function(pane) {
                pane.style.display = 'none';
            });
            var serviciosPane = document.querySelector('.service-search-pane[data-tab="servicios"]');
            if (serviciosPane) {
                serviciosPane.style.display = 'block';
            }
            filterServiceCards();
        }

        function addGrupoServicio() {
            var nombre = document.getElementById('txtNombreGrupoNuevo').value.trim();
            var producto = document.getElementById('ddlProductoGrupoNuevo').value;
            var presentacion = document.getElementById('ddlPresentacionGrupoNuevo').value;

            var grupoIndex = document.querySelectorAll('.service-group').length + 1;
            if (!nombre) {
                nombre = 'Grupo ' + grupoIndex;
            }
            if (/^grupo\b/i.test(nombre)) {
                nombre = nombre.replace(/^grupo\b\s*:?\s*/i, '');
            }

            var safeName = nombre || 'Nuevo';
            var tagsHtml = '';
            if (producto) {
                tagsHtml += '<span class="service-tag">' + producto + '</span>';
            }
            if (presentacion) {
                tagsHtml += '<span class="service-tag">' + presentacion + '</span>';
            }

            var grupoHtml =
                '<div class="service-group" data-group-name="' + safeName.replace(/"/g, '&quot;') + '">' +
                    '<div class="service-group-header">' +
                        '<div class="group-title">' +
                            '<i class="fas fa-expand-alt text-warning"></i>' +
                            'Grupo ' + grupoIndex + ': ' + safeName +
                        '</div>' +
                        '<div class="group-actions">' +
                            '<i class="fas fa-pen"></i>' +
                            '<i class="fas fa-trash"></i>' +
                            '<button class="btn btn-success btn-sm js-open-service-modal" data-context="lab"><i class="fas fa-plus"></i> Agregar servicio</button>' +
                        '</div>' +
                    '</div>' +
                    '<div class="service-tags">' + (tagsHtml || '<span class="service-tag">Sin producto</span>') + '</div>' +
                    '<div class="table-responsive" style="padding: 10px 12px;">' +
                        '<table class="table table-lct">' +
                            '<thead>' +
                                '<tr>' +
                                    '<th>#</th><th>Servicio</th><th>LD*</th><th>Metodología</th><th>Unidad</th><th>Precio Unit.</th>' +
                                    '<th>Tipo Var.</th><th>Variación</th><th>Cant</th><th>Total</th><th>Laboratorio</th><th>Tiempo Resp.</th><th>ETFA</th><th></th>' +
                                '</tr>' +
                            '</thead>' +
                            '<tbody>' +
                                '<tr class="empty-row"><td colspan="14" style="text-align:center;color:#9a9a9a;">Sin servicios en este grupo.</td></tr>' +
                            '</tbody>' +
                        '</table>' +
                    '</div>' +
                    '<div class="service-subtotal">SubTotal 0.00 / CLU</div>' +
                '</div>';

            document.getElementById('divGruposServicioLab').insertAdjacentHTML('beforeend', grupoHtml);
            renumberGroups();
            closeNuevoGrupoModal();
        }

        function initGroupDataFromTitles() {
            document.querySelectorAll('#divGruposServicioLab .service-group').forEach(function(group) {
                if (!group.dataset.groupName) {
                    var titleEl = group.querySelector('.group-title');
                    if (titleEl) {
                        var text = titleEl.textContent.trim();
                        text = text.replace(/^Grupo\s+\d+\s*:\s*/i, '');
                        group.dataset.groupName = text || 'Grupo';
                    }
                }
            });
        }

        function renumberGroups() {
            var groups = document.querySelectorAll('#divGruposServicioLab .service-group');
            groups.forEach(function(group, idx) {
                var titleEl = group.querySelector('.group-title');
                if (titleEl) {
                    var name = group.dataset.groupName || titleEl.textContent.trim();
                    name = name.replace(/^Grupo\s+\d+\s*:\s*/i, '');
                    group.dataset.groupName = name;
                    titleEl.innerHTML = '<i class="fas fa-expand-alt text-warning"></i>Grupo ' + (idx + 1) + ': ' + name;
                }
            });
        }


        // Client search modal functions
        function openClientModal() {
            document.getElementById('modalBuscadorClientes').classList.add('active');
            document.getElementById('txtBuscarCliente').value = '';
            document.getElementById('txtBuscarCliente').focus();
            renderClientResults([]);
        }

        function closeClientModal() {
            document.getElementById('modalBuscadorClientes').classList.remove('active');
        }

        function searchClients(term) {
            if (!term || term.length < 2) {
                return [];
            }
            term = term.toLowerCase();
            return clientesDemo.filter(c =>
                c.nombre.toLowerCase().includes(term) ||
                c.codigo.toLowerCase().includes(term) ||
                c.rut.toLowerCase().includes(term)
            );
        }

        function renderClientResults(results) {
            const tbody = document.getElementById('tbodyResultadosClientes');

            if (results.length === 0) {
                const searchTerm = document.getElementById('txtBuscarCliente').value;
                if (searchTerm.length < 2) {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #9a9a9a;">Ingrese al menos 2 caracteres para buscar</td></tr>';
                } else {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #9a9a9a;">No se encontraron resultados</td></tr>';
                }
                return;
            }

            tbody.innerHTML = results.map((cliente, idx) => `
                <tr onclick="selectClient('${cliente.id}')" data-client-id="${cliente.id}">
                    <td>${idx + 1}</td>
                    <td>${cliente.codigo}</td>
                    <td>${cliente.nombre}</td>
                </tr>
            `).join('');
        }

        function selectClient(clientId) {
            const cliente = clientesDemo.find(c => c.id === clientId);
            if (!cliente) return;

            selectedClient = cliente;

            // Populate client data
            document.getElementById('ClienteId').value = cliente.codigo;
            document.getElementById('lblNombre').textContent = cliente.nombre;
            document.getElementById('lblCodigo').textContent = 'Código: ' + cliente.codigo;
            document.getElementById('lblRut').textContent = cliente.rut;
            document.getElementById('lblPais').textContent = cliente.pais;

            // Populate addresses dropdown
            const cbDireccion = document.getElementById('cbDireccion');
            cbDireccion.innerHTML = '<option value="">-- Seleccione dirección --</option>';
            cliente.direcciones.forEach((dir, idx) => {
                const option = document.createElement('option');
                option.value = idx;
                option.textContent = dir;
                cbDireccion.appendChild(option);
            });

            // Populate contacts dropdown (Atención a)
            const cbAtendedor = document.getElementById('AtendedorId');
            cbAtendedor.innerHTML = '<option value="">-- Seleccione --</option>';
            cliente.contactos.forEach((contacto, idx) => {
                const option = document.createElement('option');
                option.value = idx;
                option.textContent = contacto.nombre;
                cbAtendedor.appendChild(option);
            });

            // Hide search prompt and show client data card
            document.getElementById('divBuscarCliente').setAttribute('hidden', '');
            document.getElementById('divDatosCliente').removeAttribute('hidden');

            // Update summary header with client data
            updateSummaryClient({
                nombre: cliente.nombre,
                rut: cliente.rut,
                direccion: cliente.direcciones[0] || '-'
            });

            // Close modal
            closeClientModal();
        }

        function onContactChange() {
            if (!selectedClient) return;

            const cbAtendedor = document.getElementById('AtendedorId');
            const idx = cbAtendedor.value;

            if (idx === '' || idx === null) {
                document.getElementById('lblTelefono').textContent = '--';
                document.getElementById('lblCargo').textContent = '--';
                document.getElementById('lblEmail').textContent = '--';
                document.getElementById('contactTelefono').classList.add('empty');
                document.getElementById('contactCargo').classList.add('empty');
                document.getElementById('contactEmail').classList.add('empty');
                updateSummaryContact({});
                return;
            }

            const contacto = selectedClient.contactos[idx];
            if (contacto) {
                document.getElementById('lblTelefono').textContent = contacto.telefono;
                document.getElementById('lblCargo').textContent = contacto.cargo;
                document.getElementById('lblEmail').textContent = contacto.email;
                document.getElementById('contactTelefono').classList.remove('empty');
                document.getElementById('contactCargo').classList.remove('empty');
                document.getElementById('contactEmail').classList.remove('empty');
                updateSummaryContact(contacto);
            }
        }

        // Load company from localStorage
        document.addEventListener('DOMContentLoaded', function() {
            var savedCompany = localStorage.getItem('selectedCompany') || 'SGS';
            document.getElementById('companySelect').value = savedCompany;

            // Bind events
            document.getElementById('btnBuscarCliente').addEventListener('click', openClientModal);

            document.getElementById('txtBuscarCliente').addEventListener('input', function(e) {
                const results = searchClients(e.target.value);
                renderClientResults(results);
            });

            document.getElementById('AtendedorId').addEventListener('change', onContactChange);

            var btnResumen = document.getElementById('btnFloatingResumen');
            if (btnResumen) {
                btnResumen.addEventListener('click', openResumenDrawer);
            }
            var btnCerrarResumen = document.getElementById('btnCerrarResumen');
            if (btnCerrarResumen) {
                btnCerrarResumen.addEventListener('click', closeResumenDrawer);
            }
            var summaryDrawer = document.getElementById('summaryDrawer');
            if (summaryDrawer) {
                summaryDrawer.addEventListener('click', function(e) {
                    if (e.target === summaryDrawer) {
                        closeResumenDrawer();
                    }
                });
            }

            // Allow navigation to completed steps
            document.querySelectorAll('.stepper-item').forEach(function(item) {
                item.addEventListener('click', function() {
                    if (this.classList.contains('completed') || this.classList.contains('active')) {
                        var step = parseInt(this.getAttribute('data-step'), 10);
                        if (!isNaN(step)) {
                            goToStep(step);
                        }
                    }
                });
            });

            // Nuevo grupo modal events
            document.getElementById('btnAgregarNuevoGrupo').addEventListener('click', openNuevoGrupoModal);
            document.getElementById('btnCerrarModalGrupo').addEventListener('click', closeNuevoGrupoModal);
            document.getElementById('btnCancelarGrupoNuevo').addEventListener('click', closeNuevoGrupoModal);
            document.getElementById('btnGuardarGrupoNuevo').addEventListener('click', addGrupoServicio);

            // Buscador de servicios modal events
            var btnCerrarServicios2 = document.getElementById('btnCerrarModalServicios2');
            if (btnCerrarServicios2) {
                btnCerrarServicios2.addEventListener('click', closeBuscarServiciosModal);
            }
            var btnSeleccionarServicios = document.getElementById('btnSeleccionarServicios');
            if (btnSeleccionarServicios) {
                btnSeleccionarServicios.addEventListener('click', function() {
                    addSelectedServices();
                    closeBuscarServiciosModal();
                });
            }

            var modalBuscarServicios = document.getElementById('modalBuscarServicios');
            if (modalBuscarServicios) {
                modalBuscarServicios.addEventListener('click', function(e) {
                    if (e.target === modalBuscarServicios) {
                        closeBuscarServiciosModal();
                    }
                });
            }

            document.querySelectorAll('#modalBuscarServicios .service-select-checkbox').forEach(function(cb) {
                cb.addEventListener('change', updateSelectedServicesCount);
            });

            var txtBuscarServicioDrawer = document.getElementById('txtBuscarServicioDrawer');
            if (txtBuscarServicioDrawer) {
                txtBuscarServicioDrawer.addEventListener('input', filterServiceCards);
            }
            var btnBuscarServicioDrawer = document.getElementById('btnBuscarServicioDrawer');
            if (btnBuscarServicioDrawer) {
                btnBuscarServicioDrawer.addEventListener('click', function(e) {
                    e.preventDefault();
                    filterServiceCards();
                });
            }
            var chkEtfaServicios = document.getElementById('chkEtfaServicios');
            if (chkEtfaServicios) {
                chkEtfaServicios.addEventListener('change', filterServiceCards);
            }

            var ddlProductoServicioDrawer = document.getElementById('ddlProductoServicioDrawer');
            if (ddlProductoServicioDrawer) {
                ddlProductoServicioDrawer.addEventListener('change', function() {
                    updateDrawerFieldTags();
                    filterServiceCards();
                });
            }
            var ddlPresentacionServicioDrawer = document.getElementById('ddlPresentacionServicioDrawer');
            if (ddlPresentacionServicioDrawer) {
                ddlPresentacionServicioDrawer.addEventListener('change', function() {
                    updateDrawerFieldTags();
                    filterServiceCards();
                });
            }

            document.querySelectorAll('.service-search-tabs button').forEach(function(tabBtn) {
                tabBtn.addEventListener('click', function() {
                    document.querySelectorAll('.service-search-tabs button').forEach(function(btn) {
                        btn.classList.remove('active');
                    });
                    this.classList.add('active');

                    var target = this.getAttribute('data-tab');
                    document.querySelectorAll('.service-search-pane').forEach(function(pane) {
                        pane.style.display = 'none';
                    });
                    if (target) {
                        var pane = document.querySelector('.service-search-pane[data-tab="' + target + '"]');
                        if (pane) {
                            pane.style.display = 'block';
                        }
                    }
                });
            });

            // Group edit/delete actions (delegated)
            initGroupDataFromTitles();
            document.getElementById('divGruposServicioLab').addEventListener('click', function(e) {
                var serviceBtn = e.target.closest('.js-open-service-modal');
                if (serviceBtn) {
                    var context = serviceBtn.getAttribute('data-context') || 'lab';
                    currentServiceGroup = context === 'lab' ? serviceBtn.closest('.service-group') : null;
                    openBuscarServiciosModal(context);
                    return;
                }

                var rowAction = e.target.closest('i.fa-edit, i.fa-trash');
                if (rowAction && !rowAction.closest('.group-actions')) {
                    var row = rowAction.closest('tr');
                    var group = rowAction.closest('.service-group');
                    if (row && group) {
                        row.remove();
                        updateGroupRowsAndSubtotal(group);
                    }
                    return;
                }

                if (e.target.classList.contains('fa-pen') && e.target.closest('.group-actions')) {
                    var group = e.target.closest('.service-group');
                    if (!group) return;
                    if (group.querySelector('.group-edit-input')) return;

                    var titleEl = group.querySelector('.group-title');
                    var currentName = group.dataset.groupName || '';
                    var originalHtml = titleEl.innerHTML;

                    titleEl.innerHTML =
                        '<i class="fas fa-expand-alt text-warning"></i>' +
                        '<input class="group-edit-input" type="text" value="' + currentName.replace(/"/g, '&quot;') + '" />' +
                        '<span class="group-edit-actions">' +
                            '<i class="fas fa-check" data-action="save"></i>' +
                            '<i class="fas fa-times" data-action="cancel"></i>' +
                        '</span>';

                    var input = titleEl.querySelector('.group-edit-input');
                    input.focus();
                    input.setSelectionRange(input.value.length, input.value.length);

                    var finishEdit = function(save) {
                        if (save) {
                            var newName = input.value.trim();
                            if (newName) {
                                if (/^grupo\b/i.test(newName)) {
                                    newName = newName.replace(/^grupo\b\s*:?\s*/i, '');
                                }
                                group.dataset.groupName = newName;
                            }
                            renumberGroups();
                        } else {
                            titleEl.innerHTML = originalHtml;
                        }
                    };

                    titleEl.addEventListener('click', function(ev) {
                        var action = ev.target.getAttribute('data-action');
                        if (action === 'save') {
                            finishEdit(true);
                        }
                        if (action === 'cancel') {
                            finishEdit(false);
                        }
                    }, { once: true });

                    input.addEventListener('keydown', function(ev) {
                        if (ev.key === 'Enter') {
                            ev.preventDefault();
                            finishEdit(true);
                        }
                        if (ev.key === 'Escape') {
                            ev.preventDefault();
                            finishEdit(false);
                        }
                    });
                    input.addEventListener('blur', function() {
                        finishEdit(true);
                    });
                }

                if (e.target.classList.contains('fa-trash') && e.target.closest('.group-actions')) {
                    var groupToDelete = e.target.closest('.service-group');
                    if (!groupToDelete) return;
                    if (confirm('¿Eliminar este grupo?')) {
                        groupToDelete.remove();
                        renumberGroups();
                    }
                }
            });

            document.querySelectorAll('.js-open-service-modal').forEach(function(btn) {
                if (btn.closest('#divGruposServicioLab')) return;
                btn.addEventListener('click', function() {
                    var context = btn.getAttribute('data-context') || 'lab';
                    currentServiceGroup = context === 'lab' ? btn.closest('.service-group') : null;
                    openBuscarServiciosModal(context);
                });
            });

            var divDetalleServicioMuestreo = document.getElementById('divDetalleServicioMuestreo');
            if (divDetalleServicioMuestreo) {
                divDetalleServicioMuestreo.addEventListener('click', function(e) {
                    var editRow = e.target.closest('.muestreo-edit-row');
                    if (editRow) {
                        var row = editRow.closest('tr');
                        if (!row) return;
                    var isEditing = row.classList.toggle('is-editing');
                    row.querySelectorAll('.js-muestreo-variacion, .js-muestreo-cantidad, .js-muestreo-tipo').forEach(function(input) {
                        input.disabled = !isEditing;
                    });
                    toggleMuestreoNameEdit(row, isEditing);
                    editRow.classList.toggle('fa-save', isEditing);
                    editRow.classList.toggle('fa-edit', !isEditing);
                    if (!isEditing) {
                        updateMuestreoRowsAndSubtotal();
                    }
                    return;
                }
                var copy = e.target.closest('i.fa-copy');
                if (copy) {
                    var copyRow = copy.closest('tr');
                        if (copyRow && copyRow.parentElement) {
                            var cloned = copyRow.cloneNode(true);
                            copyRow.parentElement.insertBefore(cloned, copyRow.nextSibling);
                            updateMuestreoRowsAndSubtotal();
                        }
                        return;
                    }
                    var trash = e.target.closest('i.fa-trash');
                    if (trash) {
                        var row = trash.closest('tr');
                        if (row) {
                            row.remove();
                            updateMuestreoRowsAndSubtotal();
                        }
                    }
                });

                divDetalleServicioMuestreo.addEventListener('input', function(e) {
                    if (e.target.classList.contains('js-muestreo-variacion') || e.target.classList.contains('js-muestreo-cantidad') || e.target.classList.contains('js-muestreo-tipo')) {
                        updateMuestreoRowsAndSubtotal();
                    }
                });
            }

            var divDetalleServicioMon = document.getElementById('divDetalleServicioMon');
            if (divDetalleServicioMon) {
                divDetalleServicioMon.addEventListener('click', function(e) {
                    var editRow = e.target.closest('.otros-edit-row');
                    if (editRow) {
                        var row = editRow.closest('tr');
                        if (!row) return;
                        var isEditing = row.classList.toggle('is-editing');
                        row.querySelectorAll('.js-otros-variacion, .js-otros-cantidad, .js-otros-tipo').forEach(function(input) {
                            input.disabled = !isEditing;
                        });
                        toggleOtrosNameEdit(row, isEditing);
                        editRow.classList.toggle('fa-save', isEditing);
                        editRow.classList.toggle('fa-edit', !isEditing);
                        if (!isEditing) {
                            updateOtrosRowsAndSubtotal();
                        }
                        return;
                    }

                    var copy = e.target.closest('i.fa-copy');
                    if (copy) {
                        var copyRow = copy.closest('tr');
                        if (copyRow && copyRow.parentElement) {
                            var cloned = copyRow.cloneNode(true);
                            copyRow.parentElement.insertBefore(cloned, copyRow.nextSibling);
                            updateOtrosRowsAndSubtotal();
                        }
                        return;
                    }

                    var trash = e.target.closest('i.fa-trash');
                    if (trash) {
                        var row = trash.closest('tr');
                        if (row) {
                            row.remove();
                            updateOtrosRowsAndSubtotal();
                        }
                    }
                });

                divDetalleServicioMon.addEventListener('input', function(e) {
                    if (e.target.classList.contains('js-otros-variacion') || e.target.classList.contains('js-otros-cantidad') || e.target.classList.contains('js-otros-tipo')) {
                        updateOtrosRowsAndSubtotal();
                    }
                });
            }

            // Close modal on overlay click
            document.getElementById('modalBuscadorClientes').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeClientModal();
                }
            });

            // Close modal on Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeClientModal();
                    closeBuscarServiciosModal();
                }
            });

            // Initialize summary updates
            initializeSummaryUpdates();

            // Apply dummy prefill if requested
            applyPrefillFromUrl();
            updateStepperViewing(viewingStep);
        });

        // Toggle Quote Summary expanded/collapsed
        function toggleQuoteSummary() {
            document.getElementById('quoteSummary').classList.toggle('expanded');
        }

        // Initialize event listeners for summary updates
        function initializeSummaryUpdates() {
            // Update date from InicioVigencia
            var inicioVigencia = document.getElementById('InicioVigencia');
            if (inicioVigencia) {
                inicioVigencia.addEventListener('change', updateSummaryFromForm);
                updateSummaryDate(inicioVigencia.value);
            }

            // Update currency
            var monedaSelect = document.getElementById('MonedaId');
            if (monedaSelect) {
                monedaSelect.addEventListener('change', function() {
                    var currency = this.value || 'CLP';
                    document.getElementById('summaryCurrency').textContent = currency;
                });
            }

            // Update vendedor
            var vendedorSelect = document.getElementById('VendedorId');
            if (vendedorSelect) {
                vendedorSelect.addEventListener('change', function() {
                    var selectedText = this.options[this.selectedIndex].text;
                    document.getElementById('detailVendedor').textContent = selectedText !== '-- Seleccione --' ? selectedText : '-';
                });
            }

            // Update condiciones pago
            var condPagoSelect = document.getElementById('CondicionPago');
            if (condPagoSelect) {
                condPagoSelect.addEventListener('change', function() {
                    var selectedText = this.options[this.selectedIndex].text;
                    document.getElementById('detailCondPago').textContent = selectedText !== '-- Seleccione --' ? selectedText : '-';
                });
            }

            // Update vigencia
            var finVigencia = document.getElementById('FinVigencia');
            if (finVigencia && inicioVigencia) {
                var updateVigencia = function() {
                    var inicio = formatDateShort(inicioVigencia.value);
                    var fin = formatDateShort(finVigencia.value);
                    document.getElementById('detailVigencia').textContent = inicio + ' - ' + fin;
                };
                inicioVigencia.addEventListener('change', updateVigencia);
                finVigencia.addEventListener('change', updateVigencia);
                updateVigencia();
            }

            // Update propuesta selection
            var propuestaSelect = document.getElementById('ddlPropuestas');
            if (propuestaSelect) {
                propuestaSelect.addEventListener('change', function() {
                    var hasValue = this.value && this.value !== '-1';
                    var selectedText = this.options[this.selectedIndex].text;
                    updateSummaryProposal(hasValue ? selectedText : '');
                });
                if (propuestaSelect.value && propuestaSelect.value !== '-1') {
                    updateSummaryProposal(propuestaSelect.options[propuestaSelect.selectedIndex].text);
                }
            }

        }

        // Update summary from form data
        function updateSummaryFromForm() {
            var inicioVigencia = document.getElementById('InicioVigencia');
            if (inicioVigencia) {
                updateSummaryDate(inicioVigencia.value);
            }
        }

        // Update summary date display
        function updateSummaryDate(dateStr) {
            if (dateStr) {
                var formatted = formatDateShort(dateStr);
                document.getElementById('summaryDate').textContent = formatted;
            }
        }

        // Format date as DD/MM/YYYY
        function formatDateShort(dateStr) {
            if (!dateStr) return '-';
            var parts = dateStr.split('-');
            if (parts.length === 3) {
                return parts[2] + '/' + parts[1] + '/' + parts[0];
            }
            return dateStr;
        }

        // Update summary when client is selected
        function updateSummaryClient(clientData) {
            // Update compact summary
            var clientEl = document.getElementById('summaryClient');
            clientEl.textContent = clientData.nombre || 'No seleccionado';
            clientEl.classList.toggle('empty', !clientData.nombre);

            // Update detail section
            document.getElementById('detailClientName').textContent = clientData.nombre || '-';
            document.getElementById('detailClientRut').textContent = clientData.rut || '-';
            document.getElementById('detailClientAddress').textContent = clientData.direccion || '-';
        }

        // Update summary when contact is selected
        function updateSummaryContact(contactData) {
            // Update compact summary
            var contactEl = document.getElementById('summaryContact');
            contactEl.textContent = contactData.nombre || 'No seleccionado';
            contactEl.classList.toggle('empty', !contactData.nombre);

            // Update detail section
            document.getElementById('detailContactName').textContent = contactData.nombre || '-';
            document.getElementById('detailContactEmail').textContent = contactData.email || '-';
            document.getElementById('detailContactPhone').textContent = contactData.telefono || '-';
        }

        // Update quote number when saved
        function updateSummaryQuoteNumber(number, status) {
            var numberEl = document.getElementById('summaryQuoteNumber');
            var statusEl = document.getElementById('summaryStatus');

            if (number) {
                numberEl.textContent = '# ' + number;
                numberEl.classList.remove('empty');

                statusEl.classList.remove('draft');
                statusEl.innerHTML = '<i class="fas fa-check-circle"></i><span>' + (status || 'Registrado') + '</span>';
            }
        }

        // Update propuesta badge
        function updateSummaryProposal(propuesta) {
            var badgeEl = document.getElementById('summaryProposalBadge');
            var numberEl = document.getElementById('summaryProposalNumber');
            var hasValue = !!propuesta;

            numberEl.textContent = hasValue ? propuesta : '—';
            badgeEl.classList.toggle('empty', !hasValue);
        }

        // Update propuesta date badge

        // Update total amount
        function updateSummaryTotal(amount, currency) {
            document.getElementById('summaryTotal').textContent = formatNumber(amount || 0);
            if (currency) {
                document.getElementById('summaryCurrency').textContent = currency;
            }
        }

        // Format number with thousands separator
        function formatNumber(num) {
            return parseFloat(num).toLocaleString('es-CL', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
    </script>
</body>
</html>
